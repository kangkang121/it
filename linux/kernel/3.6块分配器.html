<!doctype html>
<html style='font-size:16px !important'>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>

<link href='https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap' rel='stylesheet' type='text/css' /><style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color: #ffffff; --text-color: #333333; --select-text-bg-color: #B5D6FC; --select-text-font-color: auto; --monospace: "Lucida Console",Consolas,"Courier",monospace; --title-bar-height: 20px; }
.mac-os-11 { --title-bar-height: 28px; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
h1, h2, h3, h4, h5 { white-space: pre-wrap; }
body { margin: 0px; padding: 0px; height: auto; inset: 0px; font-size: 1rem; line-height: 1.42857143; overflow-x: hidden; background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; tab-size: 4; background-position: inherit; background-repeat: inherit; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; word-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 36px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font-family: inherit; font-size: inherit; font-style: inherit; font-variant-caps: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
thead, tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right-width: 0px; background-color: inherit; }
.CodeMirror-linenumber { -webkit-user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; position: relative !important; background-position: inherit; background-repeat: inherit; }
.md-fences-adv-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
svg { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; background-position: 0px 0px; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li blockquote { margin: 1rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; border-color: transparent !important; padding-top: 0px !important; padding-bottom: 0px !important; }
  .typora-export * { print-color-adjust: exact; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
  #write > p:nth-child(1) { margin-top: 0px; }
  .typora-export-show-outline .typora-export-sidebar { display: none; }
  figure { overflow-x: visible; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background-color: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
.MathJax_ref { fill: currentcolor; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.reversefootnote { font-family: ui-monospace, sans-serif; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background-color: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.6; font-family: var(--monospace); }
code { text-align: left; }
a.md-print-anchor { white-space: pre !important; border: none !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; text-shadow: initial !important; background-position: 0px 0px !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom-width: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
mark { background-color: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
.md-expand mark .md-meta { opacity: 0.3 !important; }
mark .md-meta { color: rgb(0, 0, 0); }
@media print {
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}
.md-diagram-panel .messageText { stroke: none !important; }
.md-diagram-panel .start-state { fill: var(--node-fill); }
.md-diagram-panel .edgeLabel rect { opacity: 1 !important; }
.md-fences.md-fences-math { font-size: 1em; }
.md-fences-advanced:not(.md-focus) { padding: 0px; white-space: nowrap; border: 0px; }
.md-fences-advanced:not(.md-focus) { background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; background-position: inherit; background-repeat: inherit; }
.typora-export-show-outline .typora-export-content { max-width: 1440px; margin: auto; display: flex; flex-direction: row; }
.typora-export-sidebar { width: 300px; font-size: 0.8rem; margin-top: 80px; margin-right: 18px; }
.typora-export-show-outline #write { --webkit-flex: 2; flex: 2 1 0%; }
.typora-export-sidebar .outline-content { position: fixed; top: 0px; max-height: 100%; overflow: hidden auto; padding-bottom: 30px; padding-top: 60px; width: 300px; }
@media screen and (max-width: 1024px) {
  .typora-export-sidebar, .typora-export-sidebar .outline-content { width: 240px; }
}
@media screen and (max-width: 800px) {
  .typora-export-sidebar { display: none; }
}
.outline-content li, .outline-content ul { margin-left: 0px; margin-right: 0px; padding-left: 0px; padding-right: 0px; list-style: none; overflow-wrap: anywhere; }
.outline-content ul { margin-top: 0px; margin-bottom: 0px; }
.outline-content strong { font-weight: 400; }
.outline-expander { width: 1rem; height: 1.428571429rem; position: relative; display: table-cell; vertical-align: middle; cursor: pointer; padding-left: 4px; }
.outline-expander::before { content: ""; position: relative; font-family: Ionicons; display: inline-block; font-size: 8px; vertical-align: middle; }
.outline-item { padding-top: 3px; padding-bottom: 3px; cursor: pointer; }
.outline-expander:hover::before { content: ""; }
.outline-h1 > .outline-item { padding-left: 0px; }
.outline-h2 > .outline-item { padding-left: 1em; }
.outline-h3 > .outline-item { padding-left: 2em; }
.outline-h4 > .outline-item { padding-left: 3em; }
.outline-h5 > .outline-item { padding-left: 4em; }
.outline-h6 > .outline-item { padding-left: 5em; }
.outline-label { cursor: pointer; display: table-cell; vertical-align: middle; text-decoration: none; color: inherit; }
.outline-label:hover { text-decoration: underline; }
.outline-item:hover { border-color: rgb(245, 245, 245); background-color: var(--item-hover-bg-color); }
.outline-item:hover { margin-left: -28px; margin-right: -28px; border-left-width: 28px; border-left-style: solid; border-left-color: transparent; border-right-width: 28px; border-right-style: solid; border-right-color: transparent; }
.outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before { display: none; }
.outline-item-open > .outline-item > .outline-expander::before { content: ""; }
.outline-children { display: none; }
.info-panel-tab-wrapper { display: none; }
.outline-item-open > .outline-children { display: block; }
.typora-export .outline-item { padding-top: 1px; padding-bottom: 1px; }
.typora-export .outline-item:hover { margin-right: -8px; border-right-width: 8px; border-right-style: solid; border-right-color: transparent; }
.typora-export .outline-expander::before { content: "+"; font-family: inherit; top: -1px; }
.typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before { content: "−"; }
.typora-export-collapse-outline .outline-children { display: none; }
.typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children { display: block; }
.typora-export-no-collapse-outline .outline-expander::before { content: "" !important; }
.typora-export-show-outline .outline-item-active > .outline-item .outline-label { font-weight: 700; }
.md-inline-math-container mjx-container { zoom: 0.95; }
mjx-container { break-inside: avoid; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; background-position: inherit; background-repeat: inherit; }
.CodeMirror-scroll { overflow: auto hidden; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right-width: 1px; border-right-style: solid; border-right-color: rgb(221, 221, 221); background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; white-space: nowrap; background-position: inherit; background-repeat: inherit; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; background-position: inherit; background-repeat: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; background-position: inherit; background-repeat: inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; outline: 0px; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: auto hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 10px; z-index: 3; overflow-y: hidden; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; border: none !important; background-position: 0px 0px !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-radius: 0px; border-width: 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; word-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; background-position: 0px 0px; }
.CodeMirror-wrap pre { word-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right-width: 30px; border-right-style: solid; border-right-color: transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right-style: none; width: auto; }
.CodeMirror-linebackground { position: absolute; inset: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right-style: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background-color: rgba(255, 255, 0, 0.4); }
span.cm-underlined { text-decoration: underline; }
span.cm-strikethrough { text-decoration: line-through; }
.cm-tw-syntaxerror { color: rgb(255, 255, 255); background-color: rgb(153, 0, 0); }
.cm-tw-deleted { text-decoration: line-through; }
.cm-tw-header5 { font-weight: 700; }
.cm-tw-listitem:first-child { padding-left: 10px; }
.cm-tw-box { border-style: solid; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-color: inherit; border-top-width: 0px !important; }
.cm-tw-underline { text-decoration: underline; }
@media print {
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


/*快速自定义配置*/
:root {
    --monospace: "JetBrains Mono", "Fira Code", "Cascadia Code", Menlo, "Ubuntu Mono", Consolas, HYZhengYuan; /*代码字体*/
    --text-font: var(--monospace); /*正文字体*/
    --title-font: var(--monospace); /*标题字体*/
    --latex-font: var(--monospace); /*LaTeX字体(不含英语)*/
    --text-line-height: 1.6; /*正文行间距*/
    --code-line-height: 1.6; /*代码块行间距*/
    --p-spacing: 0.8rem; /*段间距*/
    --text-size: 12px;
}/*
 * MIT License
 *
 * Copyright (c) 2023 劉強東 https://github.com/liangjingkanji
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
@import url();
@include-when-export url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap');

:root {
    --text-color: #202124;
    --blur-text-color: #c8c8c8;
    --bg-color: #ffffff;
    --control-text-color: var(--text-color);
    --meta-content-color: var(--text-color);
    --active-file-border-color: var(--drake-accent);
    --rawblock-edit-panel-bd: var(--code-block-bg-color);
    --item-hover-bg-color: #E5E5E596;
    --active-file-bg-color: var(--item-hover-bg-color);

    --blur-text-color: rgba(32, 33, 36, 0.5);
    --drake-accent: #5784ec;
    --drake-highlight: #3a474e;
    --a-color: #1769e0;
    --variable-color: #d01884;
    --outline-active-color: var(#414040);
    --code-block-bg-color: #f8f9fa;
    --code-block-color: #3a474e;
    --title-color: #202124;
    --blockquote-border-color: #275796;
    --blockquote-color: #275796;
    --blockquote-bg-color: #e5f4fd;
    --strong-color: var(--title-color);
    --h2-underline-color: var(--title-color);
    --horizontal-divider-color: var(--title-color);
    --height-light-color: var(--text-color);
    --height-light-border-color: var(--text-color);
    --yaml-color: #777777;
    --yaml-bg-color: #f7f7f7;
    --footnotes-bg-color: #3c3d3e;
    --footnotes-highlight: #FFD760;
    --table-border-color: #dadce0;
    --table-header-bg-color: #f1f3f4;
    --table-bg-color: var(--bg-color);
    --table-n2-bg-color: var(--bg-color);
    --input-bg-color: var(--item-hover-bg-color);
    --btn-hover-bg-color: var(--item-hover-bg-color);
    --checkbox-checked: url("data:image/svg+xml,%3Csvg class='icon' viewBox='0 0 1024 1024' xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cpath d='M425.984 726.016l384-384-59.99-61.995-324.01 324.011-152.021-152.021L213.973 512zm384-598.016q36.01 0 61.013 25.984T896 213.974v596.01q0 34.005-25.003 59.99t-61.013 25.983h-596.01q-36.011 0-61.014-25.984t-25.003-59.989v-596.01q0-34.006 25.003-59.99T213.973 128h596.011z' fill='%2365b73b'/%3E%3C/svg%3E");
    --checkbox-unchecked: url("data:image/svg+xml,%3Csvg class='icon' viewBox='0 0 1024 1024' xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cpath d='M810.667 213.333v597.334H213.333V213.333h597.334m0-85.333H213.333C166.4 128 128 166.4 128 213.333v597.334C128 857.6 166.4 896 213.333 896h597.334C857.6 896 896 857.6 896 810.667V213.333C896 166.4 857.6 128 810.667 128z' fill='%23333333'/%3E%3C/svg%3E");
}

html {
    font-size: var(--text-size);
}

body {
    font-family: var(--text-font) !important;
    color: var(--text-color);
    -webkit-font-feature-settings: "liga" on, "calt" on;
    -webkit-font-smoothing: subpixel-antialiased;
    text-rendering: optimizeLegibility;
    letter-spacing: 0;
    margin: 0;
    overflow-x: hidden;
}

p {
    line-height: var(--text-line-height);
}

/*code block*/
.md-fences {
    font-size: 1rem;
    padding: 12px !important;
    border-radius: 8px;
    word-wrap: normal;
    background-color: var(--code-block-bg-color);
    color: var(--code-block-color);
    border: .1em solid #e8eaed;
    line-height: var(--code-line-height);
}

/*inline latex*/
.MathJax {
    font-size: 120% !important;
}
.MathJax text, .MathJax use {
    font-family: var(--latex-font);
}
/*math-block latex*/
.md-math-block .MathJax {
    font-size: 130% !important;
}

/*mermaid*/
[id^=mermaidChart] .cluster rect {
    fill: var(--table-n2-bg-color) !important;
    stroke: var(--table-border-color) !important;
}
[id^=mermaidChart] .clusters span.nodeLabel {
    color: var(--text-color) !important;
    line-height: 1.8rem;
}
[mermaid-type="journey"] line {
    stroke: #7a7a7a !important;
}
[mermaid-type="journey"] .label {
    color: #333 !important;
}
[id^=mermaidChart] .relationshipLabelBox {
    fill: var(--bg-color) !important;
    opacity: 1 !important;
    background-color: var(--bg-color) !important;
}
[id^=mermaidChart] .legend {
    fill: var(--text-color) !important;
}
[id^=mermaidChart] g.label {
    font-size: 1rem !important;
}
[id^=mermaidChart] line.divider {
    stroke: var(--table-border-color) !important;
}
[id^=mermaidChart] span.nodeLabel {
    color: var(--code-block-color) !important;
    line-height: 1.8rem;
}
tspan {
    color: var(--text-color)
}
[id^=mermaidChart] .entityLabel {
    fill: var(--code-block-color) !important;
}
[id^=mermaidChart] {
    fill: var(--text-color) !important;
}
[id^=mermaidChart] rect.rect {
    fill: rgba(175, 255, 212, 0.3) !important;
}
.md-diagram-panel-preview text.actor > tspan { /*方块文字*/
    fill: var(--code-block-color) !important;
    stroke: none !important;
    font-family: var(--text-font) !important;
    font-size: 1rem !important;
}
.md-diagram-panel-preview .actor, .md-diagram-panel-preview .entityBox { /*方块*/
    stroke: var(--table-border-color) !important;
    fill: var(--code-block-bg-color) !important;
}
.md-diagram-panel-preview .actor-line { /*竖线*/
    stroke: var(--text-color) !important;
    stroke-width: 1px;
}
.md-diagram-panel-preview .messageLine0 { /*横线*/
    stroke-width: 1.5;
    stroke-dasharray: none;
    stroke: var(--text-color) !important;
}
.md-diagram-panel-preview .messageLine1 { /*虚线*/
    stroke-width: 1.5 !important;
    stroke-dasharray: 2, 2 !important;
    stroke: var(--text-color) !important;
}
.md-diagram-panel-preview .messageText { /*描述文字*/
    fill: var(--text-color) !important;
    font-family: var(--text-font) !important;
    font-size: 1rem !important;
}
.md-diagram-panel-preview .activation0 { /*长方形*/
    fill: #e6e6e6 !important;
    stroke: var(--text-color) !important;
}
.md-diagram-panel-preview .labelText, .md-diagram-panel-preview .labelText > tspan { /*循环标记*/
    fill: var(--code-block-color) !important;
    font-family: var(--text-font) !important;
    font-size: 1rem !important;
    dominant-baseline: unset;
    alignment-baseline: unset;
}
.md-diagram-panel-preview .labelBox { /*循环标记背景*/
    stroke: var(--table-border-color) !important;
    fill: var(--code-block-bg-color) !important;
}
.md-diagram-panel-preview .loopLine { /*循环标记虚线*/
    stroke: var(--text-color) !important;
}
.md-diagram-panel-preview .loopText, .md-diagram-panel-preview .loopText > tspan { /*循环名称*/
    fill: var(--text-color) !important;
    font-size: 1rem !important;
}
.md-diagram-panel-preview .sequenceNumber { /*序号*/
    fill: var(--bg-color) !important;
}
pre.md-fences-advanced.md-focus .md-fences-adv-panel {
    border: none;
}
.md-diagram-panel-preview .edgePath .path { /*箭头*/
    stroke: var(--text-color) !important;
}
.md-diagram-panel-preview .edgeLabel rect { /*条件文字背景*/
    fill: var(--bg-color) !important;
}
.md-diagram-panel-preview .edgeLabel span { /*条件文字*/
    color: var(--text-color) !important;
    background: var(--bg-color) !important;
}
.md-diagram-panel-preview .node rect,
.md-diagram-panel-preview .node circle,
.md-diagram-panel-preview .node ellipse,
.md-diagram-panel-preview .node polygon,
.md-diagram-panel-preview .node path { /*形状*/
    stroke: var(--table-border-color) !important;
    fill: var(--code-block-bg-color) !important;
}
#write .md-diagram-panel .md-diagram-panel-preview div { /*形状内文字*/
    color: var(--code-block-color);
    font-family: var(--text-font) !important;
    font-size: 1rem !important;
}

/*code snippet*/
#write code, tt {
    margin: 0 4px;
    color: var(--drake-highlight);
    border: .1rem solid #e8eaed;
    background: #f8f9fa;
    border-radius: 4px;
    padding: .1rem .4rem;
}

/*variable*/
var {
    color: var(--variable-color);
    font-weight: bold;
}

/*raw block*/
.md-rawblock-control:not(.md-rawblock-tooltip) {
    border-radius: 2px 0 2px 2px;
    padding: 0.2rem !important;
}
.md-rawblock:hover > .md-rawblock-container {
    background: none;
}
.md-rawblock-input {
    font-size: 1rem;
}
.md-rawblock-tooltip-btn:hover {
    background: none;
}
.md-rawblock:hover > .md-rawblock-tooltip {
    border-radius: 2px 2px 0 0;
    margin-bottom: 2px !important;
}
.md-rawblock-tooltip.md-rawblock-control {
    border-radius: 2px 2px 0 0;
    color: var(--code-block-color);
}
.md-rawblock-tooltip-name {
    color: var(--code-block-color);
    opacity: 1;
}

/*quote block*/
blockquote {
    color: var(--blockquote-color) !important;
    border-radius: 4px;
    padding: 10px 16px;
    background-color: var(--blockquote-bg-color);
    position: relative;
    border-left: none;
}

#write strong {
    color: var(--strong-color);
    font-weight: bold;
}
#write blockquote strong {
    color: var(--blockquote-color);
}

/*link*/
.on-focus-mode #write a .md-plain:hover, .on-focus-mode .md-htmlblock-container a:hover {
    border-bottom: .1rem solid var(--blur-text-color);
}
#write a .md-plain:hover, .md-htmlblock-container a:hover,
.on-focus-mode #write .md-focus a .md-plain:hover, .on-focus-mode .md-focus .md-htmlblock-container a:hover {
    border-bottom: .1rem solid var(--a-color);
}
#write a {
    color: var(--a-color);
    text-decoration: none;
}
#write h2 a .md-plain {
    border-bottom: .2rem solid var(--a-color);
}
[md-inline=link] a {
    margin: 0 .2rem;
}
#write a code, a:any-link {
    color: var(--a-color);
}
#write a code:hover {
    text-decoration: underline;
    text-underline-offset: 2px;
    text-decoration-thickness: 0.1em;
}

img {
    border-left: none;
    border-right: none;
    vertical-align: baseline;
    border-radius: 2px;
}

#write {
    max-width: 1100px;
    margin: 0 auto;
    padding: 20px 30px 100px;
}
#typora-source .CodeMirror-lines {
    max-width: 1200px;
}

#write > ul:first-child,
#write > ol:first-child {
    margin-top: 30px;
}

body > *:first-child {
    margin-top: 0 !important;
}

body > *:last-child {
    margin-bottom: 0 !important;
}

h1,
h2,
h3,
h4,
h5,
h6 {
    font-family: var(--title-font);
    position: relative;
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-weight: bold;
    line-height: 1.4;
    cursor: text;
    color: var(--title-color);
}

h3.md-focus:before, h4.md-focus:before, h5.md-focus:before, h6.md-focus:before {
    visibility: hidden;
}

h1 {
    font-size: 2rem;
    text-align: center;
    margin-top: 0;
}

h2 {
    font-size: 1.8rem;
    margin-bottom: 1.5rem;
}

.on-focus-mode h2.md-end-block.md-heading:not(.md-focus):not(.md-focus-container):after {
    background-color: var(--blur-text-color) !important;
}

h3 {
    font-size: 1.4rem;
}

h4 {
    font-size: 1.2rem;
}

h5 {
    font-size: 1rem;
}

h6 {
    font-size: 1rem;
}

h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}

h1 tt,
h1 code {
    font-size: inherit !important;
}

h2 tt,
h2 code {
    font-size: inherit !important;
}

h3 tt,
h3 code {
    font-size: inherit !important;
}

h4 tt,
h4 code {
    font-size: inherit !important;
}

h5 tt,
h5 code {
    font-size: inherit !important;
}

h6 tt,
h6 code {
    font-size: inherit !important;
}

p, blockquote, ul, ol, dl, table {
    margin: var(--p-spacing) 0;
}

li > ol,
li > ul {
    margin: 0 0;
}
li {
    margin: 0.5em 0;
}

hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: var(--horizontal-divider-color);
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

body > h2:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0;
}

body > h3:first-child,
body > h4:first-child,
body > h5:first-child,
body > h6:first-child {
    margin-top: 0;
    padding-top: 0;
}

a:first-child h1,
a:first-child h2,
a:first-child h3,
a:first-child h4,
a:first-child h5,
a:first-child h6 {
    margin-top: 0;
    padding-top: 0;
}

h1 p,
h2 p,
h3 p,
h4 p,
h5 p,
h6 p {
    margin-top: 0;
}

li p.first {
    display: inline-block;
}

ul, ol {
    padding-inline-start: 2em;
}

ul:first-child,
ol:first-child {
    margin-top: 0;
}

ul:last-child,
ol:last-child {
    margin-bottom: 0;
}

.ty-table-edit {
    margin-top: -1rem !important;
}
#write table {
    margin-top: 1rem;
    word-break: initial;
    background-color: var(--table-bg-color);
}
table tr {
    border-top: .1em solid var(--table-border-color);
    margin: 0;
    padding: 0;
}
table th {
    font-weight: bold;
    border: .1em solid var(--table-border-color);
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}
table td {
    border: .1em solid var(--table-border-color);
    margin: 0;
    padding: 6px 13px;
}
table thead {
    background-color: var(--table-header-bg-color);
}
table tr:nth-child(2n) {
    background-color: var(--table-n2-bg-color);
}
table tr th:first-child,
table tr td:first-child {
    margin-top: 0;
}
table tr th:last-child,
table tr td:last-child {
    margin-bottom: 0;
}

#write em {
    padding: 0 5px 0 2px;
}

#write table thead th {
    background-color: var(--table-header-bg-color);
}

/* height light */
#write mark {
    border: .1em solid var(--height-light-border-color);
    color: var(--height-light-color);
    background-color: transparent;
    padding: .1rem .5rem;
    border-radius: 2rem;
    margin: 0 .2rem;
    font-size: .95rem;
}

/*shortcut*/
kbd {
    border: .1em solid #5b5b5e;
    background: transparent;
    color: var(--text-color);
    margin: 0 .4rem;
    font-family: var(--text-font) !important;
    font-size: .95rem;
    padding: .3em .4em;
    border-radius: .4em;
    box-shadow: .1em .1em .2em rgba(0, 0, 0, 0.3);
}

#write del {
    padding: 1px 2px;
}

.md-task-list-item > input {
    margin-left: -1.3em;
}

@media print {
    html {
        font-size: 12px;
    }

    table,
    pre {
        page-break-inside: avoid;
    }

    pre {
        word-wrap: break-word;
    }
}

/*YAML*/
#write pre.md-meta-block {
    padding: 1rem;
    font-size: 1rem;
    line-height: 1.45;
    background-color: var(--yaml-bg-color);
    border: 0;
    border-radius: 2px;
    color: var(--yaml-color);
    margin-top: 0 !important;
}

.mathjax-block > .code-tooltip {
    bottom: .375rem;
}

#write > h3.md-focus:before {
    left: -1.5625rem;
    top: .375rem;
}

#write > h4.md-focus:before {
    left: -1.5625rem;
    top: .285714286rem;
}

#write > h5.md-focus:before {
    left: -1.5625rem;
    top: .285714286rem;
}

#write > h6.md-focus:before {
    left: -1.5625rem;
    top: .285714286rem;
}

.md-image > .md-meta {
    border-radius: 2px;
    font-family: initial;
    padding: 2px 0 0 4px;
    color: inherit;
}

.md-tag {
    color: inherit;
}

.md-toc {
    margin-top: 20px;
    padding-bottom: 20px;
}

.typora-quick-open-item {
    font-size: 1rem !important;
    height: 50px;
    padding-left: 8px;
    padding-top: 4px;
    padding-bottom: 4px;
}

#typora-quick-open {
    box-shadow: 0 0 8px #00000045;
    padding: 0;
}

.ty-quick-open-category.ty-has-prev .ty-quick-open-category-title {
    border-top: none;
}

#typora-quick-open-input {
    margin: 8px;
    box-shadow: none;
    border-radius: 2px;
}

#typora-quick-open-input input {
    font-size: 1rem;
    box-shadow: none;
    padding-top: 2px;
    padding-left: 10px;
    padding-right: 10px;
    line-height: 32px;
    max-height: 32px;
    border: none;
}

.modal-dialog#typora-quick-open {
    border-radius: 8px;
}

.ty-quick-open-category-title {
    padding-left: 8px;
    color: #BEBEBE;
    font-size: 0.8rem;
    margin-bottom: 4px;
}

.typora-quick-open-item-path {
    font-size: 0.8rem;
    text-overflow: ellipsis;
    white-space: nowrap;
    margin-top: 1px;
}

/*search input*/
.form-control {
    border: none;
    border-radius: 2px;
    box-shadow: none;
}

#md-searchpanel .btn {
    border-radius: 2px;
}

#search-panel-replaceall-btn {
    padding-right: 5px !important;
    text-align: center !important;
}

#search-panel-replace-btn {
    text-align: center !important;
}

#md-searchpanel input {
    background: var(--input-bg-color);
    border-radius: 2px;
}

.searchpanel-search-option-btn {
    border-radius: 2px;
    border: none;
    background: transparent;
    color: var(--text-color);
}

.searchpanel-search-option-btn.active {
    background: var(--text-color);
    color: var(--bg-color);
}

.form-control:focus {
    box-shadow: none;
}

#md-notification:before {
    top: 10px;
}

/** focus mode */
.on-focus-mode blockquote {
    border-left-color: rgba(85, 85, 85, 0.12);
}

header,
.context-menu,
.megamenu-content,
footer {
    font-family: initial;
}

/*sidebar*/
.file-library-node.file-tree-node.file-node-root {
    font-size: 1.1rem;
}
.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state {
    visibility: visible;
}
.file-node-content {
    display: flex;
    align-items: center;
}
.file-node-open-state {
    margin-right: .5rem;
}
.file-node-icon {
    margin-right: .5rem;
}

#typora-sidebar {
    font-size: inherit;
    font-family: var(--title-font);
}

.sidebar-tabs {
    border-bottom: none;
}

.file-list-item-summary, .file-list-item-parent-loc, .file-list-item-time, .file-list-item-summary {
    font-size: 0.9rem !important;
    font-family: var(--text-font);
}

.file-list-item-file-ext-part {
    display: none;
}

.outline-item {
    font-size: 14px;
}

/*footnotes mark*/
#write .md-footnote {
    background-color: inherit;
    color: var(--drake-highlight);
    font-size: 0.9rem;
    border-radius: 0.9rem;
    padding-left: 0;
}

#write .md-footnote:before {
    content: "[";
}

#write .md-footnote:after {
    content: "]";
}

/*footnotes content*/
.md-hover-tip .code-tooltip-content {
    border-radius: 2px;
}

/*footnotes title*/
span.md-def-name {
    padding-right: 3ch;
    padding-left: 0;
    position: relative;
    font-weight: normal;
}

/*footnotes desc*/
.footnotes {
    font-size: 1rem;
    font-weight: normal;
    color: var(--text-color);
    position: relative;
}

/*footnotes tooltip text*/
.code-tooltip-content .md-plain {
    font-size: 0.9rem;
    font-family: inherit;
}

.code-tooltip-content code {
    padding: 0 2px;
    font-family: inherit;
    color: var(--footnotes-highlight);
    background-color: inherit;
}

.code-tooltip-content a {
    color: var(--footnotes-highlight);
}

div.code-tooltip-content {
    box-shadow: 0 0 8px #00000045;
    background: var(--footnotes-bg-color);
}

.footnotes {
    opacity: 1;
}

.md-def-name:after {
    content: ". ^";
    color: var(--text-color);
}

.md-def-footnote .md-def-name:before {
    content: "";
    color: var(--text-color);
    position: absolute;
}

.md-def-name:before {
    content: "";
    color: var(--text-color);
    position: absolute;
}

.md-content.md-url, .md-def-content.md-def-url.md-auto-disp {
    text-decoration: none;
    border-bottom: .1rem solid var(--text-color);
}

.CodeMirror-scroll::-webkit-scrollbar {
    display: none;
}

.file-list-item-summary {
    font-size: 1em;
}

.pin-outline #outline-content .outline-active strong, .pin-outline .outline-active {
    font-weight: 400;
    color: var(--outline-active-color);
}

.file-list-item.active {
    border-left: 4px solid var(--drake-accent);
}

#md-searchpanel .btn:not(.close-btn):hover {
    box-shadow: none;
    background: var(--btn-hover-bg-color);
}

/*checkbox*/
#write input[type=checkbox] {
    opacity: 0;
    height: 1.6rem;
    width: 1.6rem;
    margin-left: -2em;
    margin-top: 0;
    top: 0;
}

#write .ul-list li.md-task-list-item.task-list-done::before {
    content: "";
    background: var(--checkbox-checked) 0 0 no-repeat;
    background-size: 100%;
    display: inline-block;
    position: absolute;
    height: 1.6rem;
    width: 1.6rem;
    margin-left: -2em;
}
#write .ul-list li.md-task-list-item.task-list-not-done::before {
    content: "";
    background: var(--checkbox-unchecked) 0 0 no-repeat;
    background-size: 100%;
    display: inline-block;
    position: absolute;
    height: 1.6rem;
    width: 1.6rem;
    margin-left: -2em;
}
.task-list-item p {
    line-height: 1.6rem;
}

/*insert table*/
.btn {
    border-radius: 2px;
}

.modal-content {
    border-radius: 8px;
}

.btn-primary:hover, .btn-primary:active {
    background-color: var(--btn-hover-bg-color);
    color: var(--drake-highlight);
}

.btn-primary {
    background-color: transparent;
    color: var(--drake-highlight);
}

.btn-default {
    background-color: transparent;
}

.btn:active {
    box-shadow: none;
    border-color: transparent;
}

.modal-footer {
    border-top: none;
}

#table-insert-col, #table-insert-row {
    background: var(--input-bg-color);
    border-radius: 2px;
}

/*preference panel*/
#megamenu-content {
    background-image: none !important;
    background-color: var(--bg-color);
}
#top-titlebar {
    height: inherit;
    background-color: var(--bg-color);
}
#megamenu-menu-sidebar {
    background-color: var(--bg-color);
    color: var(--text-color);
}
.long-btn {
    width: inherit;
    min-width: 300px;
    border: 1px solid var(--text-color);
    border-radius: 6px;
}
.megamenu-menu-panel h1 {
    margin-bottom: 3rem;
    text-align: left;
}
.megamenu-menu-panel h1, .megamenu-menu-panel h2 {
    font-weight: normal;
}
#recent-file-panel-search-input {
    height: 45px;
    border: none;
    border-bottom: 1px solid var(--text-color);
    padding-left: 8px;
}
#recent-file-panel-search-input::placeholder {
    color: var(--text-color);
    opacity: .5;
}
.megamenu-menu-header {
    border-bottom: none;
}
#recent-file-panel-action-btn {
    background: none;
    border: none;
}
#recent-file-panel-action-btn-container {
    float: none;
    display: inline-block;
}
#top-titlebar .toolbar-icon.btn.hover, #top-titlebar .toolbar-icon.btn:hover {
    background-color: var(--btn-hover-bg-color);
    color: var(--text-color);
}
.megamenu-menu-panel .btn:hover {
    background-color: var(--btn-hover-bg-color) !important;
    color: var(--text-color);
}
#recent-file-panel tbody tr:nth-child(2n-1),
.megamenu-menu-panel table thead,
.megamenu-menu-panel table tr {
    background-color: transparent;
}
.megamenu-menu-panel table {
    font-weight: normal;
}
#megamenu-back-btn {
    color: var(--text-color);
    border: 1px solid var(--text-color);
}
.megamenu-menu-header #megamenu-menu-header-title {
    color: var(--text-color);
}
header, .context-menu, .megamenu-content, footer {
    font-family: var(--text-font);
}
.ty-preferences select {
    padding-left: 2px;
}
.preference-item-hint {
    font-size: 14px;
}
a.ty-link {
    color: var(--a-color);
    margin: 0 .2rem;
}

/**
    code render
    Name: IntelliJ IDEA light theme
    From IntelliJ IDEA by JetBrains
 */
.cm-s-inner.CodeMirror {
    background: none;
    color: var(--code-block-color);
}
.cm-s-inner span.cm-number {
    color: #c5221f;
}
.cm-s-inner span.cm-atom {
    color: #c5221f;
}
.cm-s-inner span.cm-def {
    color: #00f;
}
.cm-s-inner span.cm-variable {
    color: var(--code-block-color);
}
.cm-s-inner span.cm-variable-2 {
    color: #00627A;
}
.cm-s-inner span.cm-variable-3, .cm-s-inner span.cm-type {
    color: #9334e6;
}
.cm-s-inner span.cm-property {
    color: var(--code-block-color);
}
.cm-s-inner span.cm-keyword {
    color: #1967d2;
}
.cm-s-inner span.cm-operator {
    color: var(--code-block-color);
}
.cm-s-inner span.cm-comment {
    color: #b80672;
}
.cm-s-inner span.cm-string {
    color: #008000;
}
.cm-s-inner span.cm-string-2 {
    color: #008000;
}
.cm-s-inner span.cm-qualifier {
    color: var(--code-block-color);
}
.cm-s-inner span.cm-error {
    color: red;
}
.cm-s-inner span.cm-attribute {
    color: #9334e6;
}
.cm-s-inner span.cm-tag.cm-bracket {
    color: #1967d2;
}
.cm-s-inner span.cm-link {
    color: #4A86E8;
}
.cm-s-inner span.cm-builtin {
    color: var(--code-block-color);
}
.cm-s-inner .cm-meta {
    color: #c5221f;
}
.cm-s-inner .CodeMirror-gutters {
    border-right: 1px solid rgba(120, 120, 120, 0.3);
    background: var(--code-block-bg-color);
}
.cm-s-inner .CodeMirror-linenumber {
    color: #787878;
}
/* 正文标题区: #write */
/* [TOC]目录树区: .md-toc-content */
/* 侧边栏的目录大纲区: .sidebar-content */
 
/** 
 * 说明：
 *     Typora的标题共有6级，从h1到h6。
 *     我个人觉得h1级的标题太大，所以我的标题都是从h2级开始。
 *     个人习惯每篇文章都有一个总标题，有一个目录，所以h2级的标题前两个都不会计数。
 *     一般情况下，我虽然不使用h1级的标题，但是为了以防万一，h1级的标题前两个也都不会计数。
 *     若想启用h1级标题，就取消包含“content: counter(h1) "."”项的注释，然后将包含“content: counter(h2) "."”的项注释掉即可。
 */ 
/** initialize css counter */
#write, .sidebar-content,.md-toc-content{
	/* 设置全局计数器的基准 */
	/* 因为我喜欢从h2级标题用起，所以这里设置为h2 */
    counter-reset: h2
}
 
#write h1, .outline-h1, .md-toc-item.md-toc-h1 {
    counter-reset: h2
}
 
#write h2, .outline-h2, .md-toc-item.md-toc-h2 {
    counter-reset: h3
}
 
#write h3, .outline-h3, .md-toc-item.md-toc-h3 {
    counter-reset: h4
}
 
#write h4, .outline-h4, .md-toc-item.md-toc-h4 {
    counter-reset: h5
}
 
#write h5, .outline-h5, .md-toc-item.md-toc-h5 {
    counter-reset: h6
}
 
/** put counter result into headings */
#write h1:before,
.outline-h1>.outline-item>.outline-label:before,
.md-toc-item.md-toc-h1>.md-toc-inner:before {
    counter-increment: h1;
    content: counter(h1) ". "
}
 
/* 使用h1标题时，去掉前两个h1标题的序号，包括正文标题、目录树和大纲 */
/* nth-of-type中的数字表示获取第几个h1元素，请根据情况自行修改。 */
#write h1:nth-of-type(1):before,
.outline-h1:nth-of-type(1)>.outline-item>.outline-label:before,
.md-toc-item.md-toc-h1:nth-of-type(1)>.md-toc-inner:before,
#write h1:nth-of-type(2):before,
.outline-h1:nth-of-type(2)>.outline-item>.outline-label:before,
.md-toc-item.md-toc-h1:nth-of-type(2)>.md-toc-inner:before{
	counter-reset: h1;
	content: ""
}
 
/*#write h2:before,
.outline-h2>.outline-item>.outline-label:before,
.md-toc-item.md-toc-h2>.md-toc-inner:before {
    counter-increment: h2;
    content: counter(h2) ". "
}*/
 
/* 使用h2标题时，去掉前两个h2标题的序号，包括正文标题、目录树和大纲 */
/* nth-of-type中的数字表示获取第几个h2元素，请根据情况自行修改。 */
#write h2:nth-of-type(1):before,
.outline-h2:nth-of-type(1)>.outline-item>.outline-label:before,
.md-toc-item.md-toc-h2:nth-of-type(1)>.md-toc-inner:before,
#write h2:nth-of-type(2):before,
.outline-h2:nth-of-type(2)>.outline-item>.outline-label:before,
.md-toc-item.md-toc-h2:nth-of-type(2)>.md-toc-inner:before{
	counter-reset: h2;
	content: ""
}
 
#write h3:before,
h3.md-focus.md-heading:before, /** override the default style for focused headings */
.outline-h3>.outline-item>.outline-label:before,
.md-toc-item.md-toc-h3>.md-toc-inner:before {
/*	text-decoration: none;*/
    counter-increment: h3;
    /* content: counter(h1) "." counter(h2) "." counter(h3) ". " */
     content:  counter(h3) ". "
}
 
#write h4:before,
h4.md-focus.md-heading:before,
.outline-h4>.outline-item>.outline-label:before,
.md-toc-item.md-toc-h4>.md-toc-inner:before {
/*	text-decoration: none;*/
    counter-increment: h4;
    /* content: counter(h1) "." counter(h2) "." counter(h3) "." counter(h4) ". " */
    content: counter(h3) "." counter(h4) ". "
}
 
#write h5:before,
h5.md-focus.md-heading:before,
.outline-h5>.outline-item>.outline-label:before,
.md-toc-item.md-toc-h5>.md-toc-inner:before {
/*	text-decoration: none;*/
    counter-increment: h5;
    /* content: counter(h1) "." counter(h2) "." counter(h3) "." counter(h4) "." counter(h5) ". " */
    content: counter(h3) "." counter(h4) "." counter(h5) ". "
}
 
#write h6:before,
h6.md-focus.md-heading:before,
.outline-h6>.outline-item>.outline-label:before,
.md-toc-item.md-toc-h6>.md-toc-inner:before {
/*	text-decoration: none;*/
    counter-increment: h6;
    /* content: counter(h1) "." counter(h2) "." counter(h3) "." counter(h4) "." counter(h5) "." counter(h6) ". " */
    content: counter(h3) "." counter(h4) "." counter(h5) "." counter(h6) ". "
}
 
/** override the default style for focused headings */
#write>h3.md-focus:before,
#write>h4.md-focus:before,
#write>h5.md-focus:before,
#write>h6.md-focus:before,
h3.md-focus:before,
h4.md-focus:before,
h5.md-focus:before,
h6.md-focus:before {
    color: inherit;
    border: inherit;
    border-radius: inherit;
    position: inherit;
    left:initial;
    float: none;
    top:initial;
    font-size: inherit;
    padding-left: inherit;
    padding-right: inherit;
    vertical-align: inherit;
    font-weight: inherit;
    line-height: inherit;
}

mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
  min-height: 1px;
  min-width: 1px;
}

mjx-container[jax="SVG"] > svg a {
  fill: blue;
  stroke: blue;
}

mjx-assistive-mml {
  position: absolute !important;
  top: 0px;
  left: 0px;
  clip: rect(1px, 1px, 1px, 1px);
  padding: 1px 0px 0px 0px !important;
  border: 0px !important;
  display: block !important;
  width: auto !important;
  overflow: hidden !important;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

mjx-assistive-mml[display="block"] {
  width: 100% !important;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][display="true"][width="full"] {
  display: flex;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line], svg[data-table] > g > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame], svg[data-table] > g > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed, svg[data-table] > g > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted, svg[data-table] > g > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > g > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

mjx-container[jax="SVG2"] path[data-c], mjx-container[jax="SVG2"] use[data-c] {
  stroke-width: 3;
}

g[data-mml-node="xypic"] path {
  stroke-width: inherit;
}

.MathJax g[data-mml-node="xypic"] path {
  stroke-width: inherit;
}
mjx-container[jax="SVG"] path[data-c], mjx-container[jax="SVG"] use[data-c] {
							stroke-width: 0;
						} @media print { @page {margin: 0 0 0 0;} body.typora-export {padding-left: 0; padding-right: 0;} #write {padding:0;}}
</style><title>3.6块分配器</title>
</head>
<body class='typora-export typora-export-show-outline typora-export-no-collapse-outline'><div class='typora-export-content'>
<div class="typora-export-sidebar"><div class="outline-content"><li class="outline-item-wrapper outline-h1"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#块分配器">块分配器</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#一介绍">一、介绍</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#二编程接口">二、编程接口</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#常用的函数接口">常用的函数接口</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#分配内存">分配内存</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#重新分配内存">重新分配内存</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#释放内存">释放内存</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#创建专用内存缓存接口">创建专用内存缓存接口</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#创建内存缓存">创建内存缓存</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#从指定的内存缓存分配对象">从指定的内存缓存分配对象</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#释放对象">释放对象</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#销毁内存缓存">销毁内存缓存</a></div><ul class="outline-children"></ul></li></ul></li></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#三slab分配器">三、SLAB分配器</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#数据结构">数据结构</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#空闲对象链表">空闲对象链表</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#计算slab长度">计算slab长度</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#着色">着色</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#每处理器数组缓存">每处理器数组缓存</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#对numa的支持">对NUMA的支持</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#内存缓存合并">内存缓存合并</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#回收内存">回收内存</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#调试">调试</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#四slub分配器">四、SLUB分配器</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#数据结构-2">数据结构</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#空闲对象链表-2">空闲对象链表</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#计算slab长度-2">计算slab长度</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#每处理器slab缓存">每处理器slab缓存</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#对numa的支持-2">对NUMA的支持</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#回收内存-2">回收内存</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#调试-2">调试</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#五slob分配器">五、SLOB分配器</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#数据结构-3">数据结构</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#空闲对象链表-3">空闲对象链表</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#分配对象">分配对象</a></div><ul class="outline-children"></ul></li></ul></li></ul></li></div></div><div id='write'  class=''><h1 id='块分配器'><span>块分配器</span></h1><h2 id='一介绍'><span>一、介绍</span></h2><p><span>	</span><span>为了解决小块内存的分配问题，Linux内核提供了快分配器，最早实现的快分配器是SLAB分配器。</span></p><p><span>	</span><span>SLAB分配器的作用不仅仅是分配小块内存，更重要的是针对经常分配和释放的对象充当缓存。SLAB分配器的核心思想是：尾每种队形类型创建一个内存缓存，每个内存缓存由多个大块slab组成，一个大块是一个或多个连续的物理页，每个大块包含多个对象，SLAB采用了面向对象的思想，基于对象类型管理内存，每种对象被划分成一类，比如进程描述符task_struct是一个类，每个进程描述符实例是一个对象，内存缓存的组成图如下图所示：</span></p><p><img src=".assets/082.png" alt="082" style="zoom:40%;" /></p><p><span>	</span><span>SLAB分配器在牟星情况下表现不太好，所以Linux内核提供了2个改进的快分配器：</span></p><p><span>	</span><span>1）在配被了大量物理内存的大型计算机墙上，SLAB分配器的管理数据结构的内存开销比较大，实际了SLUB分配器；</span><span>	</span></p><p><span>	</span><span>2）在小内存的嵌入式设备上，SLAB分配器的代码太多，太复杂设计了SLOB分配器。SLOB是“Simple List Of Blocks”，简单的快链表；</span></p><h2 id='二编程接口'><span>二、编程接口</span></h2><p><span>	</span><span>3种块分配器提供了统一的编程接口。</span></p><p><span>	</span><span>为了方便使用，块分配器在初始化的时候创建了一些通用的内存缓存，对象的长度大多数是2字节，从普通区域分配页的内存缓存的名称是”kmalloc-</span><size><span>“（size是对象的长度），从DMA区域分配页的内存缓存对象名称是”dma-kmalloc-</span><size><span>“，执行命令”cat/proc/slabinfo“可以看到这些通用的内存缓存。</span></p><p><span>	</span><span>通用的内存缓存的编程接口如下：</span></p><h3 id='常用的函数接口'><span>常用的函数接口</span></h3><h4 id='分配内存'><span>分配内存</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.5px; left: 33px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 29px; margin-bottom: 0px; border-right-width: 0px; min-width: 391px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -29px; width: 29px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 20px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-variable-3">*</span><span class="cm-def">kmalloc</span>(<span class="cm-variable-3">size_t</span> <span class="cm-variable">size</span>, <span class="cm-variable">gfp_t</span> <span class="cm-variable">flags</span>);</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 25px;"></div><div class="CodeMirror-gutters" style="height: 25px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 28px;"></div></div></div></div></pre><ul><li><p><span>size：需要的内存长度；</span></p></li><li><p><span>flags：传给页分配器的分配标志位，当内存缓存没有空闲对象，向页分配器请求分配页的时候使用这个分配标志位。</span></p></li></ul><p><span>	</span><span>块分配器找到一个何时的通用内存缓存：对象的长度刚好大于等于请求的内存长度，然后从这个内存缓存分配对象，如果分配成功，返回对象的地址，否则返回空指针。</span></p><h4 id='重新分配内存'><span>重新分配内存</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.5px; left: 33px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 29px; margin-bottom: 0px; border-right-width: 0px; min-width: 583px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -29px; width: 29px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 20px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-variable-3">*</span><span class="cm-def">krealloc</span>(<span class="cm-keyword">const</span> <span class="cm-variable-3">void</span> <span class="cm-variable-3">*</span><span class="cm-variable">p</span>, <span class="cm-variable-3">size_t</span> <span class="cm-variable">new_size</span>, <span class="cm-variable">gfp_t</span> <span class="cm-variable">flags</span>);</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 25px;"></div><div class="CodeMirror-gutters" style="height: 25px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 28px;"></div></div></div></div></pre><ul><li><p><span>p：需要重新分配内存的对象；</span></p></li><li><p><span>new_size：新的长度；</span></p></li><li><p><span>flags：传给页分配的标志位；</span></p></li></ul><p><span>	</span><span>根据新的长度对象重新分配内存，如果分配成功看，返回新的地址，否则返回空指针。</span></p><h4 id='释放内存'><span>释放内存</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.5px; left: 33px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 29px; margin-bottom: 0px; border-right-width: 0px; min-width: 285.390625px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -29px; width: 29px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 20px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">kfree</span>(<span class="cm-keyword">const</span> <span class="cm-variable-3">void</span> <span class="cm-variable-3">*</span><span class="cm-variable">objp</span>);</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 25px;"></div><div class="CodeMirror-gutters" style="height: 25px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 28px;"></div></div></div></div></pre><ul><li><p><span>objp：kmalloc()返回的对象的地址；</span></p></li></ul><p><span>	</span><span>kfree函数怎么知道对象属于哪个通用的内存缓存？</span></p><p><span>	</span><span>使用通用的内存缓存的缺点是：块分配器需要找到一个对象的长度刚好大于或等于请求的内存长度通用的内存缓存，吐过请求的内存长度和内存缓存的对象长度相差很远，良妃比较大，比如申请36字节，实际分配的内存长度是64字节，浪费了28字节。所以有时候使用者需要创建专用的内存缓存。</span></p><h3 id='创建专用内存缓存接口'><span>创建专用内存缓存接口</span></h3><h4 id='创建内存缓存'><span>创建内存缓存</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.5px; left: 33px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 29px; margin-bottom: 0px; border-right-width: 0px; min-width: 765.390625px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>2</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -29px; width: 29px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 20px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">struct</span> <span class="cm-def">kmem_cache</span> <span class="cm-operator">*</span><span class="cm-def">kmem_cache_create</span>(<span class="cm-keyword">const</span> <span class="cm-operator">*</span><span class="cm-variable">name</span>, <span class="cm-variable-3">size_t</span> <span class="cm-variable">size</span>, <span class="cm-variable-3">size_t</span> <span class="cm-variable">align</span>, </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 20px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">                                    <span class="cm-variable-3">unsigned</span> <span class="cm-variable-3">long</span> <span class="cm-variable">flags</span>, <span class="cm-variable-3">void</span> (<span class="cm-operator">*</span><span class="cm-variable">ctor</span>)(<span class="cm-variable-3">void</span> <span class="cm-variable-3">*</span>));</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 50px;"></div><div class="CodeMirror-gutters" style="height: 50px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 28px;"></div></div></div></div></pre><ul><li><p><span>name：名称；</span></p></li><li><p><span>size：对象的长度；</span></p></li><li><p><span>align：对象需要对齐的数值；</span></p></li><li><p><span>flags：SLAB标志位；</span></p></li><li><p><span>ctor：对象的构造函数；</span></p></li></ul><h4 id='从指定的内存缓存分配对象'><span>从指定的内存缓存分配对象</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.5px; left: 33px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 29px; margin-bottom: 0px; border-right-width: 0px; min-width: 602.1875px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -29px; width: 29px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 20px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">kmem_cache_alloc</span>(<span class="cm-keyword">struct</span> <span class="cm-def">kmem_cache</span> <span class="cm-operator">*</span><span class="cm-variable">cachep</span>, <span class="cm-variable">gfp_t</span> <span class="cm-variable">flags</span>);</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 25px;"></div><div class="CodeMirror-gutters" style="height: 25px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 28px;"></div></div></div></div></pre><ul><li><p><span>cachep：从指定的内存缓存分配；</span></p></li><li><p><span>flags：传给页分配器的分配标志位，当内存缓存没有空闲对象，向页分配器请求分配页的时候使用这个分配标志；</span></p><p><span>如果分配成功，返回对象的地址，否则返回空指针。</span></p></li></ul><h4 id='释放对象'><span>释放对象</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.5px; left: 33px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 29px; margin-bottom: 0px; border-right-width: 0px; min-width: 583px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -29px; width: 29px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 20px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">kmem_cache_free</span>(<span class="cm-keyword">struct</span> <span class="cm-def">kmem_cache</span> <span class="cm-operator">*</span><span class="cm-variable">cachep</span>, <span class="cm-variable-3">void</span> <span class="cm-variable-3">*</span><span class="cm-variable">objp</span>);</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 25px;"></div><div class="CodeMirror-gutters" style="height: 25px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 28px;"></div></div></div></div></pre><ul><li><p><span>cachep：对象所属的内存缓存；</span></p></li><li><p><span>objp：对象的地址；</span></p></li></ul><h4 id='销毁内存缓存'><span>销毁内存缓存</span></h4><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.5px; left: 33px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 29px; margin-bottom: 0px; border-right-width: 0px; min-width: 448.59375px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -29px; width: 29px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 20px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">void</span> <span class="cm-def">kmem_cache_destroy</span>(<span class="cm-keyword">struct</span> <span class="cm-def">kmem_cache</span> <span class="cm-operator">*</span><span class="cm-variable">s</span>);</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 25px;"></div><div class="CodeMirror-gutters" style="height: 25px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 28px;"></div></div></div></div></pre><ul><li><p><span>s：内存缓存；</span></p></li></ul><h2 id='三slab分配器'><span>三、SLAB分配器</span></h2><h3 id='数据结构'><span>数据结构</span></h3><p><span>	</span><span>内存缓存的数据结构如下图所示：</span></p><p><img src=".assets/083.png" alt="083" style="zoom:40%;" /></p><ol start='' ><li><p><span>每个内存缓存对应一个kmem_cache实例；</span></p><p><span>    成员gfporder是slab的阶数，成员num是每个slab包含的对象数量，成员object_size是对象的原始长度，成员size是包括填充的对象长度；</span></p></li><li><p><span>每个内存节点对应一个kmem_cache_node实例；</span></p><p><span>    kmem_cache_node实例包含了3条slab链表：链表slabs_partial把部分对象空闲的slab链接起来，链表slabs_full把没有空闲对象的slab链接起来，链表slabs_free把所有对象空闲的slab链接起来。成员total_slabs是slab数量。</span></p></li></ol><p><span>	</span><span>每个slab由一个或多个连续的物理页组成，页的阶数时kmem_cache.gfporder，如果阶数大于0，组成一个复合页。slab被划分成多个对象，大多数情况下，slab长度不是对象长度的整数倍，slab剩余部分，可以用来给slab着色：“把slab的第一个对象从slab的其实位置偏移一个数值，偏移值是处理器的一级缓存行长度的整数倍忙不tongslab的偏移值不同，使不同slab的对象映射的处理器不同的缓存行”，所以我们看到的slab的前面有一个着色部分。</span></p><p><span>	</span><span>page结构体的相关成员如下：</span></p><p><span>	</span><span>1）成员flags设置标志位PG_slab，表示页属于SLAB分配器。</span></p><p><span>	</span><span>2）成员s_mem存放slab第一个对象的地址。</span></p><p><span>	</span><span>3）成员active表示已分配对象的数量。</span></p><p><span>	</span><span>4）成员lru作为链表节点加入其中一条slab链表。</span></p><p><span>	</span><span>5）成员slab_cache指向kmem_cache实例。</span></p><p><span>	</span><span>6）成员freelist指向空闲对象链表。</span></p><blockquote><p><strong><span>思考：</span></strong><span>kfree函数怎么知道对象属于哪个通用的内存缓存分配？</span></p><p><strong><span>回答：</span></strong></p><p><span>	</span><span>第一步，根据对象的虚拟地址得到物理地址，因为块分配器使用的虚拟地址属于直线映射的内核虚拟地址空间，虚拟地址 = 物理地址 + 常量，把虚拟地址转换成物理地址很方便；</span></p><p><span>	</span><span>第二步，根据物理地址得到物理号；</span></p><p><span>	</span><span>第三步，根据物理号得到page实例；</span></p><p><span>	</span><span>第四步，如果是复合页，需要得到首页的page实例；</span></p><p><span>	</span><span>第五步，根据page实例的成员cpu_slab得到kmem_cache实例。</span></p></blockquote><ol start='3' ><li><p><span>kmem_cache实例的成员cpu_slab指向array_cache，每个处理器对应一个array_cache实例，称为数组缓存，用来缓存刚刚释放的对象，分配时首先从当前处理器的数组缓存分配，避免每次都要从slab分配，减少链表操作和锁操作，提高分配速度。</span></p><p><span>成员limit是数组的大小，成员avail是数组entry存放的对象数量，数组entry存放对象地址。</span></p></li></ol><p><span>	</span><span>每个对象的内存布局如下图所示：</span></p><p><img src=".assets/084.png" alt="084" style="zoom:40%;" /></p><p><span>	</span><strong><span>区域说明：</span></strong></p><p><span>	</span><span>1）红色区域1：长度是8字节，写入一个魔幻数，如果值被修改，说明对象被改写；</span></p><p><span>	</span><span>2）真实对象：长度是kmem_cache.obj_size，偏移是kmem_cache.obj_offset；</span></p><p><span>	</span><span>3）填充：用来对齐的填充字节；</span></p><p><span>	</span><span>4）红色区域2：长度是8字节，写入一个魔幻数，如果值被修改，说明对象被改写；</span></p><p><span>	</span><span>5）最后一个使用者：在64位系统中长度是8字节，存放最后一个调用者的地址，用来确定对象被谁改写；</span></p><p><span>	</span><span>对象的长度是kmem_cache.size。红色区域1、红色区域2和最后一个使用者是可选的，当想要发现内存分配和使用的错误，打开调试配置CONFIG_DEBUG_SLAB的时候，对象才包含这3个成员。</span></p><p>&nbsp;</p><p><span>	</span><span>kmen_size.obj_size是调用者指定的对象长度，kmem_cache.size是对象实际占用的内存长度，通常比前者大，原因是为了提高访问对象的速度，需要把对象的地址和长度都对齐到某个值，对齐值计算步骤如下：</span></p><p><span>	</span><span>1）如果创建内存缓存时指定了标志位SLAB_HWCACHE_ALIGN，要求和处理器的一级缓存行的长度对齐，计算对齐值的方法如下：</span></p><p><span>	</span><span>a、如果对象的长度大于或等于一级缓存的长度的一半，对齐值取以及缓存行的长度；</span></p><p><span>	</span><span>b、如果对象的长度小于或等于一级缓存行的长度的一半，对齐值取</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="12.249ex" height="3.07ex" role="img" focusable="false" viewBox="0 -1011.8 5414.1 1356.8" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.781ex;"><defs><path id="MJX-4-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-4-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mfrac"><g data-mml-node="mrow" transform="translate(220,481.4) scale(0.707)"><g data-mml-node="mtext"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">一</text></g><g data-mml-node="mtext" transform="translate(879.3,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">级</text></g><g data-mml-node="mtext" transform="translate(1758.6,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">缓</text></g><g data-mml-node="mtext" transform="translate(2637.9,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">存</text></g><g data-mml-node="mtext" transform="translate(3517.2,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">行</text></g><g data-mml-node="mtext" transform="translate(4396.5,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">的</text></g><g data-mml-node="mtext" transform="translate(5275.8,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">长</text></g><g data-mml-node="mtext" transform="translate(6155.1,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">度</text></g></g><g data-mml-node="msup" transform="translate(2350.9,-345) scale(0.707)"><g data-mml-node="mn"><use data-c="32" xlink:href="#MJX-4-TEX-N-32"></use></g><g data-mml-node="mi" transform="translate(533,289) scale(0.707)"><use data-c="1D45B" xlink:href="#MJX-4-TEX-I-1D45B"></use></g></g><rect width="5174.1" height="60" x="120" y="220"></rect></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mfrac><mrow><mtext>一</mtext><mtext>级</mtext><mtext>缓</mtext><mtext>存</mtext><mtext>行</mtext><mtext>的</mtext><mtext>长</mtext><mtext>度</mtext></mrow><msup><mn>2</mn><mi>n</mi></msup></mfrac></math></mjx-assistive-mml></mjx-container><script type="math/tex">\frac{一级缓存行的长度}{2^n}</script><span>，把2</span><sup><span>n</span></sup><span>个对象放在一个以及缓存里面，需要为n找到一个合适的值；</span></p><p><span>	</span><span>c、如果对齐值小于指定的对齐值，取指定的对齐值；</span></p><p><span>	</span><span>举例来说明：假设指定的对齐值是4字节，一级缓存行的长度是32字节，对象的长度是12字节，那么对齐值是16字节，对象占用的内存长度是16字节，把2个对象放在一个一级缓存行里面。</span></p><p><span>	</span><span>2）如果对齐值小于ARCH_SLAB_MINALIGN，那么取ARCH_SLAB_MINALIGN。ARCH_SLAB_MIBALIGN是各种处理器架构定义的最小对齐值，默认值是8。</span></p><p><span>	</span><span>3）把对齐值向上调整为指针长度的整数倍。</span></p><h3 id='空闲对象链表'><span>空闲对象链表</span></h3><p><span>	</span><span>每个slab需要一个空闲对象链表，从而把所有空闲对象链接起来，空闲对象链表是用数组实现的，数组的元素个数是slab的对象数量，数组存放空闲对象的索引。假设一个slab包括4个对象，空闲对象链表的初始化状态如下图所示：</span></p><p><img src=".assets/085.png" alt="085" style="zoom:40%;" /></p><p><span>	</span><span>page-&gt;freelist指向空闲对象链表，数组中第n个元素存放的对象索引是n，如果打开了SLAB空闲链表随机化的配置宏CONFIG_SLAB_FreelIst_RANDOM，数组中第n个元素存放的对象索引是随机的。</span></p><p><span>	</span><span>第一次分配对象，从0号数组元素取出空闲对象索引0，page-&gt;active增加到1，空闲对象链表如下图所示：</span></p><p><img src=".assets/086.png" alt="086" style="zoom:40%;" /></p><p><span>	</span><span>当所有对象分配完毕后，page-&gt;actice增加到4，等于slab的对象数量，空闲对象链表如下图所示：</span></p><p><img src=".assets/087.png" alt="087" style="zoom:40%;" /></p><p><span>	</span><span>当释放索引0的对象后，page-&gt;actice减1变成3，3号数组元素存放空闲对象索引0，空闲对象链表如下图所示：</span></p><p><img src=".assets/088.png" alt="088" style="zoom:40%;" /></p><p><span>	</span><span>空闲对象链表的位置有3种选择：</span></p><p><span>	</span><span>1）使用一个对象存放空闲对象链表，此时kmem_cache.flags设置了标志位CFLGS_OBJFREELIST_SLAB；</span></p><p><span>	</span><span>2）把空闲的对象链表存放在slab外面，此时kmem_cache.flags设置了标志位CFLGS_OFF_SLAB；</span></p><p><span>	</span><span>3）把空闲对象链表放在slab尾部，如果kmem_cache.flags没有设置上面2个标志位，就表示把空闲对象链表放在slab尾部；</span></p><p>&nbsp;</p><p><span>	</span><span>如果使用一个对象存放空闲对象链表，默认使用最后一个对象。如果打开了SLAB空闲链表随机化的配置宏CONFIGL_SLAB_FREELIST_RANDOM，这个对象是随机选择的。</span></p><p><span>	</span><span>假设一个slab包含4个对象，使用1号对象存放空闲对象链表，初始化状态如下图所示：</span></p><p><img src=".assets/089.png" alt="089" style="zoom:40%;" /></p><p><span>	</span><span>这种方案会不会导致可以分配的对象减少一个呢？答案是不会的，存放空闲对象链表的对象可以被分配，这种方案采用了巧妙的方法。</span></p><p><span>	</span><span>1）必须把存放空闲对象链表的对象索引存放在空闲对象数组的最后面，保证了这个对象是最后一个被分配出去的。</span></p><p><span>	</span><span>2）分配最后一个空闲对象，page-&gt;active增加到4，page-&gt;freelist变成了空指针，所有对象被分配出去，已经不需要空闲对象链表，如下图所示：</span></p><p><img src=".assets/090.png" alt="090" style="zoom:40%;" /></p><p><span>	</span><span>3）在所有帝乡分配完毕后，假设现在释放2号对象，slab使用2号对象存放空闲对象链表，page-freelist指向2号对象，把对象索引2存放在空闲对象数组的最后面，如下图所示：</span></p><p><img src=".assets/091.png" alt="091" style="zoom:40%;" /></p><p><span>	</span><span>如果把空闲对象链表存放在slab外面，需要为空闲对象链表创建一个内存缓存，kmem_cache.freelist_cache指向空闲对象链表的内存缓存，如下图所示：</span></p><p><img src=".assets/092.png" alt="092" style="zoom:40%;" /></p><p><span>	</span><span>如果slab尾部的剩余部分足够大，可以把空闲对象链表存放在slab尾部，。如下图所示：</span></p><p><img src=".assets/093.png" alt="093" style="zoom:40%;" /></p><p><span>	</span><span>创建内存缓存的时候，确定空闲对象链表的位置方法如下：</span></p><p><span>	</span><span>1）首先尝试使用一个对象存放空闲对象链表；</span></p><p><span>	</span><span>a、如果指定了对象的构造函数，那么这种方案不合适；</span></p><p><span>	</span><span>b、如果指定了标志位SLAB_TYPESAFR_BY_RCU，表示使用RCU技术延迟释放slab，那么这种方案不合适；</span></p><p><span>	</span><span>c、计算出slab长度和slab的对象数量，空闲对象链表的长度等于（slab对象数量 * 对象索引长度）。如果空闲对象链表的长度大于对象长度，那么这种方案不合适；</span></p><p><span>	</span><span>2）接着尝试把空闲对象链表放在slab外面，计算出slab长度和slab的对象数量。如果slab的剩余长度大于或等于空闲对象链表的长度，应该把空闲对象链表放在slab尾部。，不应该使用这种方案。</span></p><p><span>	</span><span>3）最后尝试把空闲对象链表放在slab尾部。</span></p><h3 id='计算slab长度'><span>计算slab长度</span></h3><p><span>	</span><span>函数caculate_slab_order负责计算机slab长度，从0阶到kmalloc()函数支持的最大阶数（KMALLOC_MAX_ORDER），尝试如下：</span></p><p><span>	</span><span>1）计算对象数量的剩余长度；</span></p><p><span>	</span><span>2）如果对象数量是0，那么不合适；</span></p><p><span>	</span><span>3）如果对象数量大于允许的最大slab对象数量，那么不合适，允许的最大slab对象数量是SLAB_OBJ_MAX_NUM，等于（2</span><sup><span>sizeof(freelist_idx_t)</span></sup><span> * 8 - 1），frelist_idx_t是对象索引的数据类型。</span></p><p><span>	</span><span>4）对于空闲对象链表在slab外面的情况，如果空闲对象链表的长度大于对象长度的一半，那么不合适；</span></p><p><span>	</span><span>5）如果slab时可回收的（设置了标志位SLAB_RECLAIM_ACCOUNT），那么选择这个阶数；</span></p><p><span>	</span><span>6）如果阶数大于或等于允许的最大slab阶数（slab_max_order），那么选择这个阶数；</span></p><p><span>	</span><span>7）如果剩余长度小于或等于slab长度的</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="1.795ex" height="2.773ex" role="img" focusable="false" viewBox="0 -864.9 793.6 1225.5" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.816ex;"><defs><path id="MJX-5-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-5-TEX-N-38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mfrac"><g data-mml-node="mn" transform="translate(220,394) scale(0.707)"><use data-c="31" xlink:href="#MJX-5-TEX-N-31"></use></g><g data-mml-node="mn" transform="translate(220,-345) scale(0.707)"><use data-c="38" xlink:href="#MJX-5-TEX-N-38"></use></g><rect width="553.6" height="60" x="120" y="220"></rect></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mfrac><mn>1</mn><mn>8</mn></mfrac></math></mjx-assistive-mml></mjx-container><script type="math/tex">\frac{1}{8}</script><span>，那么选择这个阶数；</span></p><p><span>	</span><span>slab_max_order：允许的最大slab阶数，如果内存容量大于32MB，那么默认值是1，否则默认值是0。可以通过内核参数“slab_max_order”指定。</span></p><h3 id='着色'><span>着色</span></h3><p><span>	</span><span>slab时一个或多个连续的物流页，起始地址总是页长度的整数倍，不同slab中相同偏移位置在处理器的一级缓存中索引相同，如果slab的剩余部分的长度超过一级缓存行的长度，剩余部分对应的一级缓存没有被利用；如果对象的填充字节的长度超过一级缓存行的长度，填充字节对应的一级缓存行没有被利用。这2种情况导致处理器的某些缓存行被过度使用，另一些缓存行很少使用。</span></p><p><span>	</span><span>在slab的剩余部分的长度超过一级缓存行长度的情况下，为了均匀利用处理器的所有一级缓存行，slab着色（slab coloring）利用slab的剩余部分，使不同slab的第一个对象的偏移不同。</span></p><p><span>	</span><span>着色是一个比喻，和颜色无关，只是表示slab中的第一个对象需要移动的偏移值，使对象放到不同的一级缓存行里。</span></p><p><span>	</span><span>内存缓存中着色相关的成员如下：</span></p><p><span>	</span><span>1）kmem_cache.colour_off是颜色偏移等于处理器的一级缓存行的长度，如果小于对齐值那么取对齐值。</span></p><p><span>	</span><span>2）kmem_cache.colour是着色范围，等于（slab的剩余长度/颜色偏移）。</span></p><p><span>	</span><span>3）kmem_cache.node[n]-&gt;colour_next是下一种颜色，初始值是0。</span></p><p><span>	</span></p><p><span>	</span><span>在内存节点n上创建新的slab，计算slab的颜色偏移的方法如下。</span></p><p><span>	</span><span>1）把kmem_cache.node[n]-&gt;colour_next加1，如果大于或等于着色范围，把值设为0。</span></p><p><span>	</span><span>2）slab的颜色偏移=kmem_cache.node[n]-&gt;colour_next * kmem_cache.colur_off。</span></p><p><span>	</span><span>slab对应的page结构体的成员s_mem存放第一个对象的地址，等于（slab起始地址 + slab的颜色偏移）。</span></p><h3 id='每处理器数组缓存'><span>每处理器数组缓存</span></h3><p><span>	</span><span>如下图所示，内存缓存为每处理器创建了 一个数组缓存（结构体array_cache）。释放对象时，把对象存放到当前处理器对应的数组缓存中；分配对象的时候，先从当前处理器的数组中分配对象，采用后进先出的原则，这种做法可以提高性能：</span></p><p><img src=".assets/094.png" alt="094" style="zoom:40%;" /></p><ul><li><p><strong><span>缓存过程：</span></strong></p><ol start='' ><li><p><span>刚释放的对象很可能还在处理器的缓存中，可以更好的利用处理器缓存；</span></p></li><li><p><span>减少链表的操作；</span></p></li><li><p><span>避免处理器之间的互斥，减少自旋锁的操作；</span></p></li></ol></li><li><p><span>结构体array_cache如下：</span></p><ol start='' ><li><p><span>entry：存放对象地址和数组；</span></p></li><li><p><span>avail：存放对象的数量；</span></p></li><li><p><span>limit：数组的大小，和结构体kmem_cache的limit值相同，根据对象长度猜测的一个值不是真实的；</span></p></li><li><p><span>batchcount：批量值，和kmem_cache的batchcount值相同，批量值是数组大小的一半。</span></p></li></ol></li></ul><p>&nbsp;</p><p><span>	</span><span>分配对象的时候，先从当前处理器缓存分配对象，如果数组缓存时空的，那么批量分配对象以重新填充数组缓存，批量值就是数组缓存的成员batchcount。</span></p><p><span>	</span><span>释放对象的时候，如果数组缓存时满的，那么先把数组缓存中的对象批量归还给slab，批量值就是数组缓存的成员batchcount，然后把正在释放的对象存放到数组缓存中。</span></p><h3 id='对numa的支持'><span>对NUMA的支持</span></h3><p><span>	</span><span>看下SLAB分配器是怎么支持NUMA系统。下图所示，内存缓存针对每个内存节点创建一个kmem_cache_node实例。</span></p><p><img src=".assets/095.png" alt="095" style="zoom:40%;" /></p><p><span>	</span><span>kmem_cache_node实例的成员shared指向共享数组缓存，成员alien指向远程节点数组缓存，每个节点一个远程节点数组缓存，这2个成员有什么作用？用来分阶段释放从其他节点借用的对象，先释放到远程节点数组缓存，然后转移到共享数组缓存，最后释放到远程节点的slab。</span></p><p><span>	</span><span>假设处理器0属于内存节点0，处理器1属于内存节点1。处理器0申请分配对象的时候，首先从节点0分配对象，如果分配失败，从节点1借用对象。</span></p><p><span>	</span><span>处理器0释放从节点1借用的对象时，需要把对象放到节点0的kemem_cache_node实例中域节点1对应的远程节点缓存数组中，先看是不是满了，如果满了，必须先清空，把对象转移到节点1的共享数组缓存中，如果节点1的共享数组缓存是满的，那马把剩下的对象知己释放到到slab。</span></p><p>&nbsp;</p><p><span>	</span><span>分配和释放本地内存节点的对象时，也会使用共享数组缓存。</span></p><p><span>	</span><span>1）申请分配对象时，如果当前处理器的数组缓存时空的，共享数组缓存里面的对象可以用来重填。</span></p><p><span>	</span><span>2）释放对象时，如果当前处理器的数组缓存时满的，并且共享数组缓存由空闲空间，那么可以转移一部分对象到共享数组缓存，不需要把对象批量归还给slab，然后把正在释放的对象添加到当前处理器的数组缓存中。</span></p><p><span>	</span></p><p><span>	</span><span>全局变量use_alien_caches用来控制是否使用远程节点数组缓存分节点释放从其他分配的对象，默认值是1，可以在引导内核时使用内核参数noaliencache指定。</span></p><p><span>	</span><span>当包括填充的对象长度不超过页长度的时候，使用共享数组缓存，数组大小时（kmem_cache.shared *kmem_cache.batchcount），kmem_cache.batchcount是批量值，kmem_cache.shared用来控制贡献数组缓存的大小，当前代码实现指定的值是8。</span></p><h3 id='内存缓存合并'><span>内存缓存合并</span></h3><p><span>	</span><span>为了减少内存开销和增加对象缓存热度，块分配器合并相似的内存缓存。在创建内存缓存的时候，从已经存在的内存缓存中找到一个相似的内存缓存，和原始的创建者共享这个内存缓存。3种分配器都支持内存缓存合并。</span></p><p><span>	</span><span>假设正在创建内存缓存t。</span></p><p><span>	</span><span>如果合并控制变量slab_nomerge的值是1，那么不能合并，默认值是0，如果想要进制合并，可以在引导内核的时候使用内核参数“slab_nomerge”指定。</span></p><p><span>	</span><span>如果t指定了对象构造函数，不能合并。</span></p><p><span>	</span><span>如果t设置了组织合并的标志位，那么不能合并， 阻止合并的标志位是调试和使用RCU技术延迟释放slab代码如下：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.5px; left: 33px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 29px; margin-bottom: 0px; border-right-width: 0px; min-width: 822.984375px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>2</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -29px; width: 29px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 20px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#define SLAB_NERVER_MERGE (SLAB_RED_ZONE | SLAB_POSION | SLAB_STORE_USER | SLAB_TRACE</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 20px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-operator">|</span> <span class="cm-variable">SLAB_TYPESAFE_BY_RCU</span> <span class="cm-operator">|</span> <span class="cm-variable">SLAB_NOLEAKTRACE</span> <span class="cm-operator">|</span> <span class="cm-variable">SLAB_FAILSLAB</span> <span class="cm-operator">|</span> <span class="cm-variable">SLAB_KASAN</span>)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 50px;"></div><div class="CodeMirror-gutters" style="height: 50px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 28px;"></div></div></div></div></pre><p><span>	</span><span>遍历每个内存缓存s，判断t是否可以和s合并：</span></p><p><span>	</span><span>1）如果s设置了阻止合并的标志位，那么不能合并；</span></p><p><span>	</span><span>2）如果s指定了对象构造函数，那么不能合并；</span></p><p><span>	</span><span>3）如果t的对象长度大于s的对象长度，那么不能合并；</span></p><p><span>	</span><span>4）如果t的下面4个标志位和s的不相同，那么不能合并；</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.5px; left: 33px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 29px; margin-bottom: 0px; border-right-width: 0px; min-width: 611.796875px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>2</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -29px; width: 29px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 20px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#define SLAB_MERGE_SAME ( SLAB_RECLAIM_ACCOUNT | SLAB_CACHE_DMA</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 20px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">|</span> <span class="cm-variable">SLAB_NOTRACE</span> <span class="cm-operator">|</span> <span class="cm-variable">SLAB_ACCOUNT</span>)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 50px;"></div><div class="CodeMirror-gutters" style="height: 50px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 28px;"></div></div></div></div></pre><p><span>	</span><span>5）如果对齐值不兼容，s的对象长度不是t的对齐值的整数倍，那么不能合并；</span></p><p><span>	</span><span>6）如果s的对象长度和t的对象长度差值大于或等于指针长度，那么不能合并；</span></p><p><span>	</span><span>7）SLAB分配器特有的检查项：如果t的对齐值不是0，并且t的对齐值大于s的对齐值，或者s的对齐值不是t的对齐值的整数倍，那么不能合并；</span></p><p><span>	</span><span>8）其余条件是可以合并的；</span></p><p>&nbsp;</p><p><span>	</span><span>找到可以合并的内存缓存以后，把引用计数加1，对象的原始长度取两者的最大值，然后把内存缓存的地址值返回给调用者。</span></p><h3 id='回收内存'><span>回收内存</span></h3><p><span>	</span><span>对于所有对象空闲的slab，没有立即释放，而是放在空闲的slab链表中，只有内存节点上空闲的对象的数量超过限制，才开始回收空闲的slab，直到空闲的数量小于或等于限制。</span></p><p><span>	</span><span>如下图所示，结构体kmem_cache_node成员slabs_free是空闲slab链表头节点，成员free_objects是空闲对象的数量，成员free_limit是空闲对象的数量限制。</span></p><p><img src=".assets/096.png" alt="096" style="zoom:40%;" /></p><p><span>	</span><span>节点n的空闲对象的数量限制 = （1+节点的处理器数量）* kmem_cache.batchcount + kmem_cache.num。</span></p><p><span>	</span><span>SLAB分配器定时回收对象和空闲的slab，实现方法是在每个处理器上项全局工作队列上添加1个延迟工作项，工作项的处理函数式cache_reap。</span><span>	</span></p><p><span>	</span><span>每个处理器每隔2秒针对每个内存缓存执行。</span></p><p><span>	</span><span>1）回收节点n（假设当前处理器属于节点n）对应的远程节点数组缓存中的对象；</span></p><p><span>	</span><span>2）如果过去2秒没有从当前处理器的数组缓存分配对象，那么回收住宿缓存中的对象；</span></p><p><span>	</span><span>每个处理器每隔4秒针对每个内存缓存执行：</span></p><p><span>	</span><span>1）如果过去4秒没有从共性数组缓存分配对象，need回收共享数组缓存中的对象；</span></p><p><span>	</span><span>2）如果过去4秒没有从空闲的slab分配对象 ，那么回收空闲的slab；</span></p><h3 id='调试'><span>调试</span></h3><p><span>	</span><span>出现内存改写时，我们需要定位出是谁改写的，SLAB分配器提供了调试功能，我们可以打开调试配置宏CONFIG_DEBUG_SLAB，此时对象增加3个字段，红色区域1、红色区域2、最后已给使用者。如下图所示：</span></p><p><img src=".assets/097.png" alt="097" style="zoom:40%;" /></p><p><span>	</span><span>分配对象时，把对象毒化：把最后1字节以外的每个字节设置为0x5a，把最后一个字节设置为0xa5；把对象前后的红色区域设置为宏RED_ACTIVE表示魔幻数；字段“最后一个使用者”保存调用函数地址。</span></p><p><span>	</span><span>释放对象时，检查对象：如果对象前后的红色区域都是宏RED_ACTIVE表示魔幻数，说明正常；如果对象前后的红色区域都是宏RED_INACTIVE表示的魔幻数，说明重复释放；其他情况，说明写越界。</span></p><p><span>	</span><span>释放对象时，把对象毒化：把最后1字节以外的每个字节设置为0x6b，把最后1字节设置为0xa5；把对象前后的红色区域设置为RED_INACTIVE，字段“最后一个使用者”保存调用函数的地址。</span></p><p><span>	</span><span>再次分配对象时，检查对象：如果对象不符合“最后1字节以外的每个字节是0x6b”，最后1字节是0xa5，说明对象被改写，如果对象前后的红色区域不是宏RED_INACTIVE表示的魔幻数，说明重复释放或者越界。</span></p><h2 id='四slub分配器'><span>四、SLUB分配器</span></h2><p><span>	</span><span>SLUB分配器集成了SLAB分配器的核心思想，在某些地方做了改进。</span><span>	</span></p><p><span>	</span><span>1）SLUB分配器的管理数据结构开销大，早期每个slab有一个描述符和跟在后面空闲对象数组。SLUB分配器把slab的管理信息保存在page结构中，使用联合体重用page结构体的成员，没有使用page结构体的大小增加。现在SLAB分配器反过来向SLUB分配器学习，抛弃了slab描述符，把slab的管理信息保存在了page结构体中。</span></p><p><span>	</span><span>2）SLAB分配器的链表多，分为空闲slab链表，部分空闲slab链表和慢slab链表，管理复杂。SLUB分配器只保留部分空闲slab链表。</span></p><p><span>	</span><span>3）SLAB分配器对NUMA系统的支持复杂，每个内存节点有贡献数据缓存和远程节点数组缓存，对象在这下数组缓存之间转移，实现复杂。SLUB分配器做了简化。</span></p><p><span>	</span><span>4）SLUB分配器抛弃了效果不明显的slab着色。</span></p><h3 id='数据结构-2'><span>数据结构</span></h3><p><span>	</span><span>SLUB分配器内存缓存的数据结构如下图所示：</span></p><p><img src=".assets/098.png" alt="098" style="zoom:40%;" /></p><ol start='' ><li><p><span>每个内存缓存区对应一个kmem_cache实例。</span></p></li></ol><p><span>	</span><span>成员size是包括元数据的对象长度，成员object_size是对象的原始长度。</span></p><p><span>	</span><span>成员oo存放最优slab的阶数和对象数，低16位是对象数，高16位是slab的阶数，即oo等于（slab的阶数 &lt;&lt; 16  | 对象数），格式和oo相同。最小slab只需要足够存放一个对象，当设备长时间运行以后，内存碎片化，分配连续物理页很难成功，如果分配最优slab失败，就分配最小slab。</span></p><ol start='2' ><li><p><span>每个内存节点对应一个kmem_cache_node实例。</span></p></li></ol><p><span>	</span><span>链表partial把部分空闲的slab链接起来，成员nr_partial是部分空闲的slab的数量。</span></p><p>&nbsp;</p><ol start='3' ><li><p><span>每个slab由一个或多个连续的物理页组成，页的阶数时最优slab或最小slab的阶数，如果阶数大于0，组成一个复合页。</span></p></li></ol><p><span>	</span><span>slab被划分成多个对象， 如果slab的长度不是对象长队的整数倍，尾部由剩余部分。尾部也可能由保留部分，kmem_cache实例的成员reserved存放保留长度。</span></p><p><span>	</span><span>在创建内存缓存的时候，如果指定标志位SLAB_TYPEAFE_BY_RCU，要求使用RCU延迟释放slab，在调用函数call_rcu把释放slab的函数加入RCU回调函数队列的时候，需要提供一个rcu_head实例，slab提供的rcu_head实例的位置分两种情况。</span></p><p><span>	</span><span>1）如果page结构体的成员lru的长度大于或等于rcu_head结构体的长度，那么重用成员lru。</span></p><p><span>	</span><span>2）如果page结构体的成员lru的长度小于rcu_head结构体的长度，那么必须在slab尾部为rcu_head结构体成员保留空间，保留长度是rcu_head结构体的长度。</span></p><p>&nbsp;</p><p><span>	</span><span>page结构体相关成员如下：</span></p><p><span>	</span><span>1）成员flags设置表位PG_slab，表示页属于SLUB分配器。</span></p><p><span>	</span><span>2）成员freelist指向第一个空闲对象。</span></p><p><span>	</span><span>3）成员inuse表示已分配对象的数量。</span></p><p><span>	</span><span>4）成员objects是对象数量。</span><span>	</span></p><p><span>	</span><span>5）成员frozen表示slab是否被冻结在每处理器slab缓存中。如果slab在每处理器slab缓存中，它处于同届状态；如果slab在内存节点的部分空闲slab链表中，它处于解冻状态。</span></p><p><span>	</span><span>6）成员lru作为链表节点加入部分空闲slab链表。</span></p><p><span>	</span><span>7）成员slab_cache指向kmem_cache实例。</span></p><ol start='4' ><li><p><span>kmem_cahce实例的成员cpu_slab指向kmem_cache_cpu实例，每个处理器对应一个kmem_cache_cpu实例，称为每处理器slab缓存。</span></p></li></ol><p><span>	</span><span>SLAB分配器的每处理器数组缓存以对象为单位，而SLUB分配器的每处理器slab缓存以slab为单位。</span></p><p><span>	</span><span>成员freelist指向当前使用的slab的空闲对象链表，成员page指向当前使用的slab对象的page实例，程媛媛partial指向每处理器部分空闲slab链表。</span></p><p><span>	</span><span>对象有2种内存布局，区别是空闲指针的位置不同。</span></p><p><span>	</span><span>第一种内存布局如下图所示，空闲指针在红色区域2的后面：</span></p><p><img src=".assets/099.png" alt="099" style="zoom:40%;" /></p><p><span>	</span><span>第二种内存布局如下图所示，空闲指针重用真实对象的第一个字。</span></p><p><img src=".assets/100.png" alt="100" style="zoom:40%;" /></p><p><span>	</span><span>kmem_cache.offset是空闲指针的偏移，空闲指针的地址等于 真实对象的地址 + 空闲指针偏移。</span></p><p><span>	</span><span>当红色区域1的长度 = kmem_cache.red_lef_pad = 字长对齐的指定的对齐值。</span></p><p><span>	</span><span>红色区域2的长度 = 字长 - （对象长度 % 字长）</span></p><p><span>	</span><span>当开启SLUB分配器的调试配置宏CONFIG_SLUB_DEBUG的时候，对象才包含红色区域1、红色区域2、分配用户跟踪和释放用户跟踪这4个成员。</span></p><p><span>	</span><span>以下3种情况下选择第一种内存布局：</span></p><p><span>	</span><span>1）指定构造函数；</span></p><p><span>	</span><span>2）指定标志位SLAB_TYPESAFE_BY_RCU，要求适应RCU延迟释放slab；</span></p><p><span>	</span><span>3）指定标志位SLAB_POISON，要求毒化对象；</span></p><p><span>	</span><span>其他情况使用第二重内存布局。</span></p><h3 id='空闲对象链表-2'><span>空闲对象链表</span></h3><p><span>	</span><span>以对象使用第一种内存为例说明，一个slab空闲对象链表的初始化状态如下图所示，page-&gt;freelist指向第一个空闲对象中的真实对象，前一个空闲对象中的空闲指针指向后一个空闲对象中的真实对象，前一个空闲对象中的空闲指针指向后一个空闲对象的真实对象，最后一个空闲对象中的空闲指针是空指针。如果打开了SLAB空闲链表随机配置宏CONFIG_SLAB_FREELIST_RANDOM，每个对象在空闲对象链表中的位置都是随机的。</span></p><p><img src=".assets/101.png" alt="101" style="zoom:40%;" /></p><p><span>	</span><span>分配一个对象后，page-&gt;freelist指向下一个空闲对象中的真实对象，空闲对象链表如下所示：</span></p><p><img src=".assets/102.png" alt="102" style="zoom:40%;" /></p><h3 id='计算slab长度-2'><span>计算slab长度</span></h3><p><span>	</span><span>SLUB分配器在创建内存缓存的 时候计算了2种slab长度：最优slab和最小slab。最优slab时剩余部分比例最小的slab，最小slab只需要足够存放一个对象。当设备长时间运行后，内存碎化，分配连续物理页很难成功，如果分配最优slab失败，就分配最小的slab。</span></p><p><span>	</span><span>计算最优slab的长度时，有3个重要的控制参数。</span></p><p><span>	</span><span>1）slub_min_objects：slab的最小对象数量，默认值是0，可以在引导内核时使用内核参数”slub_min_bjects“设置。</span></p><p><span>	</span><span>2）slub_min_order：slab的最小阶数，默认值是0，可以在引导内核时使用内核参数”slub_min_order“设置。</span></p><p><span>	</span><span>3）slub_max_order：slab的最大阶数，默认值是页默认分配器认为昂贵的阶数3，可以在引导内核时使用内核参数，”slub_max_order“设置。</span></p><p><span>	</span><span>函数caculate_order负责计算最优slab的长度，其算法如下：</span></p><blockquote><p><strong><span>第1步：</span></strong><span>计算最小对象数量min_objects。</span></p><p><span>	</span><span>取控制参数slub_min_objects。</span></p><p><span>	</span><span>如果控制参数slub_min_objects是0，那么根据处理器梳理估算一个值，min_objects = 4 * (fls(nr_cpu_ids) + 1)，nr_cpu_ids是处理器数量，函数fls用来获取被设置的最高位，假设有16个处理器，fls(16)的结果是5。最小对象数量不能超过根据最大阶数slub_max_order计算出来的最大对象数量。</span></p><p><strong><span>第2步：</span></strong><span>尝试把多个对象放在一个slab中。</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.5px; left: 42px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 38px; margin-bottom: 0px; border-right-width: 0px; min-width: 728.920166015625px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -38px; width: 38px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">while</span>(<span class="cm-variable">最小对象数量min_obejcts</span>  <span class="cm-operator">&gt;</span> <span class="cm-number">1</span>) {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">slab剩余部分比例fraction取16，是倒数值。</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-keyword">while</span>(<span class="cm-variable">剩余部分比例fractions</span> <span class="cm-operator">&gt;=</span> <span class="cm-number">4</span>){</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">   <span class="cm-variable">调用函数slab_order</span>(<span class="cm-variable">对象长度size</span>, <span class="cm-variable">最小数量min_obejcts</span>, <span class="cm-variable">最大阶数slub_max_order</span>,</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">                     <span class="cm-variable">剩余部分比例fraction</span>, <span class="cm-variable">保留长度reserved</span>)<span class="cm-variable">计算阶数。</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">   <span class="cm-variable">如果算出的结束不超过最大阶数slub_max_order，那么返回这个阶数。</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">   <span class="cm-variable">把剩余部分比例fatction</span> <span class="cm-operator">/</span> <span class="cm-number">2</span>  <span class="cm-variable">在重试</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">12</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-variable">把最小对象数量min_objects减1，然后重试。</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">13</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 325px;"></div><div class="CodeMirror-gutters" style="height: 325px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 37px;"></div></div></div></div></pre><p><strong><span>第3步：</span></strong><span>如果不能把多个对象放在䘝slab中，那么尝试把一个对象放在一个slab中，先尝试最大阶数取控制参数slub_max_order：最小对象数量取1，剩余部分比例取去，调用函数slab_order计算阶数，如果阶数不超过slub_max_order，那么返回这个数。</span></p><p><span>	</span><span>然后尝试最大阶数MAX_ORDER(页分配器支持的最大阶数时MAX_ORDER - 1)：最小对象数量取1，剩余部分鼻梁取1，大勇函数slab_order计算阶数，如果阶数小于MAX_ORDER，那么返回这个阶数。</span></p></blockquote><p><span>	</span><span>函数slab_order负责计算阶数，输入参数是（对象长度size，最小对象数量min_objects，最大阶数max_order，剩余部分比例fraction，保留长度reserved）算法如下：</span></p><blockquote><p><span>	</span><span>如果最小slab的对象数量已经超过每页最大对象数量（宏MAX_OBJS_PER_PAGE）(32767)，那么slab长度取（对象长度 * 每页最大对象数量）向上对线期到2</span><sup><span>n</span></sup><span>页的长度，然后取一半，slab阶数时（get_order(对象长度 * 每页最大对象数量) - 1），函数get_order用来获得内存长度的分配阶。</span></p><p><span>	</span><span>最小阶数min_order从slab最小阶数slub_min_order和根据最小对象数量min_objects算出slab阶数中取最大值。</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.5px; left: 33px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 29px; margin-bottom: 0px; border-right-width: 0px; min-width: 497.546875px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>5</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -29px; width: 29px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 20px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">从最小阶数min_order的最大阶数max_order尝试</span>{</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 20px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">slab长度</span> <span class="cm-operator">=</span> <span class="cm-variable">页长度左移阶数位</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 20px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">剩余长度</span> <span class="cm-operator">=</span> <span class="cm-variable">（slab长度</span> <span class="cm-operator">-</span> <span class="cm-variable">保留长度）</span> <span class="cm-operator">/</span> <span class="cm-variable">对象长度取余数</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 20px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">如果剩余部分比例不超过上限（1</span> <span class="cm-operator">/</span> <span class="cm-variable">fraction），那么取这个阶数</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 20px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 125px;"></div><div class="CodeMirror-gutters" style="height: 125px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 28px;"></div></div></div></div></pre></blockquote><h3 id='每处理器slab缓存'><span>每处理器slab缓存</span></h3><p><span>	</span><span>SLAB分配器的每处理器缓存以对象为单位，而SLUB分配器的每处理器缓存以slab为单位。</span></p><p><span>	</span><span>如下图所示，内存缓存为每个处理器创建一个slab缓存。</span></p><p><img src=".assets/103.png" alt="103" style="zoom:40%;" /></p><ul><li><p><strong><span>结构说明：</span></strong></p><ol start='' ><li><p><span>使用结构体kmem_cache_cpu描述slab缓存，成员page指向当前使用的slab对应的page实例，成员freelist指向空闲对象链表，成员partial指向部分空闲slab链表。</span></p></li><li><p><span>当前使用的slab对应的page实例：成员forzen的值为1，表示当前slab被冻结在每处理器slab缓存中，成员freelist被设置为空指针。</span></p></li><li><p><span>部分空闲slab链表：只有打开配置宏CONFIG_SLUB_CPU_PARTIAL，才会使用部分空闲slab链表（如果大考了调试配置宏CONFIG_SLUB_DEBUF，还要求没有设置slab调试标志位），目前默认打开了这个配置宏。为了和内存节点的空闲slab链表区分，我们把每处理器slab缓存中的空闲slab链表称为每处理器空闲slab链表。</span></p><p><span>链表中每个slab对应的page实例的成员frozen的值为1，表示slab被冻结在每处理器slab缓存中；成员next指向下一个slab对应的page实例。</span></p><p><span>  链表中第一个slab对应的page实例的成员pages存放链表中slahb的数量，成员pobjects存放链表中空闲对象数量，后面的slab没有使用这2个成员。</span></p><p><span>  kmem_cache实例的成员cpu_patial决定了链表中空闲对象的最大数量，是根据对象长度估算的值。</span></p><p><span>  </span></p></li></ol></li></ul><p><span>	</span><span>分配对象时，首先从当前处理器的slab缓存分配，如果当前有一个slab正在使用并且有空闲对象，那么分配一个对象；如果slab缓存中的部分空闲slab链表是不空的，那么取第一个slab作为当前使用的slab；其他情况下，需要慎重填充当前处理器的slab缓存。</span></p><p><span>	</span><span>1）如果内存节点的部分空闲slab链表，直到取第一个slab作为当前使用的slab，并且重填slab缓存中的部分空闲slab链表，直到取出所有slab的空闲对象总数超过限制kmem_cache.cpu_partial的一半为止。</span><span>	</span></p><p><span>	</span><span>2）否则，创建一个新的slab，作为当前使用的slab。</span></p><p>&nbsp;</p><p><span>	</span><span>什么情况下会把slab存放到每处理器部分空闲slab链表中？</span></p><p><span>	</span><span>释放对象的时候看，如果对象所属的slab以前没有空闲对象，并且没有冻结在每处理器slab缓存中，那么把slab存放到当前处理器的部分空闲slab链表中。如果发现当前处理器的部分空闲slab归还到内存节点的部分空闲slab链表中。</span></p><p><span>	</span><span>这种做法的好处是：把空闲对象非常少的slab放在每处理器空闲slab链表中，优先从空闲对象非常少的slab分配对象，减少内存浪费。</span></p><h3 id='对numa的支持-2'><span>对NUMA的支持</span></h3><p><span>	</span><span>1）内存缓存针对每个内存节点创建一个kmem_cache实例。</span></p><p><span>	</span><span>2）分配对象时，如果当前处理器的slab缓存时空的，需要重填当前处理器slab缓存。首先从本地内存节点部分空闲slab链表中取slab，如果本地内存节点的部分空闲slab链表是空的，那么从其他内存节点的部分空闲slab链表借用slab。</span></p><p>&nbsp;</p><p><span>	</span><span>kmem_cache实例的成员remote_node_defrag_ratio称为远程节点反碎片比例，用来控制从远程节点借用部分空闲slab和从本地节点取部分空闲slab的比例，值越小，从本地节点取部分空闲slab的倾向越大。默认值1000，可以通过文件”/sys/kernel/slab/&lt;内存缓存名称&gt;/remote_node_defrag_ratio“设置某个内存缓存的远程节点反碎片比例，用户设置的范围是[0,100]，内存缓存保存的比例值是乘以10以后得值。</span></p><p><span>	</span><span>函数get_any_partial负责从其他内存节点借用部分空闲slab算法如下：</span></p><blockquote><p><span>	</span><span>如果远程节点反碎片比例是0，或者当前处理器的时钟周期计数值除以1024的以大于远程节点反碎片比例，那么不允许从其他节点借用部分空闲的slab。</span></p><p><span>	</span><span>从当前进程的NUMA内存策略取内存节点。</span></p><p><span>	</span><span>从内存节点取备用区域列表。</span></p><p><span>	</span><span>遍历备用区域列表的每个目标区域{</span></p><p><span>		</span><span>如果(cpuset允许当前进程从目标内存节点分配内存，并且目标内存节点的部分空闲slab数量大于 最小部分空闲slab数量 kmem_cache.min_partial)</span></p><p><span>			</span><span>从目标内存节点借用部分空闲slab</span></p><p><span>			</span><span>返回</span></p><p><span>    }</span></p></blockquote><h3 id='回收内存-2'><span>回收内存</span></h3><p><span>	</span><span>对于所有对象的slab，如果内存节点的部分空闲slab数量大于或等于最小部分空闲slab数量，那么直接释放，否则在部分空闲slab链表的尾部。</span></p><p><span>	</span><span>最小部分空闲slab数量kmem_cache.min_partial的计算方法是：</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="9.336ex" height="3.078ex" role="img" focusable="false" viewBox="0 -1015.3 4126.7 1360.3" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.781ex;"><defs><path id="MJX-6-TEX-I-1D459" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"></path><path id="MJX-6-TEX-I-1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path><path id="MJX-6-TEX-I-1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"></path><path id="MJX-6-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mfrac"><g data-mml-node="mrow" transform="translate(220,485) scale(0.707)"><g data-mml-node="mi"><use data-c="1D459" xlink:href="#MJX-6-TEX-I-1D459"></use></g><g data-mml-node="mi" transform="translate(298,0)"><use data-c="1D45C" xlink:href="#MJX-6-TEX-I-1D45C"></use></g><g data-mml-node="msub" transform="translate(783,0)"><g data-mml-node="mi"><use data-c="1D454" xlink:href="#MJX-6-TEX-I-1D454"></use></g><g data-mml-node="mn" transform="translate(510,-150) scale(0.707)"><use data-c="32" xlink:href="#MJX-6-TEX-N-32"></use></g></g><g data-mml-node="mtext" transform="translate(1696.6,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">对</text></g><g data-mml-node="mtext" transform="translate(2575.9,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">象</text></g><g data-mml-node="mtext" transform="translate(3455.1,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">长</text></g><g data-mml-node="mtext" transform="translate(4334.4,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">度</text></g></g><g data-mml-node="mn" transform="translate(1886.6,-345) scale(0.707)"><use data-c="32" xlink:href="#MJX-6-TEX-N-32"></use></g><rect width="3886.7" height="60" x="120" y="220"></rect></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mfrac><mrow><mi>l</mi><mi>o</mi><msub><mi>g</mi><mn>2</mn></msub><mtext>对</mtext><mtext>象</mtext><mtext>长</mtext><mtext>度</mtext></mrow><mn>2</mn></mfrac></math></mjx-assistive-mml></mjx-container><script type="math/tex">\frac{log_2 对象长度}{2}</script><span>，并且把范围限制在[5,10]。</span></p><h3 id='调试-2'><span>调试</span></h3><p><span>	</span><span>如果我们需要使用SLUB分配器的调试功能，首先需要打开调试配置宏CONFIG_DEBUG_SLUB，然后又2种选择：</span></p><p><span>	</span><span>1）打开配置宏CONFIG_SLUB_DEBUG_ON，为所有内存缓存打开所有调试选项。</span></p><p><span>	</span><span>2）在引导内核时使用内核参数”slub_debug“。</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.5px; left: 33px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 29px; margin-bottom: 0px; border-right-width: 0px; min-width: 343px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>4</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -29px; width: 29px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 20px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 为所有内存缓存打开调试选项</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 20px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">slub_debug</span> <span class="cm-operator">=</span> <span class="cm-operator">&lt;</span><span class="cm-variable">调试选项</span><span class="cm-operator">&gt;</span> </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 20px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 只有指定的内存缓存打开调试选项</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 20px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">slub_debug</span> <span class="cm-operator">=</span> <span class="cm-operator">&lt;</span><span class="cm-variable">调试选型</span><span class="cm-operator">&gt;</span>,<span class="cm-operator">&lt;</span><span class="cm-variable">内存缓存名称</span><span class="cm-operator">&gt;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 100px;"></div><div class="CodeMirror-gutters" style="height: 100px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 28px;"></div></div></div></div></pre><p><span>	</span><span>调试选项如下所示：</span></p><p><span>	</span><span>1）F：在分配和释放时执行昂贵的一致性检查（对应标志SLAB_CONSISTENCY+CHECKS）</span></p><p><span>	</span><span>2）Z：红色区域（对应标志位SLAB_RED_ZONE）</span></p><p><span>	</span><span>3）P：毒化对象（对应标志位SLAB_POSION）</span></p><p><span>	</span><span>4）U：分配/释放用户跟踪（对应标志位SLAB_STORE_USER）</span></p><p><span>	</span><span>5）T：跟踪分配和释放（对应标志位SLAB_TRACE），只在一个内存缓存上使用</span></p><p><span>	</span><span>6）A：注入分配对象失败的错误（对应标志位SLAB_FAILSLAB，需要把打开配置宏CONFIG_FAILSLAB）</span></p><p><span>	</span><span>7）O：为可能导致更高的最小slab阶数的内存缓存关闭调试</span></p><p><span>	</span><span>8）-：关闭所有调试选项，在内核配置了CONFIG_SLUB_DEBUG_ON时有用处。</span></p><p><span>	</span><span>如果没有指定调试选型（即”sub_debug=“），表示打开所有调试选项。</span></p><h2 id='五slob分配器'><span>五、SLOB分配器</span></h2><p><span>	</span><span>SLOB分配器最大的特点就是简洁，代码只有600多行，特别适合小内存的嵌入式设备。</span></p><h3 id='数据结构-3'><span>数据结构</span></h3><p><span>	</span><span>SLOB分配器内存缓存的数据结构如下图所示：</span></p><p><img src=".assets/104.png" alt="104" style="zoom:40%;" /></p><ol start='' ><li><p><span>每个内存缓存对应一个kmem_cache实例；</span></p><p><span>成员object_size是对象原始长度，成员size是包括填充的对象长度，align是对齐值。</span></p></li><li><p><span>所有内存缓存共享slab，所有对象长度小于256字节的内存缓存共享小对象slab，所有对象长度小于1024字节的内存缓存对象共享中等对象slab链表中的slab，所有对象小于1页的内存缓存烘箱大对象中的slab链表中的slab。对象长度大于或等于1页的内存花奴采暖，直接从页分配器分配页不需要经过SLOB分配器。</span></p><p><span>每个slab的长度是一页，page结构体的行管成员如下：</span></p><ol start='' ><li><p><span>成员flags设置标志位PG_slab，表示属于SLOB分配器；设置标志位PG_slob_free，表示slab在slab链表中。</span></p></li><li><p><span>成员freelist指向第一个空闲对象。</span></p></li><li><p><span>成员units表示空闲对象。</span></p></li><li><p><span>成员lru作为链表节点加入slab链表。</span></p></li></ol><p><span>SLOB分配器的分配粒度时单元，也就是说，分配长度必须是单元的整数倍，单元是数据类型slobidx_t的长度，通常是2字节，数据类型slobidx_t的定义如下：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.5px; left: 33px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 29px; margin-bottom: 0px; border-right-width: 0px; min-width: 285.390625px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>7</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -29px; width: 29px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 20px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 位置：mm/slob.c</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 20px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 20px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#if PAGE_SIZE  &lt;= (32767 * 2)</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 20px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">typedef</span> <span class="cm-variable">s16</span> <span class="cm-variable">slobidx_t</span> </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 20px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#else</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 20px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-keyword">typedef</span> <span class="cm-variable">s32</span> <span class="cm-variable">slobidx_t</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 20px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#endif</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 175px;"></div><div class="CodeMirror-gutters" style="height: 175px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 28px;"></div></div></div></div></pre></li></ol><h3 id='空闲对象链表-3'><span>空闲对象链表</span></h3><p><span>	</span><span>来看下SLOB是怎么组织空闲对象，在SLOB分配器中，对象更准确的说法是（block），因为多个对象长度不同的内存缓存从同一个slab&#39;分配对象，一个slab可能出现大小不同的快。</span></p><p><span>	</span><span>空闲的内存布局分为如下2种情况：</span></p><p><span>	</span><span>1）对于长度大于一个单元的块，第一个单元存放快长度，第二个单元存放下一个空闲块的偏移；</span></p><p><span>	</span><span>2）对于只有一个单元的快，该单元存放下一个空闲块的偏移的相反数，就是第一个负数；</span></p><p><span>	</span><span>长度和偏移都是单元数量，偏移是基准是页的起始地址。</span></p><p><span>	</span><span>已经分配出去的块：如果使用kmalloc()从通用内存分配的快，使用块前面的4字节存放申请的字节数，因为使用kfree()释放时需要知道块的长度，如果是从专用内存缓存分配的快，从kmem_cache结构体的成员size可以知道块的长度。</span></p><p><span>	</span><span>假设页长度是4KB，单元是2字节，一个slab的空闲对象链表的初始状态如下图所示：slab只有一个空闲块，第一个单元存放长度是2048，第二个单元存放下一个空闲块的偏移是2048，slab对应的page结构体的成员freelist指向第一个空闲块，成员units存放空闲单元数量2048。</span></p><p><img src=".assets/105.png" alt="105" style="zoom:40%;" /></p><p><span>	</span><span>假设已给对象长度是32字节的内存缓存从这个slab分配了一个对象，空闲对象链表如下图所示，slab的前面32字节被分配，空闲块从第32字节开始，第一个单元存放长度2032，第二个单元存放下一个空闲块的偏移2048，slab对应的page结构体的成员freelist指向这个空闲块，成员units存放空闲单元数量2032。</span></p><p><img src=".assets/106.png" alt="106" style="zoom:40%;" /></p><h3 id='分配对象'><span>分配对象</span></h3><p><span>	</span><span>分配对象时，根据对象长度选择不同的策略。</span></p><p><span>	</span><span>1）如果对象长度小于256字节，那么从小对象slab链表中查找slab分配。</span></p><p><span>	</span><span>2）如果对象长度小于1024字节，那么从中对象slab链表中查找slab分配。</span></p><p><span>	</span><span>3）如果长度小于1页，那么从大对象slab链表中查找slab分配。</span></p><p><span>	</span><span>4）如果对象长度大于等于1页，那么从页分配分配器，不需要经过SLOB分配器。</span></p><p><span>	</span><span>对于前面3种请款个，遍历slab链表，对于空闲单元数量（page.units）大于或等于对象长度的slab，遍历空闲对象链表，当找到一个何时的空闲块时，处理方法是：如果空闲块的长度等于对象长度，那么把这个空闲块从空闲对象链表中删除；如果空闲块的长度大于对象长度，那么把这个空闲块分配成2部分，一部分分配出去，剩下部分放在空闲对象链表中。</span></p><p><span>	</span><span>如果分配对象以后，slab的空闲单元数量变成零，那么从slab链表中删除，并且清除标志位PG_slob_free。</span></p><p><span>	</span><span>为了减少平均查找时间，从某个slab分配对象以后，把slab链表的头部移到这个slab的前面，下一次分配对象的时候从这个slab开始查找。</span></p><p><span>	</span><span>如果变脸slab链表，没有找到合适的空闲块，就会创建新的slab。</span></p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p></div></div>

<script>(function (){var e=document.body.parentElement,t=[],n=null,i=document.body.classList.contains("typora-export-collapse-outline"),r=function(e,t,n){document.addEventListener(e,function(e){if(!e.defaultPrevented)for(var i=e.target;i&&i!=this;i=i.parentNode)if(i.matches(t)){!1===n.call(i,e)&&(e.preventDefault(),e.stopPropagation());break}},!1)};function o(){return e.scrollTop}r("click",".outline-expander",function(e){var t=this.closest(".outline-item-wrapper").classList;return t.contains("outline-item-open")?t.remove("outline-item-open"):t.add("outline-item-open"),d(),!1}),r("click",".outline-item",function(e){var t=this.querySelector(".outline-label");if(location.hash="#"+t.getAttribute("href"),i){var n=this.closest(".outline-item-wrapper").classList;n.contains("outline-item-open")||n.add("outline-item-open"),c(),n.add("outline-item-active")}});var a,s,l=function(){var e=o();n=null;for(var i=0;i<t.length&&t[i][1]-e<60;i++)n=t[i]},c=function(){document.querySelectorAll(".outline-item-active").forEach(e=>e.classList.remove("outline-item-active")),document.querySelectorAll(".outline-item-single.outline-item-open").forEach(e=>e.classList.remove("outline-item-open"))},d=function(){if(n){c();var e=document.querySelector('.outline-label[href="#'+(CSS.escape?CSS.escape(n[0]):n[0])+'"]');if(e)if(i){var t=e.closest(".outline-item-open>ul>.outline-item-wrapper");if(t)t.classList.add("outline-item-active");else{for(var r=(e=e.closest(".outline-item-wrapper")).parentElement.closest(".outline-item-wrapper");r;)r=(e=r).parentElement.closest(".outline-item-wrapper");e.classList.add("outline-item-active")}}else e.closest(".outline-item-wrapper").classList.add("outline-item-active")}};window.addEventListener("scroll",function(e){a&&clearTimeout(a),a=setTimeout(function(){l(),d()},300)});var u=function(){s=setTimeout(function(){!function(){t=[];var e=o();document.querySelector("#write").querySelectorAll("h1, h2, h3, h4, h5, h6").forEach(n=>{var i=n.getAttribute("id");t.push([i,e+n.getBoundingClientRect().y])})}(),l(),d()},300)};window.addEventListener("resize",function(e){s&&clearTimeout(s),u()}),u()})();</script></body>
</html>