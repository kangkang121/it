<!doctype html>
<html style='font-size:16px !important'>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>

<link href='https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap' rel='stylesheet' type='text/css' /><style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color: #ffffff; --text-color: #333333; --select-text-bg-color: #B5D6FC; --select-text-font-color: auto; --monospace: "Lucida Console",Consolas,"Courier",monospace; --title-bar-height: 20px; }
.mac-os-11 { --title-bar-height: 28px; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
h1, h2, h3, h4, h5 { white-space: pre-wrap; }
body { margin: 0px; padding: 0px; height: auto; inset: 0px; font-size: 1rem; line-height: 1.42857143; overflow-x: hidden; background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; tab-size: 4; background-position: inherit; background-repeat: inherit; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; word-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 36px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font-family: inherit; font-size: inherit; font-style: inherit; font-variant-caps: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
thead, tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right-width: 0px; background-color: inherit; }
.CodeMirror-linenumber { -webkit-user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; position: relative !important; background-position: inherit; background-repeat: inherit; }
.md-fences-adv-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
svg { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; background-position: 0px 0px; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li blockquote { margin: 1rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; border-color: transparent !important; padding-top: 0px !important; padding-bottom: 0px !important; }
  .typora-export * { print-color-adjust: exact; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
  #write > p:nth-child(1) { margin-top: 0px; }
  .typora-export-show-outline .typora-export-sidebar { display: none; }
  figure { overflow-x: visible; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background-color: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
.MathJax_ref { fill: currentcolor; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.reversefootnote { font-family: ui-monospace, sans-serif; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background-color: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.6; font-family: var(--monospace); }
code { text-align: left; }
a.md-print-anchor { white-space: pre !important; border: none !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; text-shadow: initial !important; background-position: 0px 0px !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom-width: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
mark { background-color: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
.md-expand mark .md-meta { opacity: 0.3 !important; }
mark .md-meta { color: rgb(0, 0, 0); }
@media print {
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}
.md-diagram-panel .messageText { stroke: none !important; }
.md-diagram-panel .start-state { fill: var(--node-fill); }
.md-diagram-panel .edgeLabel rect { opacity: 1 !important; }
.md-fences.md-fences-math { font-size: 1em; }
.md-fences-advanced:not(.md-focus) { padding: 0px; white-space: nowrap; border: 0px; }
.md-fences-advanced:not(.md-focus) { background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; background-position: inherit; background-repeat: inherit; }
.typora-export-show-outline .typora-export-content { max-width: 1440px; margin: auto; display: flex; flex-direction: row; }
.typora-export-sidebar { width: 300px; font-size: 0.8rem; margin-top: 80px; margin-right: 18px; }
.typora-export-show-outline #write { --webkit-flex: 2; flex: 2 1 0%; }
.typora-export-sidebar .outline-content { position: fixed; top: 0px; max-height: 100%; overflow: hidden auto; padding-bottom: 30px; padding-top: 60px; width: 300px; }
@media screen and (max-width: 1024px) {
  .typora-export-sidebar, .typora-export-sidebar .outline-content { width: 240px; }
}
@media screen and (max-width: 800px) {
  .typora-export-sidebar { display: none; }
}
.outline-content li, .outline-content ul { margin-left: 0px; margin-right: 0px; padding-left: 0px; padding-right: 0px; list-style: none; overflow-wrap: anywhere; }
.outline-content ul { margin-top: 0px; margin-bottom: 0px; }
.outline-content strong { font-weight: 400; }
.outline-expander { width: 1rem; height: 1.428571429rem; position: relative; display: table-cell; vertical-align: middle; cursor: pointer; padding-left: 4px; }
.outline-expander::before { content: ""; position: relative; font-family: Ionicons; display: inline-block; font-size: 8px; vertical-align: middle; }
.outline-item { padding-top: 3px; padding-bottom: 3px; cursor: pointer; }
.outline-expander:hover::before { content: ""; }
.outline-h1 > .outline-item { padding-left: 0px; }
.outline-h2 > .outline-item { padding-left: 1em; }
.outline-h3 > .outline-item { padding-left: 2em; }
.outline-h4 > .outline-item { padding-left: 3em; }
.outline-h5 > .outline-item { padding-left: 4em; }
.outline-h6 > .outline-item { padding-left: 5em; }
.outline-label { cursor: pointer; display: table-cell; vertical-align: middle; text-decoration: none; color: inherit; }
.outline-label:hover { text-decoration: underline; }
.outline-item:hover { border-color: rgb(245, 245, 245); background-color: var(--item-hover-bg-color); }
.outline-item:hover { margin-left: -28px; margin-right: -28px; border-left-width: 28px; border-left-style: solid; border-left-color: transparent; border-right-width: 28px; border-right-style: solid; border-right-color: transparent; }
.outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before { display: none; }
.outline-item-open > .outline-item > .outline-expander::before { content: ""; }
.outline-children { display: none; }
.info-panel-tab-wrapper { display: none; }
.outline-item-open > .outline-children { display: block; }
.typora-export .outline-item { padding-top: 1px; padding-bottom: 1px; }
.typora-export .outline-item:hover { margin-right: -8px; border-right-width: 8px; border-right-style: solid; border-right-color: transparent; }
.typora-export .outline-expander::before { content: "+"; font-family: inherit; top: -1px; }
.typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before { content: "−"; }
.typora-export-collapse-outline .outline-children { display: none; }
.typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children { display: block; }
.typora-export-no-collapse-outline .outline-expander::before { content: "" !important; }
.typora-export-show-outline .outline-item-active > .outline-item .outline-label { font-weight: 700; }
.md-inline-math-container mjx-container { zoom: 0.95; }
mjx-container { break-inside: avoid; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; background-position: inherit; background-repeat: inherit; }
.CodeMirror-scroll { overflow: auto hidden; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right-width: 1px; border-right-style: solid; border-right-color: rgb(221, 221, 221); background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; white-space: nowrap; background-position: inherit; background-repeat: inherit; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; background-position: inherit; background-repeat: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; background-position: inherit; background-repeat: inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; outline: 0px; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: auto hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 10px; z-index: 3; overflow-y: hidden; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; border: none !important; background-position: 0px 0px !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-radius: 0px; border-width: 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; word-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; background-position: 0px 0px; }
.CodeMirror-wrap pre { word-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right-width: 30px; border-right-style: solid; border-right-color: transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right-style: none; width: auto; }
.CodeMirror-linebackground { position: absolute; inset: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right-style: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background-color: rgba(255, 255, 0, 0.4); }
span.cm-underlined { text-decoration: underline; }
span.cm-strikethrough { text-decoration: line-through; }
.cm-tw-syntaxerror { color: rgb(255, 255, 255); background-color: rgb(153, 0, 0); }
.cm-tw-deleted { text-decoration: line-through; }
.cm-tw-header5 { font-weight: 700; }
.cm-tw-listitem:first-child { padding-left: 10px; }
.cm-tw-box { border-style: solid; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-color: inherit; border-top-width: 0px !important; }
.cm-tw-underline { text-decoration: underline; }
@media print {
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


/*快速自定义配置*/
:root {
    --monospace: "JetBrains Mono", "Fira Code", "Cascadia Code", Menlo, "Ubuntu Mono", Consolas, HYZhengYuan; /*代码字体*/
    --text-font: var(--monospace); /*正文字体*/
    --title-font: var(--monospace); /*标题字体*/
    --latex-font: var(--monospace); /*LaTeX字体(不含英语)*/
    --text-line-height: 1.6; /*正文行间距*/
    --code-line-height: 1.6; /*代码块行间距*/
    --p-spacing: 0.8rem; /*段间距*/
    --text-size: 12px;
}/*
 * MIT License
 *
 * Copyright (c) 2023 劉強東 https://github.com/liangjingkanji
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
@import url();
@include-when-export url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap');

:root {
    --text-color: #202124;
    --blur-text-color: #c8c8c8;
    --bg-color: #ffffff;
    --control-text-color: var(--text-color);
    --meta-content-color: var(--text-color);
    --active-file-border-color: var(--drake-accent);
    --rawblock-edit-panel-bd: var(--code-block-bg-color);
    --item-hover-bg-color: #E5E5E596;
    --active-file-bg-color: var(--item-hover-bg-color);

    --blur-text-color: rgba(32, 33, 36, 0.5);
    --drake-accent: #5784ec;
    --drake-highlight: #3a474e;
    --a-color: #1769e0;
    --variable-color: #d01884;
    --outline-active-color: var(#414040);
    --code-block-bg-color: #f8f9fa;
    --code-block-color: #3a474e;
    --title-color: #202124;
    --blockquote-border-color: #275796;
    --blockquote-color: #275796;
    --blockquote-bg-color: #e5f4fd;
    --strong-color: var(--title-color);
    --h2-underline-color: var(--title-color);
    --horizontal-divider-color: var(--title-color);
    --height-light-color: var(--text-color);
    --height-light-border-color: var(--text-color);
    --yaml-color: #777777;
    --yaml-bg-color: #f7f7f7;
    --footnotes-bg-color: #3c3d3e;
    --footnotes-highlight: #FFD760;
    --table-border-color: #dadce0;
    --table-header-bg-color: #f1f3f4;
    --table-bg-color: var(--bg-color);
    --table-n2-bg-color: var(--bg-color);
    --input-bg-color: var(--item-hover-bg-color);
    --btn-hover-bg-color: var(--item-hover-bg-color);
    --checkbox-checked: url("data:image/svg+xml,%3Csvg class='icon' viewBox='0 0 1024 1024' xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cpath d='M425.984 726.016l384-384-59.99-61.995-324.01 324.011-152.021-152.021L213.973 512zm384-598.016q36.01 0 61.013 25.984T896 213.974v596.01q0 34.005-25.003 59.99t-61.013 25.983h-596.01q-36.011 0-61.014-25.984t-25.003-59.989v-596.01q0-34.006 25.003-59.99T213.973 128h596.011z' fill='%2365b73b'/%3E%3C/svg%3E");
    --checkbox-unchecked: url("data:image/svg+xml,%3Csvg class='icon' viewBox='0 0 1024 1024' xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cpath d='M810.667 213.333v597.334H213.333V213.333h597.334m0-85.333H213.333C166.4 128 128 166.4 128 213.333v597.334C128 857.6 166.4 896 213.333 896h597.334C857.6 896 896 857.6 896 810.667V213.333C896 166.4 857.6 128 810.667 128z' fill='%23333333'/%3E%3C/svg%3E");
}

html {
    font-size: var(--text-size);
}

body {
    font-family: var(--text-font) !important;
    color: var(--text-color);
    -webkit-font-feature-settings: "liga" on, "calt" on;
    -webkit-font-smoothing: subpixel-antialiased;
    text-rendering: optimizeLegibility;
    letter-spacing: 0;
    margin: 0;
    overflow-x: hidden;
}

p {
    line-height: var(--text-line-height);
}

/*code block*/
.md-fences {
    font-size: 1rem;
    padding: 12px !important;
    border-radius: 8px;
    word-wrap: normal;
    background-color: var(--code-block-bg-color);
    color: var(--code-block-color);
    border: .1em solid #e8eaed;
    line-height: var(--code-line-height);
}

/*inline latex*/
.MathJax {
    font-size: 120% !important;
}
.MathJax text, .MathJax use {
    font-family: var(--latex-font);
}
/*math-block latex*/
.md-math-block .MathJax {
    font-size: 130% !important;
}

/*mermaid*/
[id^=mermaidChart] .cluster rect {
    fill: var(--table-n2-bg-color) !important;
    stroke: var(--table-border-color) !important;
}
[id^=mermaidChart] .clusters span.nodeLabel {
    color: var(--text-color) !important;
    line-height: 1.8rem;
}
[mermaid-type="journey"] line {
    stroke: #7a7a7a !important;
}
[mermaid-type="journey"] .label {
    color: #333 !important;
}
[id^=mermaidChart] .relationshipLabelBox {
    fill: var(--bg-color) !important;
    opacity: 1 !important;
    background-color: var(--bg-color) !important;
}
[id^=mermaidChart] .legend {
    fill: var(--text-color) !important;
}
[id^=mermaidChart] g.label {
    font-size: 1rem !important;
}
[id^=mermaidChart] line.divider {
    stroke: var(--table-border-color) !important;
}
[id^=mermaidChart] span.nodeLabel {
    color: var(--code-block-color) !important;
    line-height: 1.8rem;
}
tspan {
    color: var(--text-color)
}
[id^=mermaidChart] .entityLabel {
    fill: var(--code-block-color) !important;
}
[id^=mermaidChart] {
    fill: var(--text-color) !important;
}
[id^=mermaidChart] rect.rect {
    fill: rgba(175, 255, 212, 0.3) !important;
}
.md-diagram-panel-preview text.actor > tspan { /*方块文字*/
    fill: var(--code-block-color) !important;
    stroke: none !important;
    font-family: var(--text-font) !important;
    font-size: 1rem !important;
}
.md-diagram-panel-preview .actor, .md-diagram-panel-preview .entityBox { /*方块*/
    stroke: var(--table-border-color) !important;
    fill: var(--code-block-bg-color) !important;
}
.md-diagram-panel-preview .actor-line { /*竖线*/
    stroke: var(--text-color) !important;
    stroke-width: 1px;
}
.md-diagram-panel-preview .messageLine0 { /*横线*/
    stroke-width: 1.5;
    stroke-dasharray: none;
    stroke: var(--text-color) !important;
}
.md-diagram-panel-preview .messageLine1 { /*虚线*/
    stroke-width: 1.5 !important;
    stroke-dasharray: 2, 2 !important;
    stroke: var(--text-color) !important;
}
.md-diagram-panel-preview .messageText { /*描述文字*/
    fill: var(--text-color) !important;
    font-family: var(--text-font) !important;
    font-size: 1rem !important;
}
.md-diagram-panel-preview .activation0 { /*长方形*/
    fill: #e6e6e6 !important;
    stroke: var(--text-color) !important;
}
.md-diagram-panel-preview .labelText, .md-diagram-panel-preview .labelText > tspan { /*循环标记*/
    fill: var(--code-block-color) !important;
    font-family: var(--text-font) !important;
    font-size: 1rem !important;
    dominant-baseline: unset;
    alignment-baseline: unset;
}
.md-diagram-panel-preview .labelBox { /*循环标记背景*/
    stroke: var(--table-border-color) !important;
    fill: var(--code-block-bg-color) !important;
}
.md-diagram-panel-preview .loopLine { /*循环标记虚线*/
    stroke: var(--text-color) !important;
}
.md-diagram-panel-preview .loopText, .md-diagram-panel-preview .loopText > tspan { /*循环名称*/
    fill: var(--text-color) !important;
    font-size: 1rem !important;
}
.md-diagram-panel-preview .sequenceNumber { /*序号*/
    fill: var(--bg-color) !important;
}
pre.md-fences-advanced.md-focus .md-fences-adv-panel {
    border: none;
}
.md-diagram-panel-preview .edgePath .path { /*箭头*/
    stroke: var(--text-color) !important;
}
.md-diagram-panel-preview .edgeLabel rect { /*条件文字背景*/
    fill: var(--bg-color) !important;
}
.md-diagram-panel-preview .edgeLabel span { /*条件文字*/
    color: var(--text-color) !important;
    background: var(--bg-color) !important;
}
.md-diagram-panel-preview .node rect,
.md-diagram-panel-preview .node circle,
.md-diagram-panel-preview .node ellipse,
.md-diagram-panel-preview .node polygon,
.md-diagram-panel-preview .node path { /*形状*/
    stroke: var(--table-border-color) !important;
    fill: var(--code-block-bg-color) !important;
}
#write .md-diagram-panel .md-diagram-panel-preview div { /*形状内文字*/
    color: var(--code-block-color);
    font-family: var(--text-font) !important;
    font-size: 1rem !important;
}

/*code snippet*/
#write code, tt {
    margin: 0 4px;
    color: var(--drake-highlight);
    border: .1rem solid #e8eaed;
    background: #f8f9fa;
    border-radius: 4px;
    padding: .1rem .4rem;
}

/*variable*/
var {
    color: var(--variable-color);
    font-weight: bold;
}

/*raw block*/
.md-rawblock-control:not(.md-rawblock-tooltip) {
    border-radius: 2px 0 2px 2px;
    padding: 0.2rem !important;
}
.md-rawblock:hover > .md-rawblock-container {
    background: none;
}
.md-rawblock-input {
    font-size: 1rem;
}
.md-rawblock-tooltip-btn:hover {
    background: none;
}
.md-rawblock:hover > .md-rawblock-tooltip {
    border-radius: 2px 2px 0 0;
    margin-bottom: 2px !important;
}
.md-rawblock-tooltip.md-rawblock-control {
    border-radius: 2px 2px 0 0;
    color: var(--code-block-color);
}
.md-rawblock-tooltip-name {
    color: var(--code-block-color);
    opacity: 1;
}

/*quote block*/
blockquote {
    color: var(--blockquote-color) !important;
    border-radius: 4px;
    padding: 10px 16px;
    background-color: var(--blockquote-bg-color);
    position: relative;
    border-left: none;
}

#write strong {
    color: var(--strong-color);
    font-weight: bold;
}
#write blockquote strong {
    color: var(--blockquote-color);
}

/*link*/
.on-focus-mode #write a .md-plain:hover, .on-focus-mode .md-htmlblock-container a:hover {
    border-bottom: .1rem solid var(--blur-text-color);
}
#write a .md-plain:hover, .md-htmlblock-container a:hover,
.on-focus-mode #write .md-focus a .md-plain:hover, .on-focus-mode .md-focus .md-htmlblock-container a:hover {
    border-bottom: .1rem solid var(--a-color);
}
#write a {
    color: var(--a-color);
    text-decoration: none;
}
#write h2 a .md-plain {
    border-bottom: .2rem solid var(--a-color);
}
[md-inline=link] a {
    margin: 0 .2rem;
}
#write a code, a:any-link {
    color: var(--a-color);
}
#write a code:hover {
    text-decoration: underline;
    text-underline-offset: 2px;
    text-decoration-thickness: 0.1em;
}

img {
    border-left: none;
    border-right: none;
    vertical-align: baseline;
    border-radius: 2px;
}

#write {
    max-width: 1100px;
    margin: 0 auto;
    padding: 20px 30px 100px;
}
#typora-source .CodeMirror-lines {
    max-width: 1200px;
}

#write > ul:first-child,
#write > ol:first-child {
    margin-top: 30px;
}

body > *:first-child {
    margin-top: 0 !important;
}

body > *:last-child {
    margin-bottom: 0 !important;
}

h1,
h2,
h3,
h4,
h5,
h6 {
    font-family: var(--title-font);
    position: relative;
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-weight: bold;
    line-height: 1.4;
    cursor: text;
    color: var(--title-color);
}

h3.md-focus:before, h4.md-focus:before, h5.md-focus:before, h6.md-focus:before {
    visibility: hidden;
}

h1 {
    font-size: 2rem;
    text-align: center;
    margin-top: 0;
}

h2 {
    font-size: 1.8rem;
    margin-bottom: 1.5rem;
}

.on-focus-mode h2.md-end-block.md-heading:not(.md-focus):not(.md-focus-container):after {
    background-color: var(--blur-text-color) !important;
}

h3 {
    font-size: 1.4rem;
}

h4 {
    font-size: 1.2rem;
}

h5 {
    font-size: 1rem;
}

h6 {
    font-size: 1rem;
}

h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}

h1 tt,
h1 code {
    font-size: inherit !important;
}

h2 tt,
h2 code {
    font-size: inherit !important;
}

h3 tt,
h3 code {
    font-size: inherit !important;
}

h4 tt,
h4 code {
    font-size: inherit !important;
}

h5 tt,
h5 code {
    font-size: inherit !important;
}

h6 tt,
h6 code {
    font-size: inherit !important;
}

p, blockquote, ul, ol, dl, table {
    margin: var(--p-spacing) 0;
}

li > ol,
li > ul {
    margin: 0 0;
}
li {
    margin: 0.5em 0;
}

hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: var(--horizontal-divider-color);
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

body > h2:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child {
    margin-top: 0;
    padding-top: 0;
}

body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0;
}

body > h3:first-child,
body > h4:first-child,
body > h5:first-child,
body > h6:first-child {
    margin-top: 0;
    padding-top: 0;
}

a:first-child h1,
a:first-child h2,
a:first-child h3,
a:first-child h4,
a:first-child h5,
a:first-child h6 {
    margin-top: 0;
    padding-top: 0;
}

h1 p,
h2 p,
h3 p,
h4 p,
h5 p,
h6 p {
    margin-top: 0;
}

li p.first {
    display: inline-block;
}

ul, ol {
    padding-inline-start: 2em;
}

ul:first-child,
ol:first-child {
    margin-top: 0;
}

ul:last-child,
ol:last-child {
    margin-bottom: 0;
}

.ty-table-edit {
    margin-top: -1rem !important;
}
#write table {
    margin-top: 1rem;
    word-break: initial;
    background-color: var(--table-bg-color);
}
table tr {
    border-top: .1em solid var(--table-border-color);
    margin: 0;
    padding: 0;
}
table th {
    font-weight: bold;
    border: .1em solid var(--table-border-color);
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}
table td {
    border: .1em solid var(--table-border-color);
    margin: 0;
    padding: 6px 13px;
}
table thead {
    background-color: var(--table-header-bg-color);
}
table tr:nth-child(2n) {
    background-color: var(--table-n2-bg-color);
}
table tr th:first-child,
table tr td:first-child {
    margin-top: 0;
}
table tr th:last-child,
table tr td:last-child {
    margin-bottom: 0;
}

#write em {
    padding: 0 5px 0 2px;
}

#write table thead th {
    background-color: var(--table-header-bg-color);
}

/* height light */
#write mark {
    border: .1em solid var(--height-light-border-color);
    color: var(--height-light-color);
    background-color: transparent;
    padding: .1rem .5rem;
    border-radius: 2rem;
    margin: 0 .2rem;
    font-size: .95rem;
}

/*shortcut*/
kbd {
    border: .1em solid #5b5b5e;
    background: transparent;
    color: var(--text-color);
    margin: 0 .4rem;
    font-family: var(--text-font) !important;
    font-size: .95rem;
    padding: .3em .4em;
    border-radius: .4em;
    box-shadow: .1em .1em .2em rgba(0, 0, 0, 0.3);
}

#write del {
    padding: 1px 2px;
}

.md-task-list-item > input {
    margin-left: -1.3em;
}

@media print {
    html {
        font-size: 12px;
    }

    table,
    pre {
        page-break-inside: avoid;
    }

    pre {
        word-wrap: break-word;
    }
}

/*YAML*/
#write pre.md-meta-block {
    padding: 1rem;
    font-size: 1rem;
    line-height: 1.45;
    background-color: var(--yaml-bg-color);
    border: 0;
    border-radius: 2px;
    color: var(--yaml-color);
    margin-top: 0 !important;
}

.mathjax-block > .code-tooltip {
    bottom: .375rem;
}

#write > h3.md-focus:before {
    left: -1.5625rem;
    top: .375rem;
}

#write > h4.md-focus:before {
    left: -1.5625rem;
    top: .285714286rem;
}

#write > h5.md-focus:before {
    left: -1.5625rem;
    top: .285714286rem;
}

#write > h6.md-focus:before {
    left: -1.5625rem;
    top: .285714286rem;
}

.md-image > .md-meta {
    border-radius: 2px;
    font-family: initial;
    padding: 2px 0 0 4px;
    color: inherit;
}

.md-tag {
    color: inherit;
}

.md-toc {
    margin-top: 20px;
    padding-bottom: 20px;
}

.typora-quick-open-item {
    font-size: 1rem !important;
    height: 50px;
    padding-left: 8px;
    padding-top: 4px;
    padding-bottom: 4px;
}

#typora-quick-open {
    box-shadow: 0 0 8px #00000045;
    padding: 0;
}

.ty-quick-open-category.ty-has-prev .ty-quick-open-category-title {
    border-top: none;
}

#typora-quick-open-input {
    margin: 8px;
    box-shadow: none;
    border-radius: 2px;
}

#typora-quick-open-input input {
    font-size: 1rem;
    box-shadow: none;
    padding-top: 2px;
    padding-left: 10px;
    padding-right: 10px;
    line-height: 32px;
    max-height: 32px;
    border: none;
}

.modal-dialog#typora-quick-open {
    border-radius: 8px;
}

.ty-quick-open-category-title {
    padding-left: 8px;
    color: #BEBEBE;
    font-size: 0.8rem;
    margin-bottom: 4px;
}

.typora-quick-open-item-path {
    font-size: 0.8rem;
    text-overflow: ellipsis;
    white-space: nowrap;
    margin-top: 1px;
}

/*search input*/
.form-control {
    border: none;
    border-radius: 2px;
    box-shadow: none;
}

#md-searchpanel .btn {
    border-radius: 2px;
}

#search-panel-replaceall-btn {
    padding-right: 5px !important;
    text-align: center !important;
}

#search-panel-replace-btn {
    text-align: center !important;
}

#md-searchpanel input {
    background: var(--input-bg-color);
    border-radius: 2px;
}

.searchpanel-search-option-btn {
    border-radius: 2px;
    border: none;
    background: transparent;
    color: var(--text-color);
}

.searchpanel-search-option-btn.active {
    background: var(--text-color);
    color: var(--bg-color);
}

.form-control:focus {
    box-shadow: none;
}

#md-notification:before {
    top: 10px;
}

/** focus mode */
.on-focus-mode blockquote {
    border-left-color: rgba(85, 85, 85, 0.12);
}

header,
.context-menu,
.megamenu-content,
footer {
    font-family: initial;
}

/*sidebar*/
.file-library-node.file-tree-node.file-node-root {
    font-size: 1.1rem;
}
.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state {
    visibility: visible;
}
.file-node-content {
    display: flex;
    align-items: center;
}
.file-node-open-state {
    margin-right: .5rem;
}
.file-node-icon {
    margin-right: .5rem;
}

#typora-sidebar {
    font-size: inherit;
    font-family: var(--title-font);
}

.sidebar-tabs {
    border-bottom: none;
}

.file-list-item-summary, .file-list-item-parent-loc, .file-list-item-time, .file-list-item-summary {
    font-size: 0.9rem !important;
    font-family: var(--text-font);
}

.file-list-item-file-ext-part {
    display: none;
}

.outline-item {
    font-size: 14px;
}

/*footnotes mark*/
#write .md-footnote {
    background-color: inherit;
    color: var(--drake-highlight);
    font-size: 0.9rem;
    border-radius: 0.9rem;
    padding-left: 0;
}

#write .md-footnote:before {
    content: "[";
}

#write .md-footnote:after {
    content: "]";
}

/*footnotes content*/
.md-hover-tip .code-tooltip-content {
    border-radius: 2px;
}

/*footnotes title*/
span.md-def-name {
    padding-right: 3ch;
    padding-left: 0;
    position: relative;
    font-weight: normal;
}

/*footnotes desc*/
.footnotes {
    font-size: 1rem;
    font-weight: normal;
    color: var(--text-color);
    position: relative;
}

/*footnotes tooltip text*/
.code-tooltip-content .md-plain {
    font-size: 0.9rem;
    font-family: inherit;
}

.code-tooltip-content code {
    padding: 0 2px;
    font-family: inherit;
    color: var(--footnotes-highlight);
    background-color: inherit;
}

.code-tooltip-content a {
    color: var(--footnotes-highlight);
}

div.code-tooltip-content {
    box-shadow: 0 0 8px #00000045;
    background: var(--footnotes-bg-color);
}

.footnotes {
    opacity: 1;
}

.md-def-name:after {
    content: ". ^";
    color: var(--text-color);
}

.md-def-footnote .md-def-name:before {
    content: "";
    color: var(--text-color);
    position: absolute;
}

.md-def-name:before {
    content: "";
    color: var(--text-color);
    position: absolute;
}

.md-content.md-url, .md-def-content.md-def-url.md-auto-disp {
    text-decoration: none;
    border-bottom: .1rem solid var(--text-color);
}

.CodeMirror-scroll::-webkit-scrollbar {
    display: none;
}

.file-list-item-summary {
    font-size: 1em;
}

.pin-outline #outline-content .outline-active strong, .pin-outline .outline-active {
    font-weight: 400;
    color: var(--outline-active-color);
}

.file-list-item.active {
    border-left: 4px solid var(--drake-accent);
}

#md-searchpanel .btn:not(.close-btn):hover {
    box-shadow: none;
    background: var(--btn-hover-bg-color);
}

/*checkbox*/
#write input[type=checkbox] {
    opacity: 0;
    height: 1.6rem;
    width: 1.6rem;
    margin-left: -2em;
    margin-top: 0;
    top: 0;
}

#write .ul-list li.md-task-list-item.task-list-done::before {
    content: "";
    background: var(--checkbox-checked) 0 0 no-repeat;
    background-size: 100%;
    display: inline-block;
    position: absolute;
    height: 1.6rem;
    width: 1.6rem;
    margin-left: -2em;
}
#write .ul-list li.md-task-list-item.task-list-not-done::before {
    content: "";
    background: var(--checkbox-unchecked) 0 0 no-repeat;
    background-size: 100%;
    display: inline-block;
    position: absolute;
    height: 1.6rem;
    width: 1.6rem;
    margin-left: -2em;
}
.task-list-item p {
    line-height: 1.6rem;
}

/*insert table*/
.btn {
    border-radius: 2px;
}

.modal-content {
    border-radius: 8px;
}

.btn-primary:hover, .btn-primary:active {
    background-color: var(--btn-hover-bg-color);
    color: var(--drake-highlight);
}

.btn-primary {
    background-color: transparent;
    color: var(--drake-highlight);
}

.btn-default {
    background-color: transparent;
}

.btn:active {
    box-shadow: none;
    border-color: transparent;
}

.modal-footer {
    border-top: none;
}

#table-insert-col, #table-insert-row {
    background: var(--input-bg-color);
    border-radius: 2px;
}

/*preference panel*/
#megamenu-content {
    background-image: none !important;
    background-color: var(--bg-color);
}
#top-titlebar {
    height: inherit;
    background-color: var(--bg-color);
}
#megamenu-menu-sidebar {
    background-color: var(--bg-color);
    color: var(--text-color);
}
.long-btn {
    width: inherit;
    min-width: 300px;
    border: 1px solid var(--text-color);
    border-radius: 6px;
}
.megamenu-menu-panel h1 {
    margin-bottom: 3rem;
    text-align: left;
}
.megamenu-menu-panel h1, .megamenu-menu-panel h2 {
    font-weight: normal;
}
#recent-file-panel-search-input {
    height: 45px;
    border: none;
    border-bottom: 1px solid var(--text-color);
    padding-left: 8px;
}
#recent-file-panel-search-input::placeholder {
    color: var(--text-color);
    opacity: .5;
}
.megamenu-menu-header {
    border-bottom: none;
}
#recent-file-panel-action-btn {
    background: none;
    border: none;
}
#recent-file-panel-action-btn-container {
    float: none;
    display: inline-block;
}
#top-titlebar .toolbar-icon.btn.hover, #top-titlebar .toolbar-icon.btn:hover {
    background-color: var(--btn-hover-bg-color);
    color: var(--text-color);
}
.megamenu-menu-panel .btn:hover {
    background-color: var(--btn-hover-bg-color) !important;
    color: var(--text-color);
}
#recent-file-panel tbody tr:nth-child(2n-1),
.megamenu-menu-panel table thead,
.megamenu-menu-panel table tr {
    background-color: transparent;
}
.megamenu-menu-panel table {
    font-weight: normal;
}
#megamenu-back-btn {
    color: var(--text-color);
    border: 1px solid var(--text-color);
}
.megamenu-menu-header #megamenu-menu-header-title {
    color: var(--text-color);
}
header, .context-menu, .megamenu-content, footer {
    font-family: var(--text-font);
}
.ty-preferences select {
    padding-left: 2px;
}
.preference-item-hint {
    font-size: 14px;
}
a.ty-link {
    color: var(--a-color);
    margin: 0 .2rem;
}

/**
    code render
    Name: IntelliJ IDEA light theme
    From IntelliJ IDEA by JetBrains
 */
.cm-s-inner.CodeMirror {
    background: none;
    color: var(--code-block-color);
}
.cm-s-inner span.cm-number {
    color: #c5221f;
}
.cm-s-inner span.cm-atom {
    color: #c5221f;
}
.cm-s-inner span.cm-def {
    color: #00f;
}
.cm-s-inner span.cm-variable {
    color: var(--code-block-color);
}
.cm-s-inner span.cm-variable-2 {
    color: #00627A;
}
.cm-s-inner span.cm-variable-3, .cm-s-inner span.cm-type {
    color: #9334e6;
}
.cm-s-inner span.cm-property {
    color: var(--code-block-color);
}
.cm-s-inner span.cm-keyword {
    color: #1967d2;
}
.cm-s-inner span.cm-operator {
    color: var(--code-block-color);
}
.cm-s-inner span.cm-comment {
    color: #b80672;
}
.cm-s-inner span.cm-string {
    color: #008000;
}
.cm-s-inner span.cm-string-2 {
    color: #008000;
}
.cm-s-inner span.cm-qualifier {
    color: var(--code-block-color);
}
.cm-s-inner span.cm-error {
    color: red;
}
.cm-s-inner span.cm-attribute {
    color: #9334e6;
}
.cm-s-inner span.cm-tag.cm-bracket {
    color: #1967d2;
}
.cm-s-inner span.cm-link {
    color: #4A86E8;
}
.cm-s-inner span.cm-builtin {
    color: var(--code-block-color);
}
.cm-s-inner .cm-meta {
    color: #c5221f;
}
.cm-s-inner .CodeMirror-gutters {
    border-right: 1px solid rgba(120, 120, 120, 0.3);
    background: var(--code-block-bg-color);
}
.cm-s-inner .CodeMirror-linenumber {
    color: #787878;
}
/* 正文标题区: #write */
/* [TOC]目录树区: .md-toc-content */
/* 侧边栏的目录大纲区: .sidebar-content */
 
/** 
 * 说明：
 *     Typora的标题共有6级，从h1到h6。
 *     我个人觉得h1级的标题太大，所以我的标题都是从h2级开始。
 *     个人习惯每篇文章都有一个总标题，有一个目录，所以h2级的标题前两个都不会计数。
 *     一般情况下，我虽然不使用h1级的标题，但是为了以防万一，h1级的标题前两个也都不会计数。
 *     若想启用h1级标题，就取消包含“content: counter(h1) "."”项的注释，然后将包含“content: counter(h2) "."”的项注释掉即可。
 */ 
/** initialize css counter */
#write, .sidebar-content,.md-toc-content{
	/* 设置全局计数器的基准 */
	/* 因为我喜欢从h2级标题用起，所以这里设置为h2 */
    counter-reset: h2
}
 
#write h1, .outline-h1, .md-toc-item.md-toc-h1 {
    counter-reset: h2
}
 
#write h2, .outline-h2, .md-toc-item.md-toc-h2 {
    counter-reset: h3
}
 
#write h3, .outline-h3, .md-toc-item.md-toc-h3 {
    counter-reset: h4
}
 
#write h4, .outline-h4, .md-toc-item.md-toc-h4 {
    counter-reset: h5
}
 
#write h5, .outline-h5, .md-toc-item.md-toc-h5 {
    counter-reset: h6
}
 
/** put counter result into headings */
#write h1:before,
.outline-h1>.outline-item>.outline-label:before,
.md-toc-item.md-toc-h1>.md-toc-inner:before {
    counter-increment: h1;
    content: counter(h1) ". "
}
 
/* 使用h1标题时，去掉前两个h1标题的序号，包括正文标题、目录树和大纲 */
/* nth-of-type中的数字表示获取第几个h1元素，请根据情况自行修改。 */
#write h1:nth-of-type(1):before,
.outline-h1:nth-of-type(1)>.outline-item>.outline-label:before,
.md-toc-item.md-toc-h1:nth-of-type(1)>.md-toc-inner:before,
#write h1:nth-of-type(2):before,
.outline-h1:nth-of-type(2)>.outline-item>.outline-label:before,
.md-toc-item.md-toc-h1:nth-of-type(2)>.md-toc-inner:before{
	counter-reset: h1;
	content: ""
}
 
/*#write h2:before,
.outline-h2>.outline-item>.outline-label:before,
.md-toc-item.md-toc-h2>.md-toc-inner:before {
    counter-increment: h2;
    content: counter(h2) ". "
}*/
 
/* 使用h2标题时，去掉前两个h2标题的序号，包括正文标题、目录树和大纲 */
/* nth-of-type中的数字表示获取第几个h2元素，请根据情况自行修改。 */
#write h2:nth-of-type(1):before,
.outline-h2:nth-of-type(1)>.outline-item>.outline-label:before,
.md-toc-item.md-toc-h2:nth-of-type(1)>.md-toc-inner:before,
#write h2:nth-of-type(2):before,
.outline-h2:nth-of-type(2)>.outline-item>.outline-label:before,
.md-toc-item.md-toc-h2:nth-of-type(2)>.md-toc-inner:before{
	counter-reset: h2;
	content: ""
}
 
#write h3:before,
h3.md-focus.md-heading:before, /** override the default style for focused headings */
.outline-h3>.outline-item>.outline-label:before,
.md-toc-item.md-toc-h3>.md-toc-inner:before {
/*	text-decoration: none;*/
    counter-increment: h3;
    /* content: counter(h1) "." counter(h2) "." counter(h3) ". " */
     content:  counter(h3) ". "
}
 
#write h4:before,
h4.md-focus.md-heading:before,
.outline-h4>.outline-item>.outline-label:before,
.md-toc-item.md-toc-h4>.md-toc-inner:before {
/*	text-decoration: none;*/
    counter-increment: h4;
    /* content: counter(h1) "." counter(h2) "." counter(h3) "." counter(h4) ". " */
    content: counter(h3) "." counter(h4) ". "
}
 
#write h5:before,
h5.md-focus.md-heading:before,
.outline-h5>.outline-item>.outline-label:before,
.md-toc-item.md-toc-h5>.md-toc-inner:before {
/*	text-decoration: none;*/
    counter-increment: h5;
    /* content: counter(h1) "." counter(h2) "." counter(h3) "." counter(h4) "." counter(h5) ". " */
    content: counter(h3) "." counter(h4) "." counter(h5) ". "
}
 
#write h6:before,
h6.md-focus.md-heading:before,
.outline-h6>.outline-item>.outline-label:before,
.md-toc-item.md-toc-h6>.md-toc-inner:before {
/*	text-decoration: none;*/
    counter-increment: h6;
    /* content: counter(h1) "." counter(h2) "." counter(h3) "." counter(h4) "." counter(h5) "." counter(h6) ". " */
    content: counter(h3) "." counter(h4) "." counter(h5) "." counter(h6) ". "
}
 
/** override the default style for focused headings */
#write>h3.md-focus:before,
#write>h4.md-focus:before,
#write>h5.md-focus:before,
#write>h6.md-focus:before,
h3.md-focus:before,
h4.md-focus:before,
h5.md-focus:before,
h6.md-focus:before {
    color: inherit;
    border: inherit;
    border-radius: inherit;
    position: inherit;
    left:initial;
    float: none;
    top:initial;
    font-size: inherit;
    padding-left: inherit;
    padding-right: inherit;
    vertical-align: inherit;
    font-weight: inherit;
    line-height: inherit;
}

mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
  min-height: 1px;
  min-width: 1px;
}

mjx-container[jax="SVG"] > svg a {
  fill: blue;
  stroke: blue;
}

mjx-assistive-mml {
  position: absolute !important;
  top: 0px;
  left: 0px;
  clip: rect(1px, 1px, 1px, 1px);
  padding: 1px 0px 0px 0px !important;
  border: 0px !important;
  display: block !important;
  width: auto !important;
  overflow: hidden !important;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

mjx-assistive-mml[display="block"] {
  width: 100% !important;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][display="true"][width="full"] {
  display: flex;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line], svg[data-table] > g > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame], svg[data-table] > g > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed, svg[data-table] > g > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted, svg[data-table] > g > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > g > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

mjx-container[jax="SVG2"] path[data-c], mjx-container[jax="SVG2"] use[data-c] {
  stroke-width: 3;
}

g[data-mml-node="xypic"] path {
  stroke-width: inherit;
}

.MathJax g[data-mml-node="xypic"] path {
  stroke-width: inherit;
}
mjx-container[jax="SVG"] path[data-c], mjx-container[jax="SVG"] use[data-c] {
							stroke-width: 0;
						} @media print { @page {margin: 0 0 0 0;} body.typora-export {padding-left: 0; padding-right: 0;} #write {padding:0;}}
</style><title>3.2TCP 重传、滑动窗口、流量控制、拥塞控制</title>
</head>
<body class='typora-export typora-export-show-outline typora-export-no-collapse-outline'><div class='typora-export-content'>
<div class="typora-export-sidebar"><div class="outline-content"><li class="outline-item-wrapper outline-h1"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#tcp-重传滑动窗口流量控制拥塞控制">TCP 重传、滑动窗口、流量控制、拥塞控制</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#一重传机制">一、重传机制</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#超时重传">超时重传</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#快速重传">快速重传</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#sack方法">SACK方法</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#duplicate-sack">Duplicate SACK</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#二滑动窗口">二、滑动窗口</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#窗口">窗口</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#二流量控制">二、流量控制</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#操作系统缓冲区与滑动窗口之间的关系">操作系统缓冲区与滑动窗口之间的关系</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#窗口关闭">窗口关闭</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#窗口关闭潜在的危险">窗口关闭潜在的危险</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#糊涂窗口综合征">糊涂窗口综合征</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h2"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#三拥塞控制">三、拥塞控制</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#拥塞控制算法-慢启动">拥塞控制算法-慢启动</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#拥塞控制算法-拥塞避免">拥塞控制算法-拥塞避免</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#拥塞控制算法-拥塞发生">拥塞控制算法-拥塞发生</a></div><ul class="outline-children"><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#超时重传-2">超时重传</a></div><ul class="outline-children"></ul></li><li class="outline-item-wrapper outline-h4"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#快速重传-2">快速重传</a></div><ul class="outline-children"></ul></li></ul></li><li class="outline-item-wrapper outline-h3"><div class="outline-item"><span class="outline-expander"></span><a class="outline-label" href="#快速恢复算法">快速恢复算法</a></div><ul class="outline-children"></ul></li></ul></li></ul></li></div></div><div id='write'  class=''><h1 id='tcp-重传滑动窗口流量控制拥塞控制'><span>TCP 重传、滑动窗口、流量控制、拥塞控制</span></h1><h2 id='一重传机制'><span>一、重传机制</span></h2><p><span>	</span><span>TCP实现可靠传输的方式之一就是通过序列号与确认应答。</span></p><p><span>	</span><span>在TCP中，当发送端的数据到达接收主机时，接收端主机就会返回一个确认应答消息，表示已经收到消息。</span></p><p><img src="assets/238.webp" alt="238" style="zoom:50%;" /></p><p><span>	</span><span>但是在错综复杂的网络中，并不一定能如上图那么顺利正常的传输数据，万一数据在传输过程中丢失了呢？  因此TCP针对数据包丢失的情况 ，会用重传机制来解决。</span></p><p><span>	</span><span>常见的重传机制：</span></p><ul><li><p><span>超时重传。</span></p></li><li><p><span>快速重传。</span></p></li><li><p><span>SACK。</span></p></li><li><p><span>D-SACK。</span></p></li></ul><h3 id='超时重传'><span>超时重传</span></h3><p><span>	</span><span>重传机制的其中一个方式，就是在我们发送数据的时候，设定一个定时器，当超过指定的时间后，没有收到对方的ACK确认应答报文，就会重发数据，也就是我们常说的超时重传。</span></p><p><span>	</span><span>TCP会在一下两种情况会超时重传：</span></p><ul><li><p><span>数据包丢失。</span></p></li><li><p><span>确认应答丢失。</span></p></li></ul><p><img src="assets/239.webp" alt="239" style="zoom:50%;" /></p><p><span>	</span><span>超时时间应该设置多少？</span></p><p><span>	</span><span>RTT：Round-Trip Time 往返时延，如下图所示：</span></p><p><img src="assets/240.webp" alt="240" style="zoom:50%;" /></p><p><span>	</span><span>RTT指的是数据发送时刻到接收到确认的时刻的差值，也就是包的往返时间。</span><span>	</span></p><p><span>	</span><span>超时重传的时间是以RTO（Retrasmission Timeout超市重传时间）表示。</span></p><p><span>	</span><span>假设在重传的情况下 ，超时时间是RTO（较长或较短）时，会发生什么呢 ？</span></p><p><img src="assets/241.webp" alt="241" style="zoom:50%;" /></p><ul><li><p><span>如果超时时间RTO较大，重发就慢 ，丢了老半天才重发，没有效率性能比较差。</span></p></li><li><p><span>当超时是按RTO较小，会导致可能并没有丢就重发，于是重发的就快，会增加网络拥塞，会导致更多的超时。</span></p></li></ul><p><span>	</span><span>精确的测量超时时间RTO的值是非常重要的，这可以让我们重传机制更高效。</span></p><p><span>	</span><span>根据上边的两种情况，我们可以知道，超时重传时间RTO的值应该略大于报文的RTT的值。</span></p><p><img src="assets/242.webp" alt="242" style="zoom:50%;" /></p><p><span>	</span><span>到此可以觉得超时重传时间RTO的值计算，也不是很复杂。</span></p><p><span>	</span><span>好像就是在发送端发送包时记录下t0，然后接收端在把这个ack回来时再记录一个t1，于是RTT = t1 - t0。</span></p><p><span>	</span><span>实际上 报文往返的RTT的值是会经常变化的，因为我们网络也是时长变化的，也就是因为报文往返的RTT的值是经常波动变化的，所以，超时重传时间RTO的值应该是一个动态变化的值。</span></p><p><span>	</span><span>我们来看下Linux是如何计算RTO的值：</span></p><ol start='' ><li><p><span>往返时间，通常需要采用以下两个方式：</span></p><ul><li><p><span>需要TCP通过采用RTT的时间，然后进行加权平均，算出一个平滑RTT的值，而且这个值还是不断变化的，因为网络状态不断变化。</span></p></li><li><p><span>除了采用RTT，还要采样RTT的动态波动范围，这样就可以避免如果RTT有一个大的波动的话，很难被发现。</span></p></li></ul></li></ol><p><span>	</span><span>RFC6289建议使用以下的工时计算RTO：</span></p><p><img src="assets/243.webp" alt="243" style="zoom:50%;" /></p><p><span>	</span><span>其中，SRTT是计算平滑的RTT，DevRTR是计算平滑的RTT与最新的RTT的差距。</span></p><p><span>	</span><span>在Linux下，</span><strong><span>α = 0.125，β = 0.25， μ = 1，∂ = 4</span></strong><span>（通过实验调出来的）。</span></p><p><span>	</span><span>如果超时重发的数据，再次超时的时候，又需要重传的时候，TCP的策略是超时间隔加倍。</span></p><p><span>	</span><span>也就是说每当遇到一次超时重传的时候，都会将下一次的超时重传的时间设置为先值的2倍，2次超时之后说明网络环境差，不宜频繁反复的发送。</span></p><p><span>	</span><span>超时触发重传存在的问题是超时周期可能相对比较长，是不是有更快的方式呢？可以用快速重传机制来解决超时重发的时间等待。</span></p><h3 id='快速重传'><span>快速重传</span></h3><p><span>	</span><span>TCP还有一个快速重传Fast Restransmit）机制，它不以时间为驱动，而是以数据驱动重传。</span></p><p><span>	</span><span>快速重传机制是如何工作的呢？其实很简单，如下图所示：</span></p><p><img src="assets/244.webp" alt="244" style="zoom:50%;" /></p><p><span>如上图所示，发送方发了1，2，3，4，5份数据：</span></p><ul><li><p><span>第一份Seq1先送到了，与实际Ack回2。</span></p></li><li><p><span>结果Seq2因为某些原因没有手打，Seq3到达了，于是还是Ack回2。</span></p></li><li><p><span>后面的Seq4和Seq5都收到了，但还是Ack的2，因为Seq还是没有收到。</span></p></li><li><p><span>发送段收到了三个Ack=2的确认，知道了Ack2没有收到，就会在定时器过期之前，重传丢失的Seq2。</span></p></li><li><p><span>最后，收到了Ack2，此时因为Seq3，Seq4，Seq5都收到了于是直接回Ack回6。</span></p></li></ul><p><span>	</span><span>所以快速重传的工作方式是当收到三个相同的ACK报文的时候，会在定时器过期之前重传丢失的报文段。</span></p><p><span>	</span><span>快速重传机制只解决一个问题，就是超时时间的问题，但是它依然面临着另外的一个问题，就是</span><strong><span>重传的</span></strong></p><p><strong><span>是重传一个还是重传所有</span></strong><span>。</span></p><p><span>	</span><span>举例子来说明，假设发送方发了6个数，编号的顺序是Seq1~Seq6，但是Seq2、Seq3都丢失了，那么接收方在收到Seq4、Seq5、Seq6时，都是回复ACK给发送方，但是发送方并不清楚着连续的ACK是接收方收到的哪个报文而恢复的，那就是选择重传Seq2一个报文，还是重传Seq2之后已发送的所有报文呢？</span></p><ul><li><p><span>如果只选择重传Seq2一个报文，那么重传的效率就太低了，因为对于丢失的Seq3报文，还得后续收到三个重传的ACK3才能触发重传。</span></p></li><li><p><span>如果选择Seq2之后已发送的所有报文，虽然能同时重传已丢失的Seq2和Seq3报文，但是Seq4、Seq5、Seq6的报文已经被接收过了，对于重传Seq4~Seq6这部分数据相当于做了一次无用功。资源浪费。</span></p></li></ul><p><span>	</span><span>可以看到，不管是重传一个报文，还是重传已发送的报文都会存在问题。</span></p><p><span>	</span><span>为了解决不知道该重传哪写TCP报文，于是就有了SACK方法。</span></p><h3 id='sack方法'><span>SACK方法</span></h3><p><span>	</span><span>SACK（Selective Acknowledgment），选择性确认。</span></p><p><span>	</span><span>这种方式需要再TCP头部选项字段中加一个SACK的东西，它可以将已经收到的数据信息发送给发送方，这样发送方就可以知道哪些数据已经收到了， 哪些数据是没有收到，知道了这些素具，就可以只重传丢失的数据。</span></p><p><span>	</span><span>如下图所示，发送方收到了三次同样的ACK确认报文，于是就会触发快速重发机制，通过SACK信息发现只有200~299这段时间丢失，则重发时，就只选择了这个TCP段进行重复。</span></p><p><img src="assets/245.webp" alt="245" style="zoom:50%;" /></p><p><span>	</span></p><p><span>	</span><span>如果支持SACK的话，必须发送和接收双方都要支持，在Linux下，可以通过net.ipv4.tcp_sack参数打开这个功能。（Linux2.4版本后是默认打开的）</span></p><h3 id='duplicate-sack'><span>Duplicate SACK</span></h3><p><span>	</span><span>Duplicate SACK又称D-SACK，主要是使用了SACK来告诉发送方有哪些数据被重复接收了。</span></p><p><span>	</span><span>举个例子，说明D-SACK作用：</span></p><p><strong><span>ACK丢包</span></strong></p><p><img src="assets/246.webp" alt="246" style="zoom:50%;" /></p><ul><li><p><span>接收方发给发送方的两个ACK确认应答都丢失了，所以发送方超时后，重传了第一个数据包（3000~3499）。</span></p></li><li><p><span>于是接收方发现数据是重复收到的，于是回了SACK=3000</span><span>~</span><span>3500，告诉发送方3000</span><span>~</span><span>3500数据已经被接收 了，因为ACK已经到了4000，意味着4000之前的所有数据都收到了，所以这个SACK就代表了D-SACK。</span></p></li><li><p><span>这样发送方知道，数据没有丢失，是接收方的ACK确认报文丢失了。</span></p></li></ul><p><strong><span>网络延时</span></strong><span>	</span></p><p><img src="assets/247.webp" alt="247" style="zoom:50%;" /></p><ul><li><p><span>数据包（1000</span><span>~</span><span>1499）被网络延迟了，导致发送方没有收到ACK1500的确认报文。</span></p></li><li><p><span>而后面的报文达到三个相同的ACK确认报文，就会触发快速重传机制，但是在重传之后，被延迟的数据包（1000</span><span>~</span><span>1499）又到了接收方。</span></p></li><li><p><span>所以接收方回了一个SACK=1000</span><span>~</span><span>1500，因为ACK已经到了3000，所以这个SACK是D-SACK，表示已经收到了重复的包。</span></p></li><li><p><span>这样发送方就知道快速重传机制触发的原因不是发出去的包丢了，也不是因为回应的ACK包丢失了，而是因为网络延迟了。</span></p></li></ul><p><strong><span>D-SACK有几个好处：</span></strong></p><ul><li><p><span>可以让发送方知道，是发出去的包丢了，还是接收方回应的ACK包丢了。</span></p></li><li><p><span>可以知道是不是发送方的数据报被网络延迟了。</span></p></li><li><p><span>可以知道网络中的是不是把发送方的数据报给复制了。</span></p></li></ul><p><span>	</span><span>在Linux下，可以通过net.ipv4.tcp_dsack参数打开这个功能。（Linux2.4版本后是默认打开的）</span></p><h2 id='二滑动窗口'><span>二、滑动窗口</span></h2><h3 id='窗口'><span>窗口</span></h3><p><span>	</span><span>我们都知道TCP是每发送一个数据，都要进行一次确认应答，当上一个数据报收到了应答了，再发送下一个，这个模式有点像我和你面对面聊天，你一句我一句但是这种方式的缺点就是效率比较低。</span></p><p><span>	</span><span>如果你说完一句我在处理其他事情，没有及时回复你，那就需要等我回复之后才会恢复你，很显然效率很低。</span></p><p><img src="assets/248.webp" alt="248" style="zoom:50%;" /></p><p><span>	</span><span>所以，这样传输方式有一个确定就是数据包的往返时间越长，通信的效率就越低。</span></p><p><span>	</span><span>为了解决这个问题，TCP引入了窗口的概念，及时往往返回时间较长的情况下 ，它也不会降低网络通信的效率，那么有了窗口，就可以指定窗口的大小，窗口的大小指的是</span><strong><span>无需等待确认应答，而可以继续发送数据的最大值</span></strong><span>。</span></p><p><span>	</span><span>窗口的实际上是操作系统开辟的一个缓存空间 ，发送方主机在等到确认放返回之前，必须在缓冲区中保留已发送的数据，如果按期收到确认应答，此时数据就可以从缓存区清除。</span></p><p><span>	</span><span>假设窗口的带下位3个TCP段，那么发送方就可以连续发送3个TCP段，并且中途有ACK丢掉。可以通过下一个确认应答进行确认，如下图所示：</span></p><p><img src="assets/249.webp" alt="249" style="zoom:50%;" /></p><p><span>	</span><span>如上图中，ACK600确认报文丢失， 也没有关系，因为可以通过下一个确认应答进行确认，只要发送方收到了ACK700确认应答， 意味着700之前的所有素具都被接收方收到了，这个模式叫做累加确认或者累计应答。</span></p><p><strong><span>窗口大小由哪一方决定</span></strong></p><p><span>	</span><span>TCP头有一个字段叫做Window也就是窗口的大小。</span></p><p><span>	</span><span>这个字段是接收端告诉发送端自己还有多少缓冲区可以接收数据，于是发送端就可以根据这个接收端的处理能力来发送数据，而不会导致接收端处理不过来。</span></p><p><span>	</span><span>所以，通常窗口的大小是由接收方的窗口的大小来决定的。</span></p><p><span>	</span><span>发送方发送的数据大小不能超过接收方的窗口的大小，否则接收方就无法正常接收到数据。</span></p><p><strong><span>发送方的滑动窗口</span></strong></p><p><span>	</span><span>我们先来看下发送方的窗口，下图就是发送方缓存的数据，根据处理的情况可以分为4个部分，其中深蓝色部分是发送窗口，紫色部分是可用窗口。</span></p><p><img src="assets/250.webp" alt="250" style="zoom:50%;" /></p><ul><li><p><span>#1是已经发送并收到ACK确认的数据，1~31字节。</span></p></li><li><p><span>#2是已发送但未收到ACK确认的数据，32~45字节。</span></p></li><li><p><span>#3是未发送但总的大小在接收方处理范围内（接收方还是有空间），46~51字节。</span></p></li><li><p><span>#4是未发送但总的大小超过接收方处理范围（接收方没有空间），52字节以后。</span></p></li></ul><p><span>	</span><span>如下图，当发送方把数据【全部】都发送出去后，可用窗口大小就是0了，表明可用窗口耗尽， 在没收到ACK确认之前是无法继续发送数据了。</span></p><p><img src="assets/251.webp" alt="251" style="zoom:50%;" /></p><p><span>	</span><span>如下图，当收到之前的发送的数据32</span><span>~</span><span>36字节的ACK确认应答后，如果发送窗口的大小没有变化，而滑动往右移动5个字节，因为右5个字节的数据被应答确认，接下来52</span><span>~</span><span>56字节又变成了可用窗口，那么后续页可以发送52</span><span>~</span><span>56这5个字节的数据了。</span></p><p><img src="assets/252.webp" alt="252" style="zoom:50%;" /></p><p><strong><span>程序是如何表示发送方的四个部分呢</span></strong></p><p><span>	</span><span>TCP滑动窗口方案使用三个指针来跟踪四个传输类别每一个类别的字节，其中两个指针式绝对指针（指特定的序列号），一个是相对指针（需要做偏移）。</span></p><p><img src="assets/253.webp" alt="253" style="zoom:50%;" /></p><ul><li><p><span>SND.WND：表示发送窗口的大小，大小由接收方确定。</span></p></li><li><p><span>SND.UNA：（Send Unacknoleged）是一个绝对指针，它指向的是已发送但未收到确认的第一个字节的序列号，也就是#2的第一个字节。</span></p></li><li><p><span>SND.NXT：也是第一个绝对指针，它指向未来发送但可发送范围的第一个字节的序列号，也就是#3的第一个字节。</span></p></li><li><p><span>指向#4的第一个字节是个相对指针，需要SND.UNA指针加上SND.WND大小的偏移量，就可以指#4的第一个字节了。</span></p></li></ul><p><span>	</span><span>那么窗口的大小就可以计算：</span></p><p><span>			</span><mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg xmlns="http://www.w3.org/2000/svg" width="63.895ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 28241.5 1000" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" style="vertical-align: -0.566ex;"><defs><path id="MJX-2-TEX-N-A0" d=""></path><path id="MJX-2-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-2-TEX-I-1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path><path id="MJX-2-TEX-I-1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path><path id="MJX-2-TEX-I-1D437" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path><path id="MJX-2-TEX-N-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path id="MJX-2-TEX-I-1D44A" d="M436 683Q450 683 486 682T553 680Q604 680 638 681T677 682Q695 682 695 674Q695 670 692 659Q687 641 683 639T661 637Q636 636 621 632T600 624T597 615Q597 603 613 377T629 138L631 141Q633 144 637 151T649 170T666 200T690 241T720 295T759 362Q863 546 877 572T892 604Q892 619 873 628T831 637Q817 637 817 647Q817 650 819 660Q823 676 825 679T839 682Q842 682 856 682T895 682T949 681Q1015 681 1034 683Q1048 683 1048 672Q1048 666 1045 655T1038 640T1028 637Q1006 637 988 631T958 617T939 600T927 584L923 578L754 282Q586 -14 585 -15Q579 -22 561 -22Q546 -22 542 -17Q539 -14 523 229T506 480L494 462Q472 425 366 239Q222 -13 220 -15T215 -19Q210 -22 197 -22Q178 -22 176 -15Q176 -12 154 304T131 622Q129 631 121 633T82 637H58Q51 644 51 648Q52 671 64 683H76Q118 680 176 680Q301 680 313 683H323Q329 677 329 674T327 656Q322 641 318 637H297Q236 634 232 620Q262 160 266 136L501 550L499 587Q496 629 489 632Q483 636 447 637Q428 637 422 639T416 648Q416 650 418 660Q419 664 420 669T421 676T424 680T428 682T436 683Z"></path><path id="MJX-2-TEX-N-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path><path id="MJX-2-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-2-TEX-I-1D44B" d="M42 0H40Q26 0 26 11Q26 15 29 27Q33 41 36 43T55 46Q141 49 190 98Q200 108 306 224T411 342Q302 620 297 625Q288 636 234 637H206Q200 643 200 645T202 664Q206 677 212 683H226Q260 681 347 681Q380 681 408 681T453 682T473 682Q490 682 490 671Q490 670 488 658Q484 643 481 640T465 637Q434 634 411 620L488 426L541 485Q646 598 646 610Q646 628 622 635Q617 635 609 637Q594 637 594 648Q594 650 596 664Q600 677 606 683H618Q619 683 643 683T697 681T738 680Q828 680 837 683H845Q852 676 852 672Q850 647 840 637H824Q790 636 763 628T722 611T698 593L687 584Q687 585 592 480L505 384Q505 383 536 304T601 142T638 56Q648 47 699 46Q734 46 734 37Q734 35 732 23Q728 7 725 4T711 1Q708 1 678 1T589 2Q528 2 496 2T461 1Q444 1 444 10Q444 11 446 25Q448 35 450 39T455 44T464 46T480 47T506 54Q523 62 523 64Q522 64 476 181L429 299Q241 95 236 84Q232 76 232 72Q232 53 261 47Q262 47 267 47T273 46Q276 46 277 46T280 45T283 42T284 35Q284 26 282 19Q279 6 276 4T261 1Q258 1 243 1T201 2T142 2Q64 2 42 0Z"></path><path id="MJX-2-TEX-I-1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path><path id="MJX-2-TEX-I-1D448" d="M107 637Q73 637 71 641Q70 643 70 649Q70 673 81 682Q83 683 98 683Q139 681 234 681Q268 681 297 681T342 682T362 682Q378 682 378 672Q378 670 376 658Q371 641 366 638H364Q362 638 359 638T352 638T343 637T334 637Q295 636 284 634T266 623Q265 621 238 518T184 302T154 169Q152 155 152 140Q152 86 183 55T269 24Q336 24 403 69T501 205L552 406Q599 598 599 606Q599 633 535 637Q511 637 511 648Q511 650 513 660Q517 676 519 679T529 683Q532 683 561 682T645 680Q696 680 723 681T752 682Q767 682 767 672Q767 650 759 642Q756 637 737 637Q666 633 648 597Q646 592 598 404Q557 235 548 205Q515 105 433 42T263 -22Q171 -22 116 34T60 167V183Q60 201 115 421Q164 622 164 628Q164 635 107 637Z"></path><path id="MJX-2-TEX-I-1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path><path id="MJX-2-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mtext"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">可</text></g><g data-mml-node="mtext" transform="translate(879.3,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">用</text></g><g data-mml-node="mtext" transform="translate(1758.6,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">窗</text></g><g data-mml-node="mtext" transform="translate(2637.9,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">口</text></g><g data-mml-node="mtext" transform="translate(3517.2,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">的</text></g><g data-mml-node="mtext" transform="translate(4396.5,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">大</text></g><g data-mml-node="mtext" transform="translate(5275.8,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">小</text></g><g data-mml-node="mtext" transform="translate(6155.1,0)"><use data-c="A0" xlink:href="#MJX-2-TEX-N-A0"></use></g><g data-mml-node="mo" transform="translate(6682.9,0)"><use data-c="3D" xlink:href="#MJX-2-TEX-N-3D"></use></g><g data-mml-node="mtext" transform="translate(7738.6,0)"><use data-c="A0" xlink:href="#MJX-2-TEX-N-A0"></use></g><g data-mml-node="mi" transform="translate(7988.6,0)"><use data-c="1D446" xlink:href="#MJX-2-TEX-I-1D446"></use></g><g data-mml-node="mi" transform="translate(8633.6,0)"><use data-c="1D441" xlink:href="#MJX-2-TEX-I-1D441"></use></g><g data-mml-node="mi" transform="translate(9521.6,0)"><use data-c="1D437" xlink:href="#MJX-2-TEX-I-1D437"></use></g><g data-mml-node="mo" transform="translate(10349.6,0)"><use data-c="2E" xlink:href="#MJX-2-TEX-N-2E"></use></g><g data-mml-node="mi" transform="translate(10794.3,0)"><use data-c="1D44A" xlink:href="#MJX-2-TEX-I-1D44A"></use></g><g data-mml-node="mi" transform="translate(11842.3,0)"><use data-c="1D441" xlink:href="#MJX-2-TEX-I-1D441"></use></g><g data-mml-node="mi" transform="translate(12730.3,0)"><use data-c="1D437" xlink:href="#MJX-2-TEX-I-1D437"></use></g><g data-mml-node="mtext" transform="translate(13558.3,0)"><use data-c="A0" xlink:href="#MJX-2-TEX-N-A0"></use></g><g data-mml-node="mo" transform="translate(14030.5,0)"><use data-c="2212" xlink:href="#MJX-2-TEX-N-2212"></use></g><g data-mml-node="mtext" transform="translate(15030.7,0)"><use data-c="A0" xlink:href="#MJX-2-TEX-N-A0"></use></g><g data-mml-node="mo" transform="translate(15280.7,0)"><use data-c="28" xlink:href="#MJX-2-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(15669.7,0)"><use data-c="1D446" xlink:href="#MJX-2-TEX-I-1D446"></use></g><g data-mml-node="mi" transform="translate(16314.7,0)"><use data-c="1D441" xlink:href="#MJX-2-TEX-I-1D441"></use></g><g data-mml-node="mi" transform="translate(17202.7,0)"><use data-c="1D437" xlink:href="#MJX-2-TEX-I-1D437"></use></g><g data-mml-node="mo" transform="translate(18030.7,0)"><use data-c="2E" xlink:href="#MJX-2-TEX-N-2E"></use></g><g data-mml-node="mi" transform="translate(18475.4,0)"><use data-c="1D441" xlink:href="#MJX-2-TEX-I-1D441"></use></g><g data-mml-node="mi" transform="translate(19363.4,0)"><use data-c="1D44B" xlink:href="#MJX-2-TEX-I-1D44B"></use></g><g data-mml-node="mi" transform="translate(20215.4,0)"><use data-c="1D447" xlink:href="#MJX-2-TEX-I-1D447"></use></g><g data-mml-node="mtext" transform="translate(20919.4,0)"><use data-c="A0" xlink:href="#MJX-2-TEX-N-A0"></use></g><g data-mml-node="mo" transform="translate(21391.6,0)"><use data-c="2212" xlink:href="#MJX-2-TEX-N-2212"></use></g><g data-mml-node="mtext" transform="translate(22391.9,0)"><use data-c="A0" xlink:href="#MJX-2-TEX-N-A0"></use></g><g data-mml-node="mi" transform="translate(22641.9,0)"><use data-c="1D446" xlink:href="#MJX-2-TEX-I-1D446"></use></g><g data-mml-node="mi" transform="translate(23286.9,0)"><use data-c="1D441" xlink:href="#MJX-2-TEX-I-1D441"></use></g><g data-mml-node="mi" transform="translate(24174.9,0)"><use data-c="1D437" xlink:href="#MJX-2-TEX-I-1D437"></use></g><g data-mml-node="mo" transform="translate(25002.9,0)"><use data-c="2E" xlink:href="#MJX-2-TEX-N-2E"></use></g><g data-mml-node="mi" transform="translate(25447.5,0)"><use data-c="1D448" xlink:href="#MJX-2-TEX-I-1D448"></use></g><g data-mml-node="mi" transform="translate(26214.5,0)"><use data-c="1D441" xlink:href="#MJX-2-TEX-I-1D441"></use></g><g data-mml-node="mi" transform="translate(27102.5,0)"><use data-c="1D434" xlink:href="#MJX-2-TEX-I-1D434"></use></g><g data-mml-node="mo" transform="translate(27852.5,0)"><use data-c="29" xlink:href="#MJX-2-TEX-N-29"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext>可</mtext><mtext>用</mtext><mtext>窗</mtext><mtext>口</mtext><mtext>的</mtext><mtext>大</mtext><mtext>小</mtext><mtext>&nbsp;</mtext><mo>=</mo><mtext>&nbsp;</mtext><mi>S</mi><mi>N</mi><mi>D</mi><mo>.</mo><mi>W</mi><mi>N</mi><mi>D</mi><mtext>&nbsp;</mtext><mo>−</mo><mtext>&nbsp;</mtext><mo stretchy="false">(</mo><mi>S</mi><mi>N</mi><mi>D</mi><mo>.</mo><mi>N</mi><mi>X</mi><mi>T</mi><mtext>&nbsp;</mtext><mo>−</mo><mtext>&nbsp;</mtext><mi>S</mi><mi>N</mi><mi>D</mi><mo>.</mo><mi>U</mi><mi>N</mi><mi>A</mi><mo stretchy="false">)</mo></math></mjx-assistive-mml></mjx-container><script type="math/tex">可用窗口的大小\ = \ SND.WND \ - \ (SND.NXT\ -\ SND.UNA)</script></p><p><span>	</span></p><p><strong><span>接收方的滑动窗口</span></strong></p><p><span>	</span><span>看下接收方的滑动窗口，相对来说简单点儿，根据处理的情况划分成三个部分：</span></p><ul><li><p><span>#1 + #2是已经成功接收并确认的数据（等待应用进程读取）。</span></p></li><li><p><span>#3是未收到数据单可以接收的数据。</span></p></li><li><p><span>#4未收到的数据并</span><strong><span>不可以</span></strong><span>接收的数据。</span></p></li></ul><p><img src="assets/254.webp" alt="254" style="zoom:50%;" /></p><p><span>其中三个接收部分，使用两个指针进行划分：</span></p><ul><li><p><span>RCV.WND：表示接收窗口的大小它会通告给发送方。</span></p></li><li><p><span>RCV.NXT：是一个指针，它指向期望从发送方发送来的下一个数据字节的序列号，也就是#3的第一个字节。</span></p></li><li><p><span>指向#4的第一个字节，是个相对指针，它需求RCV.NXT指针加上RCV.WND大小的偏移量，就可以指向#4的第一个字节了。</span></p></li></ul><p><strong><span>接收窗口和发送窗口的大小是相等的吗？</span></strong></p><p><span>	</span><span>不完全相等，接收窗口的大小约等于发送窗口的大小的。</span></p><p><span>	</span><span>因为滑动窗口并不是一成不变的，比如当接收方应用进程读取数据的速度非常的快，这样的话接收窗口就可以很快就空缺出来，那么新的接收窗口大小，是通过TCP报文中的Windows字段来告诉发送方，那么这个传输过程是存在时延的，所以接收窗口和发送窗口约等于的关系。</span></p><h2 id='二流量控制'><span>二、流量控制</span></h2><p><span>	</span><span>发送方不能无脑的发送数据给接收方，要考虑到接收方的处理能力。</span><span>	</span></p><p><span>	</span><span>如果一直无脑的发数据给对方，但对方处理不过来，那么就会导致触发重发机制，从而导致网络流量无端的浪费。</span></p><p><span>	</span><span>为了解决这种现象发生，</span><strong><span>TCP提供了一种机制可以让发送方根据接收方的实际接收能力来控制发送的数据量，这就是所谓的流量控制</span></strong><span>。</span></p><p><span>	</span><span>举个例子来说明，假设以下的场景：</span></p><ul><li><p><span>服务端是发送方，客户端是接收方。</span></p></li><li><p><span>假设接收窗口和发送窗口相同，都为200。</span></p></li><li><p><span>假设两个设备在这个传输过程中都保持相同的窗口大小，不受外界影响。</span></p></li></ul><p><img src="assets/255.webp" alt="255" style="zoom:50%;" /></p><p><span>根据上图的流量控制，说明下每个过程：</span></p><ol start='' ><li><p><span>客户端向服务端发送请求数据报文，这里说明下，本次例子是把服务端作为发送方，所以没有画出服务端接收窗口。</span></p></li><li><p><span>收到请求报文后，发送确认报文和80字节的数据，于是可用窗口Usable减少为120字节，同时SND.NXT指针也会向右偏移80字节，指向321，这意味着下次发送数据的时候，序列号是321。</span></p></li><li><p><span>客户端收到80字节数据之后，于是接收窗口往右移动80字节，RCV.NXT也就是执行321，这意味着客户端期望的下一个报文的序列号是321，接着发送确认报文给服务端。</span></p></li><li><p><span>服务端再次发送了120字节给客户段，于是可用窗口耗尽为0，服务端无法再继续发送数据了。</span></p></li><li><p><span>客户端收到120字节的数据后，于是接收窗口往右移动120字节，RCV.NXT也就指向441，接着发送确认报文给服务端。</span></p></li><li><p><span>服务端收到对80字节数据的确认报文后，SND.UNA指针往右哦按以后执行321，于是可用窗口Usable增到到80。</span></p></li><li><p><span>服务单收到对120字节数据的确认报文后，SND.UNA指针往右偏移指向441，于是可用窗口Usable增到到200。</span></p></li><li><p><span>服务单可以继续发送了，于是发送了160字节的数据后，SND.NXT执行601，于是可用窗口Usable减少到40。</span></p></li><li><p><span>客户端收到160字节后，接收窗口往右移动了160字节，RCV.NXT也就是一字型了601，接着发送确认报文给服务端。</span></p></li><li><p><span>服务端收到对160字节数据的确认报文后，发送窗口往右移动了160字节，于是SND.UNA指针偏移了160后指向601，可用窗口Usable也就增大了200。</span></p></li></ol><h3 id='操作系统缓冲区与滑动窗口之间的关系'><span>操作系统缓冲区与滑动窗口之间的关系</span></h3><p><span>	</span><span>前面的流量控制例子，我们嘉定了发送窗口和接收窗口是不变的，但是实际上，发送窗口和接收窗口中所存放的字节数都是放在系统内存缓冲区中的，而操作系统的缓冲区，会被操作系统调整。</span></p><p><span>	</span><span>当应用进程没有办法及时读取缓冲区的内容时，也会对我们的缓冲区造成影响。</span></p><p><span>	</span><strong><span>那操作系统的缓冲区，是如何影响发送窗口和接收窗口呢？</span></strong></p><p><span>	</span><span>在看一个例子，当应用程序没有及时读取缓存时，发送窗口和接收窗口的变化情况。</span></p><p><span>	</span><span>考虑以下的场景：</span></p><ul><li><p><span>客户端作为发送方，服务端作为接收方，发送窗口和接收窗口初始大小为360。</span></p></li><li><p><span>服务端都非常的繁忙，当收到客户端的数据时，应用层不能及时读取数据。</span></p></li></ul><p><img src="assets/256.webp" alt="256" style="zoom:50%;" /></p><p><span>根据上图的流量控制，说明下每个过程：</span></p><ol start='' ><li><p><span>客户端发送了140字节数据后，可用窗口变为220（360-140）。</span></p></li><li><p><span>服务端收到140字节数据，但是服务端非常繁忙，应用进程只读取了40个字节，还有100字节占用着缓冲区，于是接收窗口收缩了260（360-100），最后发送确认信息时，将窗口大小通告给客户端。</span></p></li><li><p><span>客户端收到确认和窗口通告报文后，发送窗口减少为260。</span></p></li><li><p><span>客户端发送180字节数据，此时可用窗口减少到了80。</span></p></li><li><p><span>服务端收到180字节数据，但是应用程序没有读取任何的数据，这180字直接就留在了缓冲区，于是接收窗口收缩到了80（260-180），并在发送确认信息的时候通过窗口大小告诉给客户端。</span></p></li><li><p><span>客户端收到确认和窗口报文后，发送窗口减少为80。</span></p></li><li><p><span>客户端发送80字节数据后，可用窗口耗尽。</span></p></li><li><p><span>服务端收到80字节数据，但是应用程序依然没有读取任何的数据，这80字节留在了缓冲区，于是接收窗口收到了0，并在发送确认信息时，通过窗口大小给客户端。</span></p></li><li><p><span>客户端收到确认和窗口通告报文后，发送窗口减少为0。</span></p></li></ol><p><span>	</span><span>可见最后窗口都收缩为0，也就是发生了窗口关闭，当发送可用窗口变为0时，发送方实际上会定时发送窗口探测报文，以便知道接收方窗口是否发生了变化。</span></p><p>&nbsp;</p><p><span>	</span><span>例子2，当服务端系统资源非常紧张的时候，操作系统可能会直接减少了接收缓存区的大小，这时候应用程序又无法及时读取缓存数据，那么这时候就严重的事情就发生了，会出现数据包丢失的现象。</span></p><p><img src="assets/257.webp" alt="257" style="zoom:50%;" /></p><p><span>过程如下：</span></p><ol start='' ><li><p><span>客户端发送140字节的数据，于是可用窗口减少到了220。</span></p></li><li><p><span>服务端因为现在非常繁忙，操作系统于是就把接收缓存减少了120字节，当收到140字节数据后，又因为应用程序没有读取任何数据，所以140字节留在了缓冲区中，于是接收窗口大小从360收缩成了100，最后发送方确认信息时，通告窗口大小给对方。</span></p></li><li><p><span>此时客户端因为还没有收到服务单的通告窗口报文，所以不知道此时接收窗口收缩成了100，客户端只会看自己的可用窗口还有220，所以客户端就发送了180字节的数据，于是可用窗口减少到40。</span></p></li><li><p><span>服务端收到了180字节数据时，发现数据的大小超过了接收窗口的大小，于是把数据报给丢弃了。</span></p></li><li><p><span>客户端收到第2步时服务端发送的确认报文和通告窗口的报文，尝试减少发送窗口到100，把窗口的右端向左收缩了80，此时可用窗口的大小就会出现诡异的负值。</span></p></li></ol><p><span>	</span><span>所以，如果发生了先减少缓存，再收缩CA混口，就会出现丢包的现象。</span></p><p><span>	</span><span>为了防止这种情况发生，TCP规定是不允许同时减少缓存又收缩窗口的，而是采用先收缩窗口，过段时间再减少缓存，这样就可以避免丢包的情况。</span></p><h3 id='窗口关闭'><span>窗口关闭</span></h3><p><span>	</span><span>我们知道，TCP是通过让接收方指明希望从发送方接收的数据大小（窗口大小）来进行流量控制。</span></p><p><span>	</span><span>如果窗口大小为0时，就会组织发送方给接收传递数据。直到窗口变为非0为止，这就是窗口关闭。</span></p><h4 id='窗口关闭潜在的危险'><span>窗口关闭潜在的危险</span></h4><p><span>	</span><span>接收方向发送方通告窗口大小的时候，是通过ACK报文来通告的。</span></p><p><span>	</span><span>那么，当发生窗口关闭的时候，接收方处理完数据后，会向发送方通告一个窗口非0的ACK报文，如果这个通告窗口的ACK报文在网络中丢失了，那就麻烦大了。</span></p><p><img src="assets/258.webp" alt="258" style="zoom:50%;" /></p><p><span>	</span><span>这就就会导致发送方一直等待接收方的非0窗口通知，接收方一直等待发送方的数据，如果不采取措施的时候就是互相等待的过程就出现了死锁的现象。</span></p><p><span>	</span><strong><span>TCP是如何解决窗口关闭时，潜在的死锁风险呢？</span></strong></p><p><span>	</span><span>为了解决这个问题，TCP每个连接都设置了一个持续定时器，只要TCP连接一方收到对方零窗口通知，就启动持续定时器。</span></p><p><span>	</span><span>如果持续定时器超时，就会发送窗口探测（Window probe）报文，而对方在确认这个探测报文时，给出自己现在接收窗口的大小。</span></p><p><img src="assets/259.webp" alt="259" style="zoom:50%;" /></p><ul><li><p><span>如果接收窗口仍然是0，那么收到这个报文的一方就会重新启动持续计时器。</span></p></li><li><p><span>如果接收窗口不是0，那么死锁的局面就可以被打破。</span></p></li></ul><p><span>	</span><span>窗口探测的次数一般为3次，每次大约是30</span><span>~</span><span>60秒，如果3次过后接收窗口还是0的话，有的TCP实现就会发生RST报文来中断连接。</span></p><h3 id='糊涂窗口综合征'><span>糊涂窗口综合征</span></h3><p><span>	</span><span>如果接收方太忙，来不及取走接收窗口里的数据，那么就会导致发送方的发送窗口越来越小。</span></p><p><span>	</span><span>到最后，如果接收方腾出几个字节告诉发送方现在有几个字节的窗口，而发送方会义无反顾的发送几个字节，这就是糊涂综合征。</span></p><p><span>	</span><span>要知道，我们的TCP+IP头有40个字节，为了传输那几个字节的数据，要搭上这么大的开销，这太不经济了。就好像一个人可以承载50人的大巴车，每次来了一两个人，就直接发车了。要想解决这个问题，必须指定一个规则，大巴车四级包含的数量大于35才能发车。</span></p><p><span>	</span><span>举例子：接收方窗口大小是360字节，但接收方由于某些原因陷入困境，假设接收方的应用层读取的能力如下：</span></p><ul><li><p><span>接收方每接收3个字节，应用程序就只能从缓冲区读取1个字节的数据。</span></p></li><li><p><span>在下一个发送方的TCP段到达之前，应用程序还从缓冲区中去读了40个额外的字节。</span></p></li></ul><p><img src="assets/260.webp" alt="260" style="zoom:50%;" /></p><p><span>	</span><span>每个构成的窗口大小的变化，在途中描述的就已经很清楚了，可以发现窗口不断减少了，并且发送的数据是比较小的。所以，糊涂窗口总和证的现象是可以发出在发送方和接收方：</span></p><ul><li><p><span>接收方可以通告一个小的窗口。</span></p></li><li><p><span>而发送方可以发送小的窗口。</span></p></li></ul><p><span>	</span><span>于是，要解决糊涂窗口综合征，就要同时解决上面两个问题就可以了：</span></p><ul><li><p><span>让接收方不通告小窗口给发送方。</span></p></li><li><p><span>让发送方避免发送小数据。</span></p></li></ul><p><strong><span>让接收方不通告小窗口给发送方</span></strong></p><p><span>	</span><span>接收方的通常的策略，当窗口大小小于min(MSS, 缓存空间/2)，也就是MSS与1/2缓存大小中的最小值时，就会向发送方通告窗口为0，也就阻止了发送方发送数据。</span></p><p><span>	</span><span>等待接收反处理了一些数据之后，窗口大小&gt;=MSS，或者接收方缓存空间有一半可以使用，就可以把窗口打开让发送方发送数据过来。</span></p><p><strong><span>发送方如何避免发送小数据</span></strong></p><p><span>	</span><span>发送方通常的策略，使用Nagle算法，该算法的思路就是延时处理，只有满足下面两个条件中的任意一个体检，才可以发送数据：</span></p><ul><li><p><span>条件1：要等到窗口大小&gt;= MSS并且数据大小 &gt;= MSS。</span></p></li><li><p><span>条件2：收到之前发送数据的ack包。</span></p></li></ul><p><span>	</span><span>只要上面2个条件都不满足，发送方一直在囤积数据，直到满足上面的发送条件、</span></p><p><span>Negle伪代码如下：</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.5px; left: 42px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 38px; margin-bottom: 0px; border-right-width: 0px; min-width: 410.203125px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -38px; width: 38px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span> <span class="cm-variable">有数据发送</span>{</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">2</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">if</span> <span class="cm-variable">可用窗口</span><span class="cm-operator">&gt;=</span> <span class="cm-variable">MSS</span> <span class="cm-variable">and</span> <span class="cm-variable">可发送的数据</span> <span class="cm-operator">&gt;=</span> <span class="cm-variable">MSS</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">3</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">立刻发送MSS大小的数据</span> </span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">4</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }<span class="cm-keyword">else</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">5</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">    <span class="cm-keyword">if</span> <span class="cm-variable">有未确认的数据</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">6</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">      <span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">将水放入缓存等待接收ACK</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">7</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">    } <span class="cm-keyword">else</span> {</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">8</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">       <span class="cm-variable">立刻发送数据</span></span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt" style="left: 0px; width: 29px;">9</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">    }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">10</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre></div><div style="position: relative;"><div class="CodeMirror-gutter-wrapper" style="left: -38px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 29px;">11</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 275px;"></div><div class="CodeMirror-gutters" style="height: 275px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 37px;"></div></div></div></div></pre><p><span>	</span><span>注意，接收方需要满足不通告小窗口给发送方 + 发送方开启Nagle算法，才能避免糊涂窗口综合征。</span></p><p><span>	</span><span>另外，Nagle算法默认是打开的， 如果对于一些需要小数据包交互的场景程序，比如telnet 或 ssh这样的交换比较强的程序，则需要关闭Nagle算法。</span></p><p><span>	</span><span>可以在Socket设置</span><strong><span>TCP_NODELAY</span></strong><span>选项来关闭这个算法（关闭Nagle算法没有全局参数，需要格努自己每个应用自己的特点来关闭的）。</span></p><pre class="md-fences md-end-block md-fences-with-lineno ty-contain-cm modeLoaded" spellcheck="false" lang="c"><div class="CodeMirror cm-s-inner cm-s-null-scroll" lang="c"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 10.5px; left: 33px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 29px; margin-bottom: 0px; border-right-width: 0px; min-width: 736.59375px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><div class="CodeMirror-linenumber CodeMirror-gutter-elt"><div>1</div></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: -29px; width: 29px;"></div><div class="CodeMirror-gutter-wrapper CodeMirror-activeline-gutter" style="left: -29px;"><div class="CodeMirror-linenumber CodeMirror-gutter-elt CodeMirror-linenumber-show" style="left: 0px; width: 20px;">1</div></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">setsockopt</span>(<span class="cm-variable">sock_fd</span>, <span class="cm-variable">IPPROTO_TCP</span>, <span class="cm-variable">TCP_NODELAY</span>, (<span class="cm-variable-3">char</span> <span class="cm-variable-3">*</span>) <span class="cm-operator">&amp;</span><span class="cm-variable">value</span>, <span class="cm-keyword">sizeof</span>(<span class="cm-variable-3">int</span>));</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 25px;"></div><div class="CodeMirror-gutters" style="height: 25px;"><div class="CodeMirror-gutter CodeMirror-linenumbers" style="width: 28px;"></div></div></div></div></pre><h2 id='三拥塞控制'><span>三、拥塞控制</span></h2><p><strong><span>为什么要有拥塞控制呢，不用流量控制呢？</span></strong></p><p><span>	</span><span>前面的流量控制是避免发送方的数据填满接收方的缓存，但是并不知道网络中发生了什么。一般来说，计算机网络处在一个共享的环境，因此也有可能是因为其他主机之间的通信使得网络拥塞。</span></p><p><span>	</span><span>在网络中出现拥堵时，如果继续发送大量数据包，可能会导致数据包时延、丢失等，这时TCP就会重传数据，但是一旦重传就会导致网络负担更重，于是会导致更大的延迟以及丢更多的包，这个情况就会进入恶性循环不断放大。</span></p><p><span>	</span><span>所以TCP不能忽略网络上发生的事情，就设计了一个无私的协议，当网络发送拥塞的时候，降低发送的数据量。 于是就有了拥塞控制，控制的目的就是避免发送方的数据填满了整个网络。</span></p><p><span>	</span><span>为了在发送方调节所有要发送的数据的量，定义了一个叫做拥塞窗口的概念。</span></p><p><strong><span>什么是拥塞窗口？和发送窗口有啥关系？</span></strong></p><p><span>	</span><span>拥塞窗口cwnd是发送方维护的一个的状态变量，它会根据网络的拥塞程度动态的变化的。</span></p><p><span>	</span><span>我们在前面提到了发送窗口swnd和接收窗口rwnd是约等于的关系，那么由于加入了拥塞窗口的概念后，此时发送窗口的值 swnd = min(cwnd, rwnd)也就是拥塞窗口和接收窗口的最小值。</span></p><p><span>	</span><span>拥塞窗口cwnd变化规则：</span></p><ul><li><p><span>只要网络中没有出现拥塞，cwnd就会增大。</span></p></li><li><p><span>但网络中出现了拥塞，cwnd就减少。</span></p></li></ul><p><strong><span>那么怎么知道当前网络是否出现了拥塞呢</span></strong></p><p><span>	</span><span>其实只要发送方没有在规定时间内接收到ACK应答报文，也就是发生了超时重传，就会认为网络出现了拥塞。</span></p><p><strong><span>拥塞控制有哪些算法</span></strong></p><ul><li><p><span>慢启动</span></p></li><li><p><span>拥塞避免</span></p></li><li><p><span>拥塞发生</span></p></li><li><p><span>快速恢复</span></p></li></ul><h3 id='拥塞控制算法-慢启动'><span>拥塞控制算法-慢启动</span></h3><p><span>	</span><span>TCP在刚建立完连接后，首先是有个慢启动的过程，这个慢启动的意思就是一点一点的提高发送数据报的数量，如果一上来就发送大量的额数据，这不是给网络添堵的吗 ？</span></p><p><span>	</span><span>慢启动的算法记住一个规则就行：当发送方每收到一个ACK，拥塞窗口cwnd的大小就会加1。</span></p><p><span>	</span><span>这里假定拥塞窗口cwnd和发送窗口swnd相等，举个例子：</span></p><ul><li><p><span>连接建立完成之后，一开始初始化cwnd=1，表示可以传一个MSS大小的数据。</span></p></li><li><p><span>当收到一个ACK确认应答后，cwnd增加1，于是一次能够发送2个。</span></p></li><li><p><span>当收到2个ACK确认应答后，cwnd增加2，于是就可以比之前多发2个，所以这一次就能够发送4个。</span></p></li><li><p><span>当这4个ACK确认到来的时候，每个确认cwnd增加1，4个确认cwnd增加4，于是就可以比之前多发4个，所以发一次能够发送8个。</span></p></li></ul><p><span>	</span><span>慢启动算法的变化过程如下图所示：</span></p><p><img src="assets/261.webp" alt="261" style="zoom:50%;" /></p><p><span>	</span><span>可以看到慢启动算法，发包的个数是指数型增长的。</span></p><p><span>	</span><strong><span>慢启动涨到啥时候会停止增长？</span></strong></p><p><span>	</span><span>有一个叫慢启动门限ssrthresh（slow start threshold）状态变量。</span></p><ul><li><p><span>当cwnd &lt; sshresh时，使用慢启动算法。</span></p></li><li><p><span>当cwnd &gt;= ssthresh时，就会使用拥塞避免算法。</span></p></li></ul><h3 id='拥塞控制算法-拥塞避免'><span>拥塞控制算法-拥塞避免</span></h3><p><span>	</span><span>当拥塞窗口cwnd超过慢启动门限ssthresh就会进入拥塞避免算法。</span></p><p><span>	</span><span>一般来说，ssthresh的大小是65535字节，那么进入拥塞避免算法后，它的规则是：每当收到一个ACK时，cwnd增加1/cwnd。</span></p><p><span>	</span><span>接上面的慢启动例子，现规定ssthresh为8，当8个ACK应答确认到来的时候，每个确认增加1/8，8个ACK确认cwnd一共增加1，于是这一次能够发送9个MSS大小的数据变成了线性增长。</span></p><p><span>	</span><span>拥塞避免算法的变化过程：</span></p><p><img src="assets/262.webp" alt="262" style="zoom:50%;" /></p><p><span>	</span><span>所以，我们可以发现，拥塞避免算法就是将原本慢启动算法的指数增长变成了线性增长，还是增长阶段，但是增长的速率降低了。</span></p><p><span>	</span><span>就这么一直增长后，网络会慢慢进入拥塞的状态，于是就会出现丢包的现象，这时就需要对丢包的数据包进行重传。</span></p><p><span>	</span><span>当触发了重传机制，也就进入了</span><strong><span>拥塞发生</span></strong><span>。</span></p><h3 id='拥塞控制算法-拥塞发生'><span>拥塞控制算法-拥塞发生</span></h3><p><span>	</span><span>当网络出现拥塞，也就是会发生数据包重传，重传机制主要有2种：</span></p><ul><li><p><span>超时重传</span></p></li><li><p><span>快速重传</span></p></li></ul><p><span>	</span><span>这两种使用的拥塞发送时不同的。</span></p><h4 id='超时重传-2'><span>超时重传</span></h4><p><span>	</span><span>当发生了超时重传，则就会使用拥塞发生算法，这个时候ssthresh和cwnd的值就会发生变化：</span></p><ul><li><p><span>ssthresh设置为cwnd/2。</span></p></li><li><p><span>cwnd重置为1，（回复为cwnd初始值，我们假定cwnd初始值为1）。</span></p></li></ul><p><span>	</span><strong><span>查看系统cwnd初始值方法：</span></strong><span> Linux针对每一个TCP连接的cwnd初始值设置为10，也就是10个MSS，我们可以使用命令ss -nli命令查看每一个TCP连接的cwnd初始值，如下图所示：</span></p><p><img src="assets/263.webp" alt="263" style="zoom:50%;" /></p><p><span>	</span><span>拥塞发生算法的变化如下图所示：</span></p><p><img src="assets/264.webp" alt="264" style="zoom:50%;" /></p><p><span>	</span><span>接着，就是重新开始慢启动，慢启动就会突然减少数据流的，这时一旦超时重传，马上就回到了解放前，但是这种方法太激进了，反应也很强烈，会造成网络卡顿。</span></p><h4 id='快速重传-2'><span>快速重传</span></h4><p><span>	</span><strong><span>发生快速重传的拥塞发生算法</span></strong></p><p><span>	</span><span>还有更好的方式，就是快速重传算法，当接收方丢了一个中间包的时候，发送三次前一个包的ACK，于是发送端就会快速重传，不必等待超时重传。</span></p><p><span>	</span><span>TCP会认为这种情况不严重，因为大部分没丢，只丢了一小部分，则ssthresh和cwnd变化如下：</span></p><ul><li><p><span>cwnd = cwnd / 2，也就是设置为原来的一半。</span></p></li><li><p><span>ssthresh  = cwnd。</span></p></li><li><p><span>进入快速恢复算法。</span></p></li></ul><h3 id='快速恢复算法'><span>快速恢复算法</span></h3><p><span>	</span><span>快速重传和快速恢复算法一般同时使用，快速恢复算法是认为，你还能收到3个重复ACK说明网络没有那么糟糕，所以没必要说明向RTO超时那么强烈。</span></p><p><span>	</span><span>正如前面所说，进入快速恢复之前，cwnd和ssthreash已经被更新了。</span></p><ul><li><p><span>cwnd = cwnd / 2，也就是设置为原来的一半。</span></p></li><li><p><span>ssthresh  = cwnd。</span></p><p><span>然后进入快速恢复算法如下：</span></p></li><li><p><span>拥塞窗口cwnd = ssthresh + 3，（3的意思是说确认有3个数据包被收到了）。</span></p></li><li><p><span>重传丢失的数据包。</span></p></li><li><p><span>如果再收到重复的ACK，那么cwnd增加1。</span></p></li><li><p><span>如果收到新的数据的ACK后，把cwnd设置为第一步中的ssthresh的值，原因就是该ACK确认了新的数据，说明从duplicated ACK时的数据已经收到了，该回复过程已经结束，可以恢复到之前的状态了，也就是再次进入拥塞避免的状态。</span></p></li></ul><p><span>	</span><span>快速恢复算法的变化如下图所示：</span></p><p><img src="assets/265.webp" alt="265" style="zoom:50%;" /></p><p><span>	</span><span>也就是说没有像超时重传一样直接回到解放前，而且是比较高的值，后续呈线性增长。</span></p><p>&nbsp;</p><p>&nbsp;</p><p><span>		</span></p></div></div>

<script>(function (){var e=document.body.parentElement,t=[],n=null,i=document.body.classList.contains("typora-export-collapse-outline"),r=function(e,t,n){document.addEventListener(e,function(e){if(!e.defaultPrevented)for(var i=e.target;i&&i!=this;i=i.parentNode)if(i.matches(t)){!1===n.call(i,e)&&(e.preventDefault(),e.stopPropagation());break}},!1)};function o(){return e.scrollTop}r("click",".outline-expander",function(e){var t=this.closest(".outline-item-wrapper").classList;return t.contains("outline-item-open")?t.remove("outline-item-open"):t.add("outline-item-open"),d(),!1}),r("click",".outline-item",function(e){var t=this.querySelector(".outline-label");if(location.hash="#"+t.getAttribute("href"),i){var n=this.closest(".outline-item-wrapper").classList;n.contains("outline-item-open")||n.add("outline-item-open"),c(),n.add("outline-item-active")}});var a,s,l=function(){var e=o();n=null;for(var i=0;i<t.length&&t[i][1]-e<60;i++)n=t[i]},c=function(){document.querySelectorAll(".outline-item-active").forEach(e=>e.classList.remove("outline-item-active")),document.querySelectorAll(".outline-item-single.outline-item-open").forEach(e=>e.classList.remove("outline-item-open"))},d=function(){if(n){c();var e=document.querySelector('.outline-label[href="#'+(CSS.escape?CSS.escape(n[0]):n[0])+'"]');if(e)if(i){var t=e.closest(".outline-item-open>ul>.outline-item-wrapper");if(t)t.classList.add("outline-item-active");else{for(var r=(e=e.closest(".outline-item-wrapper")).parentElement.closest(".outline-item-wrapper");r;)r=(e=r).parentElement.closest(".outline-item-wrapper");e.classList.add("outline-item-active")}}else e.closest(".outline-item-wrapper").classList.add("outline-item-active")}};window.addEventListener("scroll",function(e){a&&clearTimeout(a),a=setTimeout(function(){l(),d()},300)});var u=function(){s=setTimeout(function(){!function(){t=[];var e=o();document.querySelector("#write").querySelectorAll("h1, h2, h3, h4, h5, h6").forEach(n=>{var i=n.getAttribute("id");t.push([i,e+n.getBoundingClientRect().y])})}(),l(),d()},300)};window.addEventListener("resize",function(e){s&&clearTimeout(s),u()}),u()})();</script></body>
</html>